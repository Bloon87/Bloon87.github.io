<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaos Rush: Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { background:#050112; color:#fff; font-family:'Press Start 2P',cursive; overflow:hidden; touch-action:none; user-select:none; }
        #game-container { position:relative; width:100vw; height:100vh; overflow:hidden; background:#050112; }
        canvas { display:block; image-rendering:crisp-edges; }
        .ui-layer { position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:50; }
        /* Overlay layers that need to cover the logical canvas area only - set by JS */
        .canvas-overlay { position:absolute;pointer-events:none;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:50; }
        .interactive { pointer-events:auto; }
        .menu-card { background:rgba(10,5,25,0.97);border:4px solid #00f2ff;padding:1.5rem;border-radius:12px;text-align:center;max-width:95%;max-height:92vh;overflow-y:auto;box-shadow:0 0 50px rgba(0,242,255,0.2); }
        .char-grid { display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:12px 0; }
        @media(min-width:600px){.char-grid{grid-template-columns:repeat(3,1fr);}}
        .char-btn { background:#1a083d;border:2px solid #4a00e0;padding:10px;border-radius:8px;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:5px; }
        .char-btn:hover { transform:translateY(-4px);border-color:#00f2ff;box-shadow:0 5px 15px rgba(0,242,255,0.4); }
        .char-icon { width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;line-height:1; }
        .xp-bar-container { position:absolute;top:60px;left:50%;transform:translateX(-50%);width:60%;height:12px;background:rgba(255,255,255,0.1);border:2px solid #fff;border-radius:6px;overflow:hidden; }
        #xp-fill { width:0%;height:100%;background:linear-gradient(90deg,#00f2ff,#bc13fe);transition:width 0.3s ease; }
        #ability-btn { position:fixed;bottom:40px;right:40px;width:75px;height:75px;background:rgba(255,0,0,0.3);border:4px solid #ff4d4d;border-radius:50%;pointer-events:auto;display:none;justify-content:center;align-items:center;font-size:20px;color:white;z-index:200; }
        #ability-btn.ready { background:rgba(0,242,255,0.3);border-color:#00f2ff;box-shadow:0 0 20px #00f2ff; }
        #secondary-btn { position:fixed;bottom:125px;right:45px;width:60px;height:60px;background:rgba(255,150,0,0.3);border:3px solid #ff9900;border-radius:50%;pointer-events:auto;display:none;justify-content:center;align-items:center;font-size:16px;color:white;z-index:200; }
        #secondary-btn.ready { background:rgba(255,200,0,0.3);border-color:#ffdd00;box-shadow:0 0 15px #ffdd00; }
        .upgrade-btn { background:#1a083d;border:2px solid #4a00e0;padding:12px;margin:8px 0;width:100%;border-radius:8px;text-align:left;cursor:pointer;pointer-events:auto;transition:transform 0.1s; }
        .upgrade-btn.legendary { border-color:#ffd700;background:#2e2700; }
        .upgrade-btn.rare { border-color:#bc13fe;background:#1e002e; }
        .upgrade-btn:hover { transform:scale(1.02); }
        #mobile-controls { position:fixed;bottom:40px;left:40px;width:130px;height:130px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.2);border-radius:50%;display:none;z-index:200;touch-action:none; }
        #joystick-knob { position:absolute;top:50%;left:50%;width:52px;height:52px;background:radial-gradient(circle at 35% 35%,#44eeff,#00aacc);border:2px solid rgba(255,255,255,0.5);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(0,242,255,0.5); }
        #cooldown-display { position:absolute;bottom:125px;right:130px;text-align:right;font-size:9px;color:#aaa;line-height:1.9; }
        .mobile-active #cooldown-display { right:auto;left:200px;text-align:left; }
        .hidden { display:none !important; }
        #bossBar { position:absolute;top:88px;left:50%;transform:translateX(-50%);width:70%;z-index:60;pointer-events:none; }
        #bossBarFill { height:14px;background:linear-gradient(90deg,#ff6600,#ff0000);border-radius:4px;transition:width 0.2s; }
        #bossBarBg { width:100%;height:14px;background:rgba(0,0,0,0.6);border:2px solid #ff6600;border-radius:4px;overflow:hidden; }
        #mindCtrlHud { position:absolute;bottom:220px;left:50%;transform:translateX(-50%);background:rgba(255,0,255,0.2);border:3px solid #ff00ff;padding:7px 14px;border-radius:8px;font-size:8px;color:#ff00ff;text-align:center;pointer-events:none;z-index:60;white-space:nowrap; }
        #pounceIndicator { position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#ff9900;text-shadow:0 0 10px #ff9900;pointer-events:none;display:none;text-align:center; }
        .pause-btn { display:block;width:100%;padding:10px;margin:6px 0;background:#1a083d;border:2px solid #4a00e0;border-radius:8px;cursor:pointer;pointer-events:auto;font-family:'Press Start 2P',cursive;font-size:11px;color:#fff;transition:all 0.15s; }
        .pause-btn:hover { border-color:#00f2ff;color:#00f2ff;transform:scale(1.03); }
        .pause-btn.danger { border-color:#ff4444;color:#ff9999; }
        .pause-btn.danger:hover { border-color:#ff0000;color:#ff4444; }
        #hud > *:not(#eyeToggle) { transition: opacity 0.6s ease; }
        #hud.hud-hidden > *:not(#eyeToggle) { opacity: 0 !important; pointer-events: none; }
        .kb-row { display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.08);font-size:9px; }
        .kb-key { background:#222;border:1px solid #555;padding:3px 8px;border-radius:4px;color:#00f2ff;font-family:'Press Start 2P',cursive;font-size:8px; }
        .setting-row { display:flex;justify-content:space-between;align-items:center;margin:10px 0;font-size:9px; }
        .toggle-btn { padding:5px 12px;border-radius:6px;cursor:pointer;pointer-events:auto;font-family:'Press Start 2P',cursive;font-size:8px;border:2px solid #4a00e0;background:#1a083d;color:#aaa;transition:all 0.15s; }
        .toggle-btn.active { border-color:#00f2ff;color:#00f2ff;background:rgba(0,242,255,0.1); }
        /* Character info panel */
        .char-info-card { background:#0d0525;border:2px solid #4a00e0;border-radius:8px;padding:10px 12px;text-align:left;transition:border-color 0.2s; }
        .char-info-card:hover { border-color:#00f2ff; }
        .ability-row { display:flex;gap:6px;margin:3px 0;align-items:flex-start; }
        .ability-key { background:#1a083d;border:1px solid #4a00e0;border-radius:4px;padding:2px 6px;font-size:7px;color:#00f2ff;white-space:nowrap;flex-shrink:0; }
        .ability-desc { font-size:7px;color:#bbb;line-height:1.5; }

        /* ‚îÄ‚îÄ LANDSCAPE ENFORCEMENT OVERLAY ‚îÄ‚îÄ */
        #landscapeOverlay {
            display:none;
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:#050112;
            z-index:9999;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            text-align:center;
            padding:2rem;
        }
        #landscapeOverlay .rotate-icon {
            font-size:4rem;
            animation:rotatePhone 1.5s ease-in-out infinite;
            display:block;
            margin-bottom:1.5rem;
        }
        @keyframes rotatePhone {
            0%   { transform:rotate(0deg); }
            40%  { transform:rotate(-90deg); }
            60%  { transform:rotate(-90deg); }
            100% { transform:rotate(0deg); }
        }
        #landscapeOverlay h2 {
            font-size:1rem;
            color:#00f2ff;
            margin-bottom:0.75rem;
            text-shadow:0 0 20px rgba(0,242,255,0.6);
        }
        #landscapeOverlay p {
            font-size:0.55rem;
            color:#888;
            line-height:2;
        }

        /* Mobile MC controls row */
        #mc-controls {
            position:fixed;
            bottom:210px;
            left:50%;
            transform:translateX(-50%);
            display:none;
            gap:10px;
            z-index:200;
            pointer-events:auto;
        }
        .mc-btn {
            width:52px;height:52px;border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-size:11px;color:#fff;font-family:'Press Start 2P',cursive;
            border:3px solid;cursor:pointer;touch-action:none;
        }
    </style>
</head>
<body>
<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- Landscape enforcement overlay (mobile portrait only) -->
    <div id="landscapeOverlay">
        <span class="rotate-icon">üì±</span>
        <h2>ROTATE YOUR DEVICE</h2>
        <p>Please rotate to landscape mode<br>to play Chaos Rush: Evolution</p>
    </div>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <div id="top-stats" class="absolute top-4 left-4 right-4 flex justify-between text-xs sm:text-sm">
            <div>SCORE: <span id="scoreDisplay">0</span></div>
            <div>LVL: <span id="lvlDisplay">1</span></div>
            <div>HP: <span id="hpDisplay"></span></div>
        </div>
        <div class="xp-bar-container"><div id="xp-fill"></div></div>
        <div id="cooldown-display">
            <div>ABILITY [SPC]: <span id="abilityTimer" class="text-white font-bold">READY</span></div>
            <div>SECONDARY [R]: <span id="secondaryTimer" class="text-white font-bold">READY</span></div>
        </div>
        <div id="bossBar" class="hidden">
            <div class="text-center text-[9px] text-orange-400 mb-1" id="bossName">???</div>
            <div id="bossBarBg"><div id="bossBarFill" style="width:100%"></div></div>
        </div>
        <div id="mindCtrlHud" class="hidden">üëπ MIND CONTROL ACTIVE</div>
        <div id="pounceIndicator">üêØ FEASTING...<br>SPC: CANCEL</div>
    <div id="eyeToggle" style="position:absolute;bottom:12px;left:12px;font-size:22px;cursor:pointer;pointer-events:auto;z-index:300;user-select:none;opacity:0.7" onclick="toggleHudVisibility()" title="Toggle HUD">üëÅ</div>
    <div id="bossTimerDisplay" style="position:absolute;bottom:12px;right:12px;font-size:9px;color:#ff9900;pointer-events:none;z-index:60"></div>
    <div id="bossMultDisplay" style="position:absolute;bottom:28px;right:12px;font-size:8px;color:#ff6600;pointer-events:none;z-index:60"></div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="ui-layer interactive">
        <div class="menu-card" style="min-width:340px;max-width:620px">
            <h1 class="text-2xl sm:text-3xl text-[#00f2ff] italic mb-1">CHAOS RUSH</h1>
            <p class="text-[10px] text-gray-400 mb-3">EVOLUTION</p>
            <div class="flex justify-center gap-4 text-[10px] mb-3 text-gray-300">
                <div>HIGH SCORE: <span id="menuHighScore" class="text-yellow-400">0</span></div>
                <div>KILLS: <span id="menuTotalKills" class="text-red-400">0</span></div>
            </div>
            <div class="char-grid" id="charGrid"></div>
            <div class="flex gap-2 justify-center mt-3 flex-wrap">
                <button onclick="showScreen('settingsScreen')" class="pause-btn" style="width:auto;padding:7px 12px;font-size:8px">‚öô SETTINGS</button>
                <button onclick="showScreen('keybindsScreen')" class="pause-btn" style="width:auto;padding:7px 12px;font-size:8px">‚å® KEYBINDS</button>
                <button onclick="showScreen('infoScreen')" class="pause-btn" style="width:auto;padding:7px 12px;font-size:8px">üìñ ABILITIES</button>
                <button onclick="downloadSave()" class="pause-btn" style="width:auto;padding:7px 12px;font-size:8px">üíæ EXPORT</button>
            </div>
        </div>
    </div>

    <!-- Pause Menu -->
    <div id="pauseMenu" class="ui-layer hidden">
        <div class="menu-card interactive" style="min-width:280px">
            <h2 class="text-xl text-[#00f2ff] mb-4">PAUSED</h2>
            <button onclick="resumeGame()" class="pause-btn">‚ñ∂ RESUME</button>
            <button onclick="showScreen('settingsScreen')" class="pause-btn">‚öô SETTINGS</button>
            <button onclick="showScreen('keybindsScreen')" class="pause-btn">‚å® KEYBINDS</button>
            <button onclick="resetGame()" class="pause-btn danger">‚úñ QUIT TO MENU</button>
        </div>
    </div>

    <!-- Settings -->
    <div id="settingsScreen" class="ui-layer hidden">
        <div class="menu-card interactive" style="min-width:320px">
            <h2 class="text-lg text-[#00f2ff] mb-4">‚öô SETTINGS</h2>
            <div class="setting-row"><span>DIFFICULTY</span>
                <div class="flex gap-2">
                    <button class="toggle-btn active" id="diffNormal" onclick="setDifficulty('normal')">NORMAL</button>
                    <button class="toggle-btn" id="diffHard" onclick="setDifficulty('hard')">HARD</button>
                </div>
            </div>
            <div class="setting-row"><span>PARTICLES</span>
                <div class="flex gap-2">
                    <button class="toggle-btn active" id="particlesOn" onclick="setParticles(true)">ON</button>
                    <button class="toggle-btn" id="particlesOff" onclick="setParticles(false)">OFF</button>
                </div>
            </div>
            <div class="setting-row">
                <div>
                    <div>ABILITY TARGET</div>
                    <div style="font-size:7px;color:#666;margin-top:3px">Icicles, Spinbot, Volt Tackle, 360-NoScope</div>
                </div>
                <div class="flex gap-2">
                    <button class="toggle-btn active" id="targetAuto" onclick="setAbilityTarget('auto')" title="Aims at nearest enemy automatically">AUTO</button>
                    <button class="toggle-btn" id="targetManual" onclick="setAbilityTarget('manual')" title="Aims toward your cursor">MANUAL</button>
                </div>
            </div>
            <div class="setting-row">
                <div>
                    <div>SHOOT TARGET</div>
                    <div style="font-size:7px;color:#666;margin-top:3px">Who your auto-fire aims at</div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button class="toggle-btn active" id="shootDefault" onclick="setShootTarget('default')">DEFAULT</button>
                    <button class="toggle-btn" id="shootStrongest" onclick="setShootTarget('strongest')">STRONGEST</button>
                    <button class="toggle-btn" id="shootClosest" onclick="setShootTarget('closest')">CLOSEST</button>
                    <button class="toggle-btn" id="shootManual" onclick="setShootTarget('manual')">MANUAL</button>
                </div>
            </div>
            <div class="setting-row"><span>AUTO-PAUSE ON HIDE</span>
                <div class="flex gap-2">
                    <button class="toggle-btn active" id="autoPauseOn" onclick="setAutoPause(true)">ON</button>
                    <button class="toggle-btn" id="autoPauseOff" onclick="setAutoPause(false)">OFF</button>
                </div>
            </div>
            <button onclick="closeOverlay()" class="pause-btn mt-3">‚Üê BACK</button>
        </div>
    </div>

    <!-- Keybinds -->
    <div id="keybindsScreen" class="ui-layer hidden">
        <div class="menu-card interactive" style="min-width:340px">
            <h2 class="text-lg text-[#00f2ff] mb-4">‚å® KEYBINDS</h2>
            <div class="kb-row"><span>MOVE</span><span class="kb-key">WASD / ARROWS</span></div>
            <div class="kb-row"><span>ABILITY (PRIMARY)</span><span class="kb-key">SPACE</span></div>
            <div class="kb-row"><span>ABILITY (SECONDARY)</span><span class="kb-key">R</span></div>
            <div class="kb-row"><span>PAUSE</span><span class="kb-key">ESC</span></div>
            <div class="kb-row"><span>AIM / WORMHOLE / BEAM</span><span class="kb-key">MOUSE</span></div>
            <div style="margin-top:12px;font-size:8px;color:#555;line-height:2;text-align:left">
                <div style="color:#888;margin-bottom:4px">‚Äî CHARACTER ABILITIES ‚Äî</div>
                <div>üëπ Noglin | SPC:Latch | R:Cuteness | [MC] Q:Special (per host type) | SPC:Delatch | R:Kill Host</div>
                <div>‚ö° Pikachu | SPC:Thunderbolt | R:Volt Tackle</div>
                <div>üêØ Zanther | SPC:Pounce+Feast | R:Sheer Aura</div>
                <div>üê± Vitru | SPC:Glorp Beam | R:Wormhole</div>
                <div>üêï Shiba | SPC:Sad Whimper | R:50 Bucks</div>
                <div>‚òÉÔ∏è Snowman | SPC:Flash Freeze | R:Icicle Barrage</div>
                <div>üòé Coolioioio | SPC:Spinbot | R:360-No-Scope</div>
                <div>üìì Kira | SPC:Death Note | R:Justice Monologue | God Gauge fills on kills ‚Üí SPC becomes instant kill</div>
                <div>üéÄ Femboy | SPC:Slay (Charm) | R:Twirl AOE | Passive aura dazes nearby enemies</div>
                <div>ü•í Pickle | SPC:Brine Burst (Poison) | R:Pickle Dash | Poison stacks and ticks</div>
            </div>
            <button onclick="closeOverlay()" class="pause-btn mt-3">‚Üê BACK</button>
        </div>
    </div>

    <!-- Character Info Screen -->
    <div id="infoScreen" class="ui-layer hidden">
        <div class="menu-card interactive" style="min-width:360px;max-width:680px">
            <h2 class="text-lg text-[#00f2ff] mb-4">üìñ CHARACTER ABILITIES</h2>
            <div style="display:grid;grid-template-columns:1fr;gap:8px" id="infoGrid"></div>
            <button onclick="closeOverlay()" class="pause-btn mt-4">‚Üê BACK</button>
        </div>
    </div>
    <div id="levelUpScreen" class="ui-layer hidden">
        <div class="menu-card interactive" style="min-width:300px">
            <h2 class="text-xl text-yellow-400 mb-4 italic">‚¨Ü LEVEL UP!</h2>
            <div id="upgradeOptions"></div>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen" class="ui-layer hidden">
        <div class="menu-card interactive">
            <h1 class="text-3xl text-red-500 mb-2" id="deathMsg">WASTED</h1>
            <p class="text-xs text-gray-400 mb-3" id="deathSubMsg"></p>
            <p class="mb-4 text-sm">FINAL SCORE: <span id="finalScore">0</span></p>
            <button onclick="resetGame()" class="px-6 py-3 bg-[#00f2ff] text-black font-bold rounded interactive">RETRY</button>
        </div>
    </div>

    <!-- Mobile joystick -->
    <div id="mobile-controls"><div id="joystick-knob"></div></div>

    <!-- Mobile ability buttons -->
    <div id="ability-btn">‚ö°</div>
    <div id="secondary-btn">‚òÖ</div>

    <!-- Mobile MC buttons (shown when mind controlling) -->
    <div id="mc-controls">
        <div class="mc-btn" id="mc-q-btn" style="background:rgba(204,0,255,0.25);border-color:#cc00ff" ontouchstart="triggerMCAbility('q')">Q</div>
        <div class="mc-btn" id="mc-spc-btn" style="background:rgba(255,255,255,0.1);border-color:#aaaaaa" ontouchstart="ejectMindControl()">SPC</div>
        <div class="mc-btn" id="mc-r-btn" style="background:rgba(255,0,0,0.25);border-color:#ff4400" ontouchstart="killMindControlHost()">KILL</div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ MOBILE DETECTION ‚îÄ‚îÄ
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);

// Hide landscape overlay entirely on desktop (it's only for mobile)
if (!isMobile) {
    const lo = document.getElementById('landscapeOverlay');
    if (lo) lo.style.display = 'none';
}

// ‚îÄ‚îÄ LANDSCAPE ENFORCEMENT ‚îÄ‚îÄ
function checkOrientation() {
    if (!isMobile) return;
    const isPortrait = window.innerHeight > window.innerWidth;
    const overlay = document.getElementById('landscapeOverlay');
    overlay.style.display = isPortrait ? 'flex' : 'none';
    // Pause game if portrait
    if (isPortrait && state && state.screen === 'PLAYING') {
        state.screen = 'PAUSED';
        state._pausedByOrientation = true;
    } else if (!isPortrait && state && state._pausedByOrientation && state.screen === 'PAUSED') {
        state.screen = 'PLAYING';
        state._pausedByOrientation = false;
    }
}
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', () => setTimeout(checkOrientation, 200));

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
const SAVE_KEY='chaos_rush_v4_save';
let saveData={highScore:0,totalKills:0};
function loadSave(){try{const s=localStorage.getItem(SAVE_KEY);if(s)saveData=JSON.parse(s);}catch(e){}
    const h=document.getElementById('menuHighScore'),t=document.getElementById('menuTotalKills');
    if(h)h.innerText=saveData.highScore;if(t)t.innerText=saveData.totalKills;}
function saveGame(){try{localStorage.setItem(SAVE_KEY,JSON.stringify(saveData));}catch(e){}}
function downloadSave(){const a=document.createElement('a');a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(saveData));a.download="chaos_save.json";a.click();}

// ‚îÄ‚îÄ ASSETS ‚îÄ‚îÄ
const assets={noglin:new Image(),pikachu:new Image(),coolioso:new Image(),noglinCuteness:new Image(),shibaHomeless:new Image()};
assets.noglin.src='skibidi noglin.png';assets.noglinCuteness.src='noglincuteness.png';assets.shibaHomeless.src='homeless shiba.png';
assets.pikachu.src='pikachu.png';
assets.coolioso.src='coolioso.png';

// ‚îÄ‚îÄ CHARACTERS ‚îÄ‚îÄ
const CHARACTERS=[
    {id:'noglin',    name:"Noglin",       emoji:"üëπ", img:assets.noglin,   speed:9.5, hp:5, abilityColor:'#ff00ff', imgSize:88,
     desc:"Mind Control",   abilityDesc:"SPC: Latch | R: Cuteness | [MC] Q: Special | SPC: Delatch | R: Kill Host"},
    {id:'pikachu',   name:"Pikachu",      emoji:"‚ö°", img:assets.pikachu,  speed:12,  hp:4, abilityColor:'#ffff00',
     desc:"Chain Lightning",abilityDesc:"SPC: Thunderbolt x8 | R: Volt Tackle"},
    {id:'tiger',     name:"Zanther",      emoji:"üêØ", emojiFilter:"hue-rotate(240deg) saturate(2)", speed:7.5, hp:5, abilityColor:'#ff9900',
     desc:"Pounce & Feast", abilityDesc:"SPC: Pounce+Feast | R: Sheer Aura"},
    {id:'cat',       name:"Vitru",        emoji:"üê±", emojiFilter:"hue-rotate(110deg) saturate(3)", speed:9, hp:5, abilityColor:'#00ff88',
     desc:"Glorp Beam",     abilityDesc:"SPC: Glorp Beam | R: Wormhole"},
    {id:'shiba',     name:"Broke Shiba",  emoji:"üêï",  img:assets.shibaHomeless, speed:8, hp:6, abilityColor:'#ffbbbb',
     desc:"Sad Whimper",   abilityDesc:"SPC: Sad Whimper | R: 50 Bucks"},
    {id:'snowman',   name:"Snowman",      emoji:"‚òÉÔ∏è", speed:6,   hp:7, abilityColor:'#88eeff',
     desc:"Flash Freeze",  abilityDesc:"SPC: Flash Freeze | R: Icicle Barrage"},
    {id:'coolioioio',name:"Coolioioio",   emoji:"üòé", img:assets.coolioso, speed:10.5, hp:5, abilityColor:'#ff44ff',
     desc:"Spinbot",       abilityDesc:"SPC: Spinbot 10/s | R: 360-No-Scope"},
    {id:'blahblahblah',name:"BlahBlahBlah", emoji:"üí¨", speed:9, hp:5, abilityColor:'#cc44ff',
     desc:"Anime Nonsense", abilityDesc:"SPC: Word Barrage | R: Ultimate Speech"},
    {id:'pickle',    name:"Pickle",        emoji:"ü•í", speed:9, hp:6, abilityColor:'#44cc00',
     desc:"I'm Pickle Rick!", abilityDesc:"SPC: Brine Burst (Poison) | R: Pickle Dash"},
    {id:'kira',      name:"Kira",         emoji:"üìì", speed:8.5, hp:5, abilityColor:'#cc0000', secret:true,
     desc:"Death Note",   abilityDesc:"SPC: Death Note | R: Justice Monologue"},
    {id:'femboy',    name:"Femboy",        emoji:"üéÄ", speed:11, hp:5, abilityColor:'#ff88cc', secret:true,
     desc:"Girly Pop",    abilityDesc:"SPC: Slay (Charm) | R: Twirl AOE"},
    {id:'subaru',    name:"Subaru",        emoji:"üîÑ", speed:10, hp:4, abilityColor:'#4488ff', secret:true,
     desc:"Return by Death", abilityDesc:"SPC: Return by Death | R: Unseen Hand"},
];

// Weighted upgrade pool
const UPGRADES_POOL=[
    {id:'atk_speed',  name:"Haste",        tiers:[
        {l:"Common",   v:5,  c:"white",   w:60, desc:"Shoot 5 frames faster ‚Äî small but noticeable fire rate boost"},
        {l:"Rare",     v:10, c:"#bc13fe", w:30, desc:"Shoot 10 frames faster ‚Äî meaningful fire rate increase"},
        {l:"Legendary",v:20, c:"#ffd700", w:8,  desc:"Shoot 20 frames faster ‚Äî drastically faster firing"},
    ]},
    {id:'damage',     name:"Caliber",      tiers:[
        {l:"Common",   v:2,  c:"white",   w:60, desc:"+2 damage per bullet ‚Äî each shot hits harder"},
        {l:"Rare",     v:5,  c:"#bc13fe", w:30, desc:"+5 damage per bullet ‚Äî noticeably more punch"},
        {l:"Legendary",v:12, c:"#ffd700", w:6,  desc:"+12 damage per bullet ‚Äî massive damage spike"},
    ]},
    {id:'speed',      name:"Drive",        tiers:[
        {l:"Common",   v:0.5,  c:"white",   w:60, desc:"+0.5 movement speed ‚Äî slightly faster"},
        {l:"Rare",     v:1.2,  c:"#bc13fe", w:30, desc:"+1.2 movement speed ‚Äî noticeably quicker"},
        {l:"Legendary",v:2.5,  c:"#ffd700", w:8,  desc:"+2.5 movement speed ‚Äî zoom across the map"},
    ]},
    {id:'projectiles',name:"Splitter",     tiers:[
        {l:"Rare",     v:1, c:"#bc13fe", w:25, desc:"Fire 1 extra bullet per shot ‚Äî great with damage upgrades"},
        {l:"Legendary",v:2, c:"#ffd700", w:5,  desc:"Fire 2 extra bullets per shot ‚Äî triple the pain"},
    ]},
    {id:'bullet_size',name:"Heavy Rounds", tiers:[
        {l:"Common",   v:2, c:"white",   w:55, desc:"Bullets are 2px bigger ‚Äî larger hitbox, easier to land"},
        {l:"Legendary",v:8, c:"#ffd700", w:7,  desc:"Bullets are 8px bigger ‚Äî massive hitbox, hard to miss"},
    ]},
    {id:'xp_boost',   name:"Wisdom",       tiers:[
        {l:"Common",   v:0.1, c:"white",   w:55, desc:"+10% XP from all sources ‚Äî level up faster"},
        {l:"Rare",     v:0.3, c:"#bc13fe", w:22, desc:"+30% XP from all sources ‚Äî significantly faster levelling"},
    ]},
    {id:'crit',       name:"Lethality",    tiers:[
        {l:"Common",   v:5,  c:"white",   w:60, desc:"+5% crit chance ‚Äî crits deal double damage"},
        {l:"Rare",     v:15, c:"#bc13fe", w:28, desc:"+15% crit chance ‚Äî much more consistent crits"},
        {l:"Legendary",v:40, c:"#ffd700", w:6,  desc:"+40% crit chance ‚Äî nearly half your shots crit"},
    ]},
    {id:'regen',      name:"Regen",        tiers:[
        {l:"Common",   v:0.06, c:"white",   w:45, desc:"Heal 6% of max HP every 5 seconds"},
        {l:"Rare",     v:0.15, c:"#bc13fe", w:20, desc:"Heal 15% of max HP every 5 seconds"},
        {l:"Legendary",v:0.35, c:"#ffd700", w:6,  desc:"Heal 35% of max HP every 5 seconds ‚Äî very strong sustain"},
    ]},
    {id:'max_hp',     name:"Vitality",     tiers:[
        {l:"Common",   v:1, c:"white",   w:40, desc:"+1 max HP ‚Äî also heals 1 HP immediately"},
        {l:"Rare",     v:2, c:"#bc13fe", w:18, desc:"+2 max HP ‚Äî also heals 2 HP immediately"},
        {l:"Legendary",v:4, c:"#ffd700", w:5,  desc:"+4 max HP ‚Äî also heals 4 HP immediately"},
    ]},
    {id:'ability_cd', name:"Readiness",    tiers:[
        {l:"Rare",     v:300, c:"#bc13fe", w:18, desc:"Abilities recharge 5s faster ‚Äî more frequent use"},
        {l:"Legendary",v:500, c:"#ffd700", w:5,  desc:"Abilities recharge 8s faster ‚Äî near-constant abilities"},
    ]},
    {id:'bullet_spd', name:"Velocity",     tiers:[
        {l:"Common",   v:2, c:"white",   w:50, desc:"+20% bullet speed ‚Äî harder for enemies to dodge"},
        {l:"Rare",     v:4, c:"#bc13fe", w:22, desc:"+40% bullet speed ‚Äî bullets reach enemies almost instantly"},
    ]},
];
function pickUpgrade(){
    const base=UPGRADES_POOL[Math.floor(Math.random()*UPGRADES_POOL.length)];
    const total=base.tiers.reduce((s,t)=>s+(t.w||50),0);
    let r=Math.random()*total;
    for(const t of base.tiers){r-=(t.w||50);if(r<=0)return{base,tier:t};}
    return{base,tier:base.tiers[0]};
}

const ENEMY_DEFS=[
    {type:'grunt',   emoji:'üëæ',hpMult:1,   speedMult:1,    weight:35,hasRanged:false,meleeDmg:1,preferDist:0,  shootInterval:0  },
    {type:'shooter', emoji:'üéÉ',hpMult:0.75,speedMult:0.65, weight:25,hasRanged:true, meleeDmg:0,preferDist:280,shootInterval:110},
    {type:'tank',    emoji:'üíÄ',hpMult:4,   speedMult:0.4,  weight:15,hasRanged:false,meleeDmg:2,preferDist:0,  shootInterval:0  },
    {type:'speeder', emoji:'ü¶á',hpMult:0.4, speedMult:2.8,  weight:20,hasRanged:false,meleeDmg:1,preferDist:0,  shootInterval:0  },
    {type:'warlock', emoji:'üßô',hpMult:1.2, speedMult:0.8,  weight:15,hasRanged:true, meleeDmg:0,preferDist:220,shootInterval:70 },
    {type:'brute',   emoji:'üóø',hpMult:2.5, speedMult:0.55, weight:10,hasRanged:false,meleeDmg:2,preferDist:0,  shootInterval:0  },
];
const BOSS_DEFS=[
    {emoji:'üê≤',name:'THE DRAGON',                color:'#ff4400', pattern:'charger', hpMult:1.0},
    {emoji:'ü§ñ',name:'MECHROID PRIME',             color:'#00ffcc', pattern:'turret',  hpMult:1.2},
    {emoji:'ü¶ë',name:'THE KRAKEN',                 color:'#9900ff', pattern:'swirler', hpMult:1.1},
    {emoji:'üë∫',name:'DEMON LORD',                 color:'#ff6600', pattern:'bursty',  hpMult:1.0},
    {emoji:'‚ò†Ô∏è',name:'DEATH ITSELF',               color:'#cccccc', pattern:'ghost',   hpMult:0.8},
    {emoji:'ü¶ñ',name:'GERALD THE DINOSAUR',        color:'#88ff00', pattern:'charger', hpMult:1.3},
    {emoji:'üßü',name:'KEVIN THE UNDEAD',           color:'#44ff88', pattern:'swarm',   hpMult:0.9},
    {emoji:'üëÅÔ∏è',name:'THE ALL-SEEING EYEBALL',    color:'#cc00ff', pattern:'turret',  hpMult:1.1},
    {emoji:'ü¶à',name:'LAND SHARK STEVE',           color:'#0088ff', pattern:'charger', hpMult:1.2},
    {emoji:'üêª',name:'BEARS ATTORNEY',             color:'#ff8844', pattern:'bursty',  hpMult:1.0},
    {emoji:'üåã',name:'MOUNT DOOOOOM',              color:'#ff2200', pattern:'swirler', hpMult:1.4},
    {emoji:'üßä',name:'THE ICE KING (NOT THAT ONE)',color:'#aaeeff', pattern:'ghost',   hpMult:1.0},
    {emoji:'üå™Ô∏è',name:'JUST A REALLY MAD WIND',    color:'#99ccff', pattern:'swirler', hpMult:0.9},
    {emoji:'ü¶¥',name:'SKELETOR JR.',               color:'#ffffcc', pattern:'bursty',  hpMult:0.8},
    {emoji:'üçÑ',name:'SHROOM OF DOOM',             color:'#ff44aa', pattern:'swarm',   hpMult:1.0},
    {emoji:'ü§°',name:'THE LAUGH',                  color:'#ff0044', pattern:'ghost',   hpMult:0.9},
    {emoji:'üß†',name:'THE BIG BRAIN',              color:'#ff88cc', pattern:'turret',  hpMult:1.1},
    {emoji:'üéÉ',name:'HALLOWEEN 365 DAYS A YEAR',  color:'#ff8800', pattern:'swarm',   hpMult:1.0},
    {emoji:'üê∏',name:'FROGZILLA',                  color:'#00ff66', pattern:'charger', hpMult:1.2},
    {emoji:'üåë',name:'THE MOON (ANGRY)',            color:'#888888', pattern:'swirler', hpMult:1.5},
    {emoji:'ü¶¶',name:'OTTERLY UNSTOPPABLE',        color:'#cc8844', pattern:'charger', hpMult:1.1},
    {emoji:'üêô',name:'PROFESSOR TENTACLES',        color:'#8844ff', pattern:'turret',  hpMult:1.3},
    {emoji:'üß®',name:'THE INEVITABLE',             color:'#ff4400', pattern:'bursty',  hpMult:1.2},
    {emoji:'ü¶†',name:'GERM OVERLORD',              color:'#88ff44', pattern:'swarm',   hpMult:1.0},
    {emoji:'ü´Ä',name:'SENTIENT HEART (ESCAPED)',   color:'#ff2244', pattern:'ghost',   hpMult:0.9},
    {emoji:'ü•ä',name:'THE ABSOLUTE UNIT',          color:'#ffaa00', pattern:'charger', hpMult:1.8},
    {emoji:'ü¶Ö',name:'APEX EAGLE SUPREME',         color:'#ffee00', pattern:'swirler', hpMult:1.3},
    {emoji:'üêâ',name:'ULTRA DRAGON DELUXE',        color:'#ff3300', pattern:'turret',  hpMult:1.6},
    {emoji:'üåä',name:'THE TIDE',                   color:'#0044ff', pattern:'swarm',   hpMult:1.2},
    {emoji:'‚ö°',name:'THE STORM ETERNAL',          color:'#ffff00', pattern:'bursty',  hpMult:1.4},
    {emoji:'üî•',name:'INFERNOS HIMSELF',           color:'#ff6600', pattern:'charger', hpMult:1.5},
    {emoji:'üíÄ',name:'DEATH PREMIUM EDITION',      color:'#aaaaaa', pattern:'ghost',   hpMult:2.0},
];

const SHIBA_WHIMPERS=[
    "üò¢ please...","i'm so broke","my paws hurt","just a lil xp","i believe in u","nobody loves me",
    "woof... üíî","look at my eyes","pls im hungry","don't be mean","im just a dog","i tried my best",
];

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let settings={difficulty:1,particles:true,abilityTarget:'auto',shootTarget:'default',autoPauseOnHide:true};

// ‚îÄ‚îÄ FIXED-TIMESTEP CONSTANTS ‚îÄ‚îÄ
// All game logic runs at a fixed 60fps equivalent.
// We accumulate real time and step in 1/60s chunks.
const FIXED_DT = 1000 / 60; // 16.667ms per logic tick
let accumulator = 0;
let lastTimestamp = 0;

let state={
    screen:'MENU',player:null,
    enemies:[],bullets:[],enemyBullets:[],xpOrbs:[],textPopups:[],lightningEffects:[],particles:[],
    lvl:1,xp:0,xpNeeded:100,score:0,frameCount:0,keys:{},
    joystick:{active:false,x:0,y:0},
    ability:{ready:true,cooldown:0,maxCooldown:1200},
    secondary:{ready:true,cooldown:0,maxCooldown:900},
    effects:{timeSlow:false,frozen:false,frozenTimer:0,frozenDamageMult:1,confused:false,confuseTimer:0},
    mindControl:{active:false,host:null,savedHp:0,slamCooldown:0,mcTimer:0},
    bossMultiplier:1.0,
    pounce:{active:false,target:null,timer:0,damage:0,damageTick:0,healTick:0},
    boss:null,bossTimer:2700,
    mouseX:400,mouseY:300,
    glorpBeam:null,
    voltTackle:null,
    cutenessStacks:0,
    spinbot:null,
    mcAbilityCooldowns:{q:0,e:0,f:0},
    _pausedByOrientation:false,
    deathNoteTargets:[],
    charmedEnemies:[],
    picklePoisons:[],
    pickleDash:null,
    twirl:null,
    kiraCutscene:null,
    blahBarrage:null,
    blahCutscene:null,
    subaru_checkpoint:null,
    subaruCutscene:null,
};

// ‚îÄ‚îÄ FIXED LOGICAL WORLD ‚îÄ‚îÄ
// The game always runs at a fixed 1920√ó1080 logical canvas.
// We scale it via CSS to fill the window, keeping aspect ratio (letterbox/pillarbox).
// This means the map is ALWAYS the same size regardless of display resolution or DPR.
const WORLD_W = 1920;
const WORLD_H = 1080;

// ZOOM is used for mouse/touch coordinate mapping
let ZOOM = 1;

function resize(){
    canvas.width  = WORLD_W;
    canvas.height = WORLD_H;

    const scaleX = window.innerWidth  / WORLD_W;
    const scaleY = window.innerHeight / WORLD_H;
    const scale  = Math.min(scaleX, scaleY);
    ZOOM = 1 / scale;

    const displayW = Math.round(WORLD_W * scale);
    const displayH = Math.round(WORLD_H * scale);
    canvas.style.width  = displayW + 'px';
    canvas.style.height = displayH + 'px';
    canvas.style.position = 'absolute';
    const offX = Math.round((window.innerWidth  - displayW) / 2);
    const offY = Math.round((window.innerHeight - displayH) / 2);
    canvas.style.left = offX + 'px';
    canvas.style.top  = offY + 'px';

    // Reposition all UI overlays to sit exactly over the canvas
    document.querySelectorAll('.ui-layer').forEach(el => {
        el.style.left   = offX + 'px';
        el.style.top    = offY + 'px';
        el.style.width  = displayW + 'px';
        el.style.height = displayH + 'px';
    });
}
window.addEventListener('resize',()=>{ resize(); checkOrientation(); });
resize();

// ‚îÄ‚îÄ CLASSES ‚îÄ‚îÄ
class TextPopup {
    constructor(x,y,text,color,life){this.x=x;this.y=y;this.text=text;this.color=color;this.maxLife=life||180;this.life=this.maxLife;}
    update(){this.y-=0.6;this.life--;}
    draw(){ctx.globalAlpha=Math.min(1,this.life/this.maxLife*2);ctx.fillStyle=this.color;ctx.font='10px "Press Start 2P"';ctx.textAlign='center';ctx.fillText(this.text,this.x,this.y);ctx.globalAlpha=1;}
}
function popup(x,y,text,color,life){if(settings.particles)state.textPopups.push(new TextPopup(x,y,text,color||'#fff',life));}

class BloodParticle {
    constructor(x,y){this.x=x;this.y=y;const a=Math.random()*Math.PI*2,s=1+Math.random()*4;this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s-2;this.gravity=0.18;this.r=2+Math.random()*4;this.life=40+Math.random()*30;this.maxLife=this.life;}
    update(){this.x+=this.vx;this.y+=this.vy;this.vy+=this.gravity;this.life--;}
    draw(){ctx.globalAlpha=this.life/this.maxLife;ctx.fillStyle=`hsl(${Math.random()*20},90%,${30+Math.random()*20}%)`;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;}
}
function spawnBlood(x,y,n){if(!settings.particles)return;for(let i=0;i<(n||8);i++)state.particles.push(new BloodParticle(x,y));}

class LightningEffect {
    constructor(fx,fy,tx,ty){this.fx=fx;this.fy=fy;this.tx=tx;this.ty=ty;this.life=20;this.maxLife=20;}
    draw(){const a=this.life/this.maxLife;ctx.save();ctx.globalAlpha=a;ctx.strokeStyle='#ffff00';ctx.lineWidth=2+a*2;ctx.shadowBlur=14;ctx.shadowColor='#ffffaa';
        const steps=7,dx=(this.tx-this.fx)/steps,dy=(this.ty-this.fy)/steps;
        ctx.beginPath();ctx.moveTo(this.fx,this.fy);
        for(let s=1;s<=steps;s++)ctx.lineTo(this.fx+dx*s+(s<steps?(Math.random()-.5)*30:0),this.fy+dy*s+(s<steps?(Math.random()-.5)*30:0));
        ctx.stroke();ctx.restore();this.life--;}
}

class EnemyBullet {
    constructor(x,y,angle,dmg,isBoss){this.x=x;this.y=y;const spd=isBoss?5.5:4;this.vx=Math.cos(angle)*spd;this.vy=Math.sin(angle)*spd;const bMult=state.bossMultiplier||1;const projScaling=isBoss?(bMult>=3?3:bMult>=2.5?2:bMult>=2?2:bMult>=1.5?2:1):1;this.damage=(dmg||1)*projScaling;this.life=150;this.isBoss=isBoss||false;this.size=isBoss?10:6;}
    update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
    draw(){ctx.save();ctx.fillStyle=this.isBoss?'#ff6600':'#ff4400';ctx.shadowBlur=8;ctx.shadowColor=this.isBoss?'#ff9900':'#ff4400';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.restore();}
}

class IcicleProjectile {
    constructor(x,y,angle){this.x=x;this.y=y;this.vx=Math.cos(angle)*14;this.vy=Math.sin(angle)*14;this.damage=state.player.damage*2.5;this.life=90;this.angle=angle;this.isIcicle=true;this.size=6;}
    update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
    draw(){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);ctx.fillStyle='#ccf8ff';ctx.shadowBlur=10;ctx.shadowColor='#00eeff';ctx.beginPath();ctx.moveTo(0,-13);ctx.lineTo(4,0);ctx.lineTo(0,14);ctx.lineTo(-4,0);ctx.closePath();ctx.fill();ctx.restore();}
}

class PiercingBullet {
    constructor(x,y,tx,ty,target,dmg){
        this.x=x;this.y=y;const ang=Math.atan2(ty-y,tx-x);
        this.vx=Math.cos(ang)*22;this.vy=Math.sin(ang)*22;
        this.damage=dmg;this.target=target;this.life=220;this.size=16;
        this.pierced=new Set();this.isDone=false;
    }
    update(){
        this.x+=this.vx;this.y+=this.vy;this.life--;
        state.enemies.forEach(e=>{
            if(e===this.target||this.pierced.has(e))return;
            if(Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2)<this.size+14){
                const dmg=this.damage*10;e.hp=Math.max(0,e.hp-dmg);this.pierced.add(e);
                spawnBlood(e.x,e.y,6);popup(e.x,e.y-20,`PIERCED -${Math.floor(dmg)}`,'#ff44ff',100);
            }
        });
        if(this.target&&Math.sqrt((this.target.x-this.x)**2+(this.target.y-this.y)**2)<this.size+(this.target.isBoss?32:16)){
            this.target.hp-=this.damage;
            spawnBlood(this.target.x,this.target.y,14);
            popup(this.target.x,this.target.y-35,`360! -${Math.floor(this.damage)}`,'#ff00ff',180);
            this.life=0;this.isDone=true;
        }
    }
    draw(){ctx.save();ctx.fillStyle='#ff44ff';ctx.strokeStyle='#ffffff';ctx.lineWidth=1.5;ctx.shadowBlur=16;ctx.shadowColor='#ff00ff';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.restore();}
}

class CoinProjectile {
    constructor(x,y,angle,bounces){this.x=x;this.y=y;this.vx=Math.cos(angle)*28;this.vy=Math.sin(angle)*28;this.damage=state.player.damage*2.5;this.bounces=bounces||15;this.hit=new Set();this.life=520;this.steer=999;}
    findTarget(){
        let best=null,bd=Infinity;
        state.enemies.forEach(e=>{if(this.hit.has(e))return;const d=Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2);if(d<bd){bd=d;best=e;}});
        if(!best&&state.boss&&!this.hit.has(state.boss))best=state.boss;
        return best;
    }
    update(){
        const ht=this.findTarget();
        if(ht){
            const dx=ht.x-this.x,dy=ht.y-this.y,d=Math.sqrt(dx*dx+dy*dy)||1;
            // Infinite turning: snap velocity instantly toward target at full speed
            const spd=Math.sqrt(this.vx*this.vx+this.vy*this.vy)||24;
            this.vx=(dx/d)*spd;this.vy=(dy/d)*spd;
        }
        this.x+=this.vx;this.y+=this.vy;this.life--;
        let hitEnemy=null,hd=Infinity;
        state.enemies.forEach(e=>{if(this.hit.has(e))return;const d=Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2);if(d<22&&d<hd){hd=d;hitEnemy=e;}});
        if(!hitEnemy&&state.boss&&!this.hit.has(state.boss)){const d=Math.sqrt((state.boss.x-this.x)**2+(state.boss.y-this.y)**2);if(d<38)hitEnemy=state.boss;}
        if(hitEnemy){
            hitEnemy.hp-=this.damage;popup(hitEnemy.x,hitEnemy.y-20,`üí∞-${Math.floor(this.damage)}`,'#ffd700');
            this.hit.add(hitEnemy);spawnBlood(hitEnemy.x,hitEnemy.y,4);
            this.bounces--;if(this.bounces<=0){this.life=0;return;}
        }
    }
    draw(){ctx.save();const r=10;ctx.shadowBlur=12;ctx.shadowColor='#ffd700';
        // Outer gold ring
        ctx.strokeStyle='#aa7700';ctx.lineWidth=2;ctx.fillStyle='#ffd700';
        ctx.beginPath();ctx.arc(this.x,this.y,r,0,Math.PI*2);ctx.fill();ctx.stroke();
        // Inner ridge
        ctx.strokeStyle='rgba(255,255,200,0.6)';ctx.lineWidth=1.5;
        ctx.beginPath();ctx.arc(this.x,this.y,r*0.7,0,Math.PI*2);ctx.stroke();
        // Center symbol
        ctx.fillStyle='#7a4d00';ctx.font='bold 11px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('¬¢',this.x,this.y+0.5);
        ctx.restore();}
}

class Bullet {
    constructor(x,y,angle,dmg,sz,crit,damageMult){this.x=x;this.y=y;this.vx=Math.cos(angle)*12;this.vy=Math.sin(angle)*12;this.damage=dmg*(damageMult||1);this.size=sz;this.crit=crit;this.life=65;}
    update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
    draw(){ctx.fillStyle=this.crit?'#ffd700':'#00f2ff';ctx.shadowBlur=this.crit?12:5;ctx.shadowColor=this.crit?'#ffd700':'#00f2ff';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
}

class XpOrb {
    constructor(x,y,val){this.x=x;this.y=y;this.val=val||20;}
    update(){const d=Math.sqrt((this.x-state.player.x)**2+(this.y-state.player.y)**2);if(d<160){this.x+=(state.player.x-this.x)*0.18;this.y+=(state.player.y-this.y)*0.18;}}
    draw(){ctx.fillStyle='#bc13fe';ctx.shadowBlur=6;ctx.shadowColor='#bc13fe';ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
}

// ‚îÄ‚îÄ EMOJI FILTER CACHE ‚îÄ‚îÄ
// Renders filtered emojis onto an offscreen canvas once and caches them.
// This avoids applying ctx.filter directly to the main canvas, which causes
// solid-black emoji rendering on iOS/Android (WebKit canvas compositing bug).
const _emojiFilterCache = {};
function getFilteredEmojiCanvas(emoji, filter, size){
    const key = emoji + '|' + filter + '|' + size;
    if(_emojiFilterCache[key]) return _emojiFilterCache[key];
    const oc = document.createElement('canvas');
    oc.width = size + 8; oc.height = size + 8;
    const octx = oc.getContext('2d');
    octx.filter = filter;
    octx.font = `${size}px Arial`;
    octx.textAlign = 'center';
    octx.textBaseline = 'middle';
    octx.fillText(emoji, oc.width/2, oc.height/2);
    _emojiFilterCache[key] = oc;
    return oc;
}

class Player {
    constructor(config){
        this.config=config;this.x=canvas.width/2;this.y=canvas.height/2;
        this.hp=config.hp;this.maxHp=config.hp;this.speed=config.speed;
        this.invul=0;this.facing=1;this.atkCooldown=0;
        this.atkSpeed=config.id==='coolioioio'?22:45;
        this.damage=config.id==='coolioioio'?4:10;this.projectileCount=1;this.bSize=5;this.crit=5;this.xpMult=1;
        this.size=config.imgSize||50;this.cutenessBoostShots=0;this.cutenessActive=false;this.regen=0;this.regenTick=0;
        this.bulletSpeedMult=1;this.pounceRegenTick=0;
        this._frenzyTimer=0;this._frenzyDmgMult=1;this._frenzyAtkBase=0;
        // Kira
        if(config.id==='kira'){this.godGauge=0;this.godGaugeMax=10;this.godMode=false;}
        // Femboy
        if(config.id==='femboy'){this.slayCharm=[];}
        // Subaru
        if(config.id==='subaru'){this.madnessMeter=0;this.lastMadnessDmg=0;}
    }
    update(){
        if(state.pounce.active){if(state.pounce.target){this.x=state.pounce.target.x;this.y=state.pounce.target.y;}if(this.invul>0)this.invul--;return;}
        if(state.mindControl.active){
            const host=state.mindControl.host;
            let dx=0,dy=0;
            if(state.keys['w']||state.keys['arrowup'])dy=-1;if(state.keys['s']||state.keys['arrowdown'])dy=1;
            if(state.keys['a']||state.keys['arrowleft'])dx=-1;if(state.keys['d']||state.keys['arrowright'])dx=1;
            if(state.joystick.active){dx=state.joystick.x;dy=state.joystick.y;}
            if(dx||dy){const m=Math.sqrt(dx*dx+dy*dy);const mcSpd=Math.max(host.speedBase,state.player.speed);host.x+=dx/m*mcSpd;host.y+=dy/m*mcSpd;}
            host.x=Math.max(65,Math.min(canvas.width-65,host.x));host.y=Math.max(65,Math.min(canvas.height-65,host.y));
            this.x=host.x;this.y=host.y;
            if(this.atkCooldown>0)this.atkCooldown--;else this.autoAttack();
            // Host shoots its own ranged attack if it has one
            if(host.hasRanged&&host.def){
                host.shootCooldown=(host.shootCooldown||0)-1;
                if(host.shootCooldown<=0){
                    const tgt2=autoPickTarget();
                    if(tgt2){const a=Math.atan2(tgt2.y-host.y,tgt2.x-host.x)+(Math.random()-.5)*0.25;const hb2=new EnemyBullet(host.x,host.y,a,this.damage*0.8,false);hb2.fromHost=true;state.enemyBullets.push(hb2);}
                    host.shootCooldown=host.def.shootInterval||60;
                }
            }
            if(state.mindControl.slamCooldown>0)state.mindControl.slamCooldown--;
            state.mindControl.mcTimer=(state.mindControl.mcTimer||0)+1;
            if(state.mindControl.mcTimer>=3600){killMindControlHost();return;}
            if(this.invul>0)this.invul--;return;
        }
        if(state.voltTackle){
            const vt=state.voltTackle;
            vt.timer--;
            this.x+=vt.vx;this.y+=vt.vy;
            this.x=Math.max(65,Math.min(canvas.width-65,this.x));this.y=Math.max(65,Math.min(canvas.height-65,this.y));
            if(vt.target&&!vt.hit){
                const d=Math.sqrt((vt.target.x-this.x)**2+(vt.target.y-this.y)**2);
                if(d<50||vt.timer<=0){
                    vt.hit=true;
                    vt.target.hp=Math.max(0,vt.target.hp-vt.dmg);
                    spawnBlood(vt.target.x,vt.target.y,14);
                    popup(vt.target.x,vt.target.y-35,`-${Math.floor(vt.dmg)} VOLT!`,'#ffff00');
                    if(!vt.target.isBoss)vt.target.stunned=120;else vt.target.stunned=30;
                    vt.target.x+=Math.cos(vt.ang)*160;vt.target.y+=Math.sin(vt.ang)*160;
                    if(vt.target.hp<=0){
                        const idx=state.enemies.indexOf(vt.target);
                        if(idx!==-1){killEnemy(vt.target,idx);state.enemies.splice(idx,1);}
                        else if(vt.target===state.boss&&state.boss){killEnemy(state.boss,-1);}
                    }
                    vt.target=null;
                    vt.vx=-Math.cos(vt.ang)*18;vt.vy=-Math.sin(vt.ang)*18;vt.timer=10;
                }
            }
            if(vt.timer<=0&&vt.hit)state.voltTackle=null;
            if(this.invul>0)this.invul--;return;
        }
        let dx=0,dy=0;
        if(state.keys['w']||state.keys['arrowup'])dy=-1;if(state.keys['s']||state.keys['arrowdown'])dy=1;
        if(state.keys['a']||state.keys['arrowleft'])dx=-1;if(state.keys['d']||state.keys['arrowright'])dx=1;
        if(state.joystick.active){dx=state.joystick.x;dy=state.joystick.y;}
        if(dx||dy){const m=Math.sqrt(dx*dx+dy*dy);const spd=this.speed*(this._warpSpeedBoost>0?1.8:1);this.x+=dx/m*spd;this.y+=dy/m*spd;if(dx)this.facing=dx>0?1:-1;}
        if(this._warpSpeedBoost>0)this._warpSpeedBoost--;
        this.x=Math.max(65,Math.min(canvas.width-65,this.x));this.y=Math.max(65,Math.min(canvas.height-65,this.y));
        if(this.invul>0)this.invul--;
        if(this.atkCooldown>0)this.atkCooldown--;else this.autoAttack();
    }
    autoAttack(){
        const skipHost=state.mindControl.active?state.mindControl.host:null;
        const allTargets=[...state.enemies];
        if(state.boss&&state.boss!==skipHost)allTargets.push(state.boss);
        let target=null,minDist=Infinity;
        const tMode=settings.shootTarget||'default';
        if(tMode==='manual'){
            // Shoot toward cursor ‚Äî create virtual target at cursor
            const angle=Math.atan2(state.mouseY-this.y,state.mouseX-this.x);
            const boost=this.cutenessBoostShots>0?2:1;
            const spd=12*this.bulletSpeedMult;
            for(let i=0;i<this.projectileCount;i++){
                const spread=(i-(this.projectileCount-1)/2)*0.2;
                const isCrit=Math.random()*100<this.crit;
                const frenzyM=(this.config.id==='tiger'&&this._frenzyTimer>0)?this._frenzyDmgMult:1;
                const b=new Bullet(this.x,this.y,angle+spread,this.damage*(isCrit?2:1)*frenzyM,this.bSize,isCrit,boost);
                b.vx*=this.bulletSpeedMult;b.vy*=this.bulletSpeedMult;
                state.bullets.push(b);
            }
            if(this.cutenessBoostShots>0){this.cutenessBoostShots--;popup(this.x,this.y-30,'2x DMG!','#ff88ff');}
            this.atkCooldown=this.atkSpeed*(this.cutenessActive?0.5:1);
            return;
        } else if(tMode==='strongest'){
            allTargets.forEach(e=>{if(e===skipHost)return;if(!target||e.hp>target.hp)target=e;});
        } else if(tMode==='closest'){
            allTargets.forEach(e=>{if(e===skipHost)return;const d=Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2);if(d<minDist){minDist=d;target=e;}});
        } else {
            // default: strongest until 50% hp, then closest
            if(this.hp>=this.maxHp*0.5){allTargets.forEach(e=>{if(e===skipHost)return;if(!target||e.hp>target.hp)target=e;});}
            else{allTargets.forEach(e=>{if(e===skipHost)return;const d=Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2);if(d<minDist){minDist=d;target=e;}});}
        }
        allTargets.forEach(e=>{if(e===skipHost)return;const d=Math.sqrt((e.x-this.x)**2+(e.y-this.y)**2);if(d<minDist){minDist=d;target=e;}});
        if(!target)return;
        const angle=Math.atan2(target.y-this.y,target.x-this.x);
        const boost=this.cutenessBoostShots>0?2:1;
        const spd=12*this.bulletSpeedMult;
        for(let i=0;i<this.projectileCount;i++){
            const spread=(i-(this.projectileCount-1)/2)*0.2;
            const isCrit=Math.random()*100<this.crit;
            const frenzyM2=(this.config.id==='tiger'&&(this._frenzyTimer||0)>0)?(this._frenzyDmgMult||1):1;
            const b=new Bullet(this.x,this.y,angle+spread,this.damage*(isCrit?2:1)*frenzyM2,this.bSize,isCrit,boost);
            b.vx*=this.bulletSpeedMult;b.vy*=this.bulletSpeedMult;
            state.bullets.push(b);
        }
        if(this.cutenessBoostShots>0){this.cutenessBoostShots--;popup(this.x,this.y-30,'2x DMG!','#ff88ff');}
        this.atkCooldown=Math.floor(this.atkSpeed*(this.cutenessActive?0.5:1));
    }
    draw(){
        if(state.mindControl.active){const h=state.mindControl.host;ctx.save();ctx.strokeStyle='#ff00ff';ctx.lineWidth=3;ctx.shadowBlur=15;ctx.shadowColor='#ff00ff';ctx.beginPath();ctx.arc(h.x,h.y,42,0,Math.PI*2);ctx.stroke();ctx.restore();return;}
        if(state.pounce.active)return;
        if(this.invul>0&&state.frameCount%6<3)return;
        ctx.save();ctx.translate(this.x,this.y);
        if(this.config.id==='coolioioio'&&state.spinbot){ctx.rotate(state.spinbot.angle);}
        else if(this.facing===-1)ctx.scale(-1,1);
        const noglinImg=(this.config.id==='noglin'&&this.cutenessActive&&assets.noglinCuteness.complete&&assets.noglinCuteness.naturalWidth!==0)?assets.noglinCuteness:this.config.img;
        if(noglinImg&&noglinImg.complete&&noglinImg.naturalWidth!==0){
            if(this.config.id==='noglin'){const nW=this.size*0.85,nH=nW*(585/1024);ctx.drawImage(noglinImg,-nW/2,-nH/2,nW,nH);}
            else{ctx.drawImage(noglinImg,-this.size/2,-this.size/2,this.size,this.size);}
        } else if(this.config.emojiFilter){
            // Draw filtered emoji onto offscreen canvas to avoid WebKit mobile black-rendering bug
            // when ctx.filter is applied directly to the main canvas.
            const oc=getFilteredEmojiCanvas(this.config.emoji,this.config.emojiFilter,this.size);
            ctx.drawImage(oc,-this.size/2,-this.size/2,this.size,this.size);
        } else {
            ctx.font=`${this.size}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText(this.config.emoji,0,0);
        }
        if(this._warpSpeedBoost>0){ctx.strokeStyle='rgba(0,255,136,0.5)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,this.size/2+8,0,Math.PI*2);ctx.stroke();}
        // Femboy twirl visual
        if(this.config.id==='femboy'&&state.twirl){ctx.rotate(state.twirl.angle*2);ctx.strokeStyle='rgba(255,136,204,0.4)';ctx.lineWidth=5;ctx.beginPath();ctx.arc(0,0,this.size/2+12,0,Math.PI*2);ctx.stroke();}
        ctx.restore();
    }
}

function pickEnemyDef(){const total=ENEMY_DEFS.reduce((s,d)=>s+d.weight,0);let r=Math.random()*total;for(const d of ENEMY_DEFS){r-=d.weight;if(r<=0)return d;}return ENEMY_DEFS[0];}

class Enemy {
    constructor(forceDef){
        const side=Math.floor(Math.random()*4);
        if(side===0){this.x=Math.random()*canvas.width;this.y=-55;}
        else if(side===1){this.x=canvas.width+55;this.y=Math.random()*canvas.height;}
        else if(side===2){this.x=Math.random()*canvas.width;this.y=canvas.height+55;}
        else{this.x=-55;this.y=Math.random()*canvas.height;}
        const def=forceDef||pickEnemyDef();
        this.def=def;this.type=def.emoji;this.hasRanged=def.hasRanged;
        this.meleeDmg=def.meleeDmg;this.preferDist=def.preferDist;
        this.maxHp=Math.floor((20+state.lvl*8)*def.hpMult*settings.difficulty);
        this.hp=this.maxHp;
        this.speedBase=(1.8+Math.random()*0.6)*def.speedMult*(1+state.lvl*0.04);
        this.stunned=0;this.isHost=false;this.fleeing=false;this.fleeTimer=0;
        this.meleeCooldown=0;this.shootCooldown=Math.floor(Math.random()*(def.shootInterval||120));
        this.isBoss=false;this.zigzag=def.type==='speeder'?1:0;this.zigzagTimer=0;
        this.confused=0;this.confuseAngle=Math.random()*Math.PI*2;this.confuseTimer=0;
    }
    getTarget(){
        if(state.mindControl.active)return{x:state.mindControl.host.x,y:state.mindControl.host.y};
        return{x:state.player.x,y:state.player.y};
    }
    update(){
        if(this.stunned>0){this.stunned--;return;}
        if(state.effects.frozen&&!this.isBoss)return;
        if(state.pounce.active&&state.pounce.target===this)return;
        if(state.mindControl.active&&this===state.mindControl.host)return;
        let spd=this.speedBase*(state.effects.timeSlow?0.15:1);
        if(this.confused>0){
            this.confused--;
            this.confuseTimer--;if(this.confuseTimer<=0){this.confuseAngle=Math.random()*Math.PI*2;this.confuseTimer=25+Math.random()*20;}
            this.x+=Math.cos(this.confuseAngle)*spd;this.y+=Math.sin(this.confuseAngle)*spd;
            this.x=Math.max(-100,Math.min(canvas.width+100,this.x));this.y=Math.max(-100,Math.min(canvas.height+100,this.y));
            return;
        }
        if(this.fleeing){
            this.fleeTimer--;if(this.fleeTimer<=0)this.fleeing=false;
            const dx=this.x-state.player.x,dy=this.y-state.player.y,d=Math.sqrt(dx*dx+dy*dy)||1;
            this.x+=(dx/d)*spd*1.6;this.y+=(dy/d)*spd*1.6;return;
        }
        const tgt=this.getTarget(),dx=tgt.x-this.x,dy=tgt.y-this.y,d=Math.sqrt(dx*dx+dy*dy)||1;
        if(this.hasRanged&&this.preferDist>0){
            if(d<this.preferDist*0.75){this.x-=(dx/d)*spd;this.y-=(dy/d)*spd;}
            else if(d>this.preferDist*1.3){this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;}
            else{this.x+=(-dy/d)*spd*0.4;this.y+=(dx/d)*spd*0.4;}
            if(this.shootCooldown<=0&&d<680){const a=Math.atan2(dy,dx)+(Math.random()-0.5)*0.3;if(!this.charmed)state.enemyBullets.push(new EnemyBullet(this.x,this.y,a,1,false));this.shootCooldown=this.def.shootInterval;}
            else this.shootCooldown--;
        } else {
            if(this.zigzag){this.zigzagTimer--;if(this.zigzagTimer<=0){this.zigzag*=-1;this.zigzagTimer=18+Math.random()*22;}
                this.x+=(dx/d)*spd+(-dy/d)*this.zigzag*spd*0.5;this.y+=(dy/d)*spd+(dx/d)*this.zigzag*spd*0.5;
            } else if(d>2){this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;}
        }
        if(this.meleeCooldown>0)this.meleeCooldown--;
    }
    draw(){
        if(this.x<-60||this.x>canvas.width+60||this.y<-60||this.y>canvas.height+60)return;
        ctx.save();
        const onScreen=this.x>-40&&this.x<canvas.width+40&&this.y>-40&&this.y<canvas.height+40;

        // Draw emoji WITHOUT any ctx.filter ‚Äî filter breaks emoji colour on iOS/Android WebKit
        if(state.effects.frozen&&!this.isBoss&&onScreen&&!this.isHost){
            ctx.globalAlpha=0.45;ctx.fillStyle='#aaeeff';ctx.beginPath();ctx.arc(this.x,this.y,16,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
        }
        ctx.font='24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(this.type,this.x,this.y);

        // Overlays drawn as plain shapes (no filter) so emoji stays coloured
        if(this.isHost&&onScreen){
            ctx.strokeStyle='#ff00ff';ctx.lineWidth=3;ctx.shadowBlur=12;ctx.shadowColor='#ff00ff';
            ctx.beginPath();ctx.arc(this.x,this.y,18,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
        }
        if(this.confused>0&&onScreen){
            ctx.strokeStyle='#00ffff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(this.x,this.y,16,0,Math.PI*2);ctx.stroke();
        }
        if(this.charmed>0&&onScreen){
            ctx.strokeStyle='#ff44aa';ctx.lineWidth=3;ctx.shadowBlur=10;ctx.shadowColor='#ff44aa';
            ctx.beginPath();ctx.arc(this.x,this.y,20,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
            ctx.font='10px Arial';ctx.fillStyle='#ff88cc';ctx.textAlign='center';ctx.fillText('üíï',this.x,this.y-28);
        }
        if(this.stunned>0&&onScreen&&!state.effects.frozen){
            ctx.strokeStyle='rgba(255,255,255,0.8)';ctx.lineWidth=2.5;ctx.shadowBlur=8;ctx.shadowColor='#ffffff';
            ctx.beginPath();ctx.arc(this.x,this.y,14,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
        }
        const bw=32;
        ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-bw/2,this.y-24,bw,5);
        ctx.fillStyle=this.isHost?'#ff00ff':'#00ff66';ctx.fillRect(this.x-bw/2,this.y-24,bw*(this.hp/this.maxHp),5);
        ctx.restore();
    }
}

class Boss {
    constructor(){
        const side=Math.floor(Math.random()*4);
        if(side===0){this.x=Math.random()*canvas.width;this.y=-80;}
        else if(side===1){this.x=canvas.width+80;this.y=Math.random()*canvas.height;}
        else if(side===2){this.x=Math.random()*canvas.width;this.y=canvas.height+80;}
        else{this.x=-80;this.y=Math.random()*canvas.height;}
        const def=BOSS_DEFS[Math.floor(Math.random()*BOSS_DEFS.length)];
        this.bossName=def.name;this.type=def.emoji;this.color=def.color;this.pattern=def.pattern||'chase';
        this.isBoss=true;this.isHost=false;this.stunned=0;
        this.fleeing=false;this.fleeTimer=0;this.meleeDmg=2+(state.lvl>10?1:0);this.meleeCooldown=0;
        const hpScale=(def.hpMult||1);
        this.maxHp=Math.floor((400+state.lvl*90)*settings.difficulty*hpScale*(state.bossMultiplier||1));
        this.hp=this.maxHp;
        this.speedBase=0.9+state.lvl*0.022;
        this.phase='chase';this.phaseTimer=180;this.shootCooldown=0;this.shootBurst=0;
        this.chargeDir={x:0,y:0};this.chargeTimer=0;
        this.confused=0;this.angle=0;
        this.patternTick=0;this.swirlAngle=0;
    }
    getTarget(){if(state.mindControl.active)return{x:state.mindControl.host.x,y:state.mindControl.host.y};return{x:state.player.x,y:state.player.y};}
    update(){
        if(this.stunned>0){this.stunned--;return;}
        const tgt=this.getTarget(),dx=tgt.x-this.x,dy=tgt.y-this.y,d=Math.sqrt(dx*dx+dy*dy)||1;
        let spd=this.speedBase*(state.effects.timeSlow?0.4:1);
        if(this.fleeing){this.fleeTimer--;if(this.fleeTimer<=0)this.fleeing=false;const fdx=this.x-state.player.x,fdy=this.y-state.player.y,fd=Math.sqrt(fdx*fdx+fdy*fdy)||1;this.x+=(fdx/fd)*spd*1.6;this.y+=(fdy/fd)*spd*1.6;return;}
        this.patternTick++;
        if(this.pattern==='charger'){
            this.phaseTimer--;
            if(this.phaseTimer<=0){
                if(this.phase==='chase'){this.phase='charge';this.phaseTimer=55;this.chargeDir={x:dx/d,y:dy/d};this.chargeTimer=55;}
                else if(this.phase==='charge'){this.phase='rest';this.phaseTimer=40;}
                else{this.phase='chase';this.phaseTimer=140;}
            }
            if(this.phase==='chase'){this.x+=(dx/d)*spd*1.3;this.y+=(dy/d)*spd*1.3;}
            else if(this.phase==='charge'&&this.chargeTimer>0){this.x+=this.chargeDir.x*spd*6;this.y+=this.chargeDir.y*spd*6;this.chargeTimer--;}
        } else if(this.pattern==='turret'){
            const preferDist=320;
            if(d<preferDist*0.7){this.x-=(dx/d)*spd;this.y-=(dy/d)*spd;}
            else if(d>preferDist*1.4){this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;}
            else{this.x+=(-dy/d)*spd*0.6;this.y+=(dx/d)*spd*0.6;}
            if(!this.turretReload){this.turretReload=0;this.turretBurstCount=0;}
            if(this.turretReload>0){this.turretReload--;}
            else if(this.patternTick%35===0){
                if(this.turretBurstCount<3){
                    const ba=Math.atan2(dy,dx);
                    for(let i=-1;i<=1;i++)state.enemyBullets.push(new EnemyBullet(this.x,this.y,ba+i*0.28,1.0,true));
                    this.turretBurstCount++;
                    if(this.turretBurstCount>=3){this.turretReload=240;this.turretBurstCount=0;popup(this.x,this.y-55,'RELOADING...','#aaaaaa',100);}
                }
            }
        } else if(this.pattern==='swirler'){
            this.swirlAngle+=0.03;
            const orbitR=280;
            const tx2=state.player.x+Math.cos(this.swirlAngle)*orbitR;
            const ty2=state.player.y+Math.sin(this.swirlAngle)*orbitR;
            const ox=tx2-this.x,oy=ty2-this.y,om=Math.sqrt(ox*ox+oy*oy)||1;
            this.x+=ox/om*spd*2;this.y+=oy/om*spd*2;
            if(this.patternTick%28===0){
                for(let i=0;i<4;i++){const a=this.swirlAngle+i*(Math.PI/2);state.enemyBullets.push(new EnemyBullet(this.x,this.y,a,1,true));}
            }
        } else if(this.pattern==='bursty'){
            this.phaseTimer--;
            if(this.phaseTimer<=0){
                if(this.phase==='chase'){this.phase='burst';this.phaseTimer=70;this.shootBurst=8;}
                else{this.phase='chase';this.phaseTimer=180;}
            }
            if(this.phase==='chase'){this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;}
            else if(this.phase==='burst'){
                if(this.shootCooldown<=0&&this.shootBurst>0){
                    const ba=Math.atan2(dy,dx);
                    for(let i=-1;i<=1;i++)state.enemyBullets.push(new EnemyBullet(this.x,this.y,ba+i*0.3+(Math.random()-.5)*0.15,1.3,true));
                    this.shootCooldown=9;this.shootBurst--;
                }else this.shootCooldown--;
            }
        } else if(this.pattern==='ghost'){
            this.phaseTimer--;
            if(this.phaseTimer<=0){
                if(this.phase==='chase'){
                    const ang=Math.random()*Math.PI*2;
                    this.x=state.player.x+Math.cos(ang)*200;this.y=state.player.y+Math.sin(ang)*200;
                    this.x=Math.max(65,Math.min(canvas.width-65,this.x));this.y=Math.max(65,Math.min(canvas.height-65,this.y));
                    this.phase='burst';this.phaseTimer=90;this.shootBurst=6;
                } else{this.phase='chase';this.phaseTimer=120;}
            }
            if(this.phase==='chase'){this.x+=(dx/d)*spd*0.5;this.y+=(dy/d)*spd*0.5;}
            else if(this.phase==='burst'){
                if(this.shootCooldown<=0&&this.shootBurst>0){
                    const a=Math.random()*Math.PI*2;
                    state.enemyBullets.push(new EnemyBullet(this.x,this.y,a,1.2,true));
                    this.shootCooldown=12;this.shootBurst--;
                }else this.shootCooldown--;
            }
        } else if(this.pattern==='swarm'){
            this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;
            if(this.patternTick%180===0&&state.enemies.length<60){
                for(let i=0;i<3;i++){const e=new Enemy();e.x=this.x+(Math.random()-.5)*60;e.y=this.y+(Math.random()-.5)*60;state.enemies.push(e);}
                popup(this.x,this.y-55,'SUMMONING!',this.color,120);
            }
            // Summoner also shoots periodically
            if(!this.summonShootCd)this.summonShootCd=0;
            this.summonShootCd--;
            if(this.summonShootCd<=0){
                const ba=Math.atan2(dy,dx);
                for(let i=0;i<3;i++)state.enemyBullets.push(new EnemyBullet(this.x,this.y,ba+i*(Math.PI*2/3),1.2,true));
                this.summonShootCd=120;
            }
        } else {
            this.phaseTimer--;
            if(this.phaseTimer<=0){
                if(this.phase==='chase'){this.phase='shoot';this.phaseTimer=130;this.shootBurst=4;}
                else if(this.phase==='shoot'){this.phase='charge';this.phaseTimer=80;this.chargeDir={x:dx/d,y:dy/d};this.chargeTimer=50;}
                else{this.phase='chase';this.phaseTimer=180;}
            }
            if(this.phase==='chase'){this.x+=(dx/d)*spd;this.y+=(dy/d)*spd;}
            else if(this.phase==='shoot'){
                this.x+=(-dy/d)*spd*0.5;this.y+=(dx/d)*spd*0.5;
                if(this.shootCooldown<=0&&this.shootBurst>0){const ba=Math.atan2(dy,dx);for(let i=-1;i<=1;i++)state.enemyBullets.push(new EnemyBullet(this.x,this.y,ba+i*0.28,1,true));this.shootCooldown=25;this.shootBurst--;}
                else this.shootCooldown--;
            } else if(this.phase==='charge'){if(this.chargeTimer>0){this.x+=this.chargeDir.x*spd*4.5;this.y+=this.chargeDir.y*spd*4.5;this.chargeTimer--;}}
        }
        if(this.meleeCooldown>0)this.meleeCooldown--;
    }
    draw(){
        ctx.save();ctx.font='52px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.shadowBlur=24;ctx.shadowColor=this.color;ctx.fillText(this.type,this.x,this.y);ctx.shadowBlur=0;
        const bw=90;ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-bw/2,this.y-50,bw,8);
        ctx.fillStyle=this.color;ctx.fillRect(this.x-bw/2,this.y-50,bw*(this.hp/this.maxHp),8);
        ctx.font='8px "Press Start 2P"';ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fillText(this.pattern.toUpperCase(),this.x,this.y-58);
        const margin=60,ox=Math.max(margin,Math.min(canvas.width-margin,this.x)),oy=Math.max(margin,Math.min(canvas.height-margin,this.y));
        if(ox!==this.x||oy!==this.y){const a=Math.atan2(this.y-canvas.height/2,this.x-canvas.width/2);ctx.fillStyle=this.color;ctx.font='16px Arial';ctx.save();ctx.translate(canvas.width/2+Math.cos(a)*(canvas.width/2-55),canvas.height/2+Math.sin(a)*(canvas.height/2-55));ctx.rotate(a);ctx.fillText('‚ñ∂',0,0);ctx.restore();}
        ctx.restore();
    }
}

function autoPickTarget(){
    let best=null,bd=Infinity;
    const all=[...state.enemies];if(state.boss)all.push(state.boss);
    const skipHost=state.mindControl.active?state.mindControl.host:null;
    all.forEach(e=>{if(e===skipHost)return;const d=Math.sqrt((e.x-state.player.x)**2+(e.y-state.player.y)**2);if(d<bd){bd=d;best=e;}});
    return best;
}
// ‚îÄ‚îÄ ABILITY TARGETING HELPER ‚îÄ‚îÄ
// Returns the aim angle for abilities that support both Auto and Manual targeting.
// Auto: aims at nearest enemy (or boss). Manual: aims at cursor.
function abilityAimAngle(px, py){
    if(settings.abilityTarget === 'manual'){
        return Math.atan2(state.mouseY - py, state.mouseX - px);
    }
    // Auto: find nearest enemy/boss
    let best=null, bd=Infinity;
    const all=[...state.enemies];
    if(state.boss) all.push(state.boss);
    all.forEach(e=>{const d=Math.sqrt((e.x-px)**2+(e.y-py)**2);if(d<bd){bd=d;best=e;}});
    if(best) return Math.atan2(best.y-py, best.x-px);
    // Fallback to cursor if no enemies
    return Math.atan2(state.mouseY - py, state.mouseX - px);
}

// ‚îÄ‚îÄ ABILITIES ‚îÄ‚îÄ
function triggerAbility(){
    if(state.pounce.active){state.pounce.active=false;state.player.invul=60;state.pounce.target=null;document.getElementById('pounceIndicator').style.display='none';return;}
    const p=state.player;
    if(state.mindControl.active){
        // SPC = delatch non-fatally
        ejectMindControl();
        return;
    }
    if(!state.ability.ready)return;
    let used=false;

    if(p.config.id==='noglin'){
        const ddx=state.mouseX-p.x,ddy=state.mouseY-p.y,dm=Math.sqrt(ddx*ddx+ddy*ddy)||1;
        const nx=ddx/dm,ny=ddy/dm,DASH=250;
        const tx=p.x+nx*DASH,ty=p.y+ny*DASH;
        let best=null,bestT=Infinity;
        const allTargets=[...state.enemies];
        if(state.boss)allTargets.push(state.boss);
        allTargets.forEach(e=>{
            const ex=e.x-p.x,ey=e.y-p.y,t=ex*nx+ey*ny;
            if(t<0||t>DASH)return;
            const cx=p.x+nx*t,cy=p.y+ny*t;
            const hitR=e.isBoss?50:42;
            if(Math.sqrt((e.x-cx)**2+(e.y-cy)**2)<hitR&&t<bestT){bestT=t;best=e;}
        });
        if(best){
            best.isHost=true;
            if(best.isBoss)state.boss.isHost=true;
            state.mindControl={active:true,host:best,savedHp:p.hp,slamCooldown:0,mcTimer:0};
            state.mcAbilityCooldowns={q:0,e:0,f:0};
            p.x=best.x;p.y=best.y;
            popup(p.x,p.y-60,'MIND CONTROL!','#ff00ff');
            const hType=best.def?best.def.type.toUpperCase():(best.isBoss?'BOSS':'???');
            document.getElementById('mindCtrlHud').innerHTML=`üëπ MIND CONTROLLING: ${hType}`;
            document.getElementById('mindCtrlHud').classList.remove('hidden');
            updateHUD();
            if(isMobile){document.getElementById('mc-controls').style.display='flex';}
        } else {
            p.x=Math.max(65,Math.min(canvas.width-65,tx));p.y=Math.max(65,Math.min(canvas.height-65,ty));
            p.invul=20;popup(p.x,p.y-30,'MISSED!','#888');
        }
        used=true;
    } else if(p.config.id==='pikachu'){
        const MAX_CHAINS=12,CHAIN_RANGE=5000;
        let startE=null,sd=Infinity;
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<10000&&d<sd){sd=d;startE=e;}});
        if(startE){
            const hit=new Set();
            const chain=[{from:{x:p.x,y:p.y},to:startE,mult:1}];
            hit.add(startE);let cur=startE;
            for(let i=1;i<MAX_CHAINS;i++){
                let next=null,nd=Infinity;
                const pool=[...state.enemies];if(state.boss)pool.push(state.boss);
                pool.forEach(e=>{if(hit.has(e))return;const d=Math.sqrt((e.x-cur.x)**2+(e.y-cur.y)**2);if(d<CHAIN_RANGE&&d<nd){nd=d;next=e;}});
                if(!next)break;
                chain.push({from:{x:cur.x,y:cur.y},to:next,mult:Math.pow(0.88,i)});
                hit.add(next);cur=next;
            }
            chain.forEach((arc,i)=>{
                setTimeout(()=>{
                    if(state.screen!=='PLAYING')return;
                    if(!arc.to||arc.to.hp<=0)return;
                    state.lightningEffects.push(new LightningEffect(arc.from.x,arc.from.y,arc.to.x,arc.to.y));
                    const dmg=p.damage*4.5*arc.mult*(state.effects.frozen&&!arc.to.isBoss?state.effects.frozenDamageMult:1);
                    arc.to.hp=Math.max(0,arc.to.hp-dmg);
                    if(!arc.to.isBoss)arc.to.stunned=Math.max(arc.to.stunned||0,80);
                    else if(arc.to.isBoss)arc.to.stunned=Math.max(arc.to.stunned||0,20);
                    popup(arc.to.x,arc.to.y-15,`‚ö°${Math.floor(dmg)}`,'#ffff00');
                    spawnBlood(arc.to.x,arc.to.y,4);
                },i*70);
            });
            popup(p.x,p.y-55,`‚ö° CHAIN x${chain.length}!`,'#ffff00');used=true;
        }
    } else if(p.config.id==='tiger'){
        const RANGE=460;
        const allT=[...state.enemies];if(state.boss)allT.push(state.boss);
        const candidates=allT.filter(e=>Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2)<RANGE);
        if(candidates.length>0){
            let target=candidates.reduce((best,e)=>e.hp>best.hp?e:best,candidates[0]);
            state.pounce={active:true,target:target,timer:600,damage:Math.max(5,p.damage*0.7),damageTick:0,healTick:0};
            p.x=target.x;p.y=target.y;target.stunned=999;
            popup(p.x,p.y-60,'POUNCE!','#ff9900');
            state.enemies.forEach(e=>{if(e!==target){const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<500){e.fleeing=true;e.fleeTimer=420;}}});
            if(state.boss&&state.boss!==target){const d=Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2);if(d<500){state.boss.fleeing=true;state.boss.fleeTimer=420;}}
            document.getElementById('pounceIndicator').style.display='block';
            used=true;
        }
    } else if(p.config.id==='cat'){
        const ddx=state.mouseX-p.x,ddy=state.mouseY-p.y,dm=Math.sqrt(ddx*ddx+ddy*ddy)||1;
        const beamLen=Math.max(800,Math.sqrt(canvas.width**2+canvas.height**2));
        state.glorpBeam={sx:p.x,sy:p.y,ex:p.x+(ddx/dm)*beamLen,ey:p.y+(ddy/dm)*beamLen,timer:90,maxTimer:90,nx:ddx/dm,ny:ddy/dm,len:beamLen};
        popup(p.x,p.y-55,'GLORP BEAM!','#00ff44');
        state.miniBeams=state.miniBeams||[];
        const mainAng=Math.atan2(ddy,ddx);
        const px=p.x,py=p.y;
        const NUM_RAYS=20;
        for(let ri=0;ri<NUM_RAYS;ri++){
            const spread=(ri/(NUM_RAYS-1)-0.5)*2.2;
            const rAng=mainAng+spread;
            const rLen=200+Math.random()*300;
            const rnx=Math.cos(rAng),rny=Math.sin(rAng);
            setTimeout(()=>{
                if(state.screen!=='PLAYING')return;
                state.miniBeams.push({sx:px,sy:py,ex:px+rnx*rLen,ey:py+rny*rLen,nx:rnx,ny:rny,len:rLen,timer:45,maxTimer:45});
                for(let i=state.enemies.length-1;i>=0;i--){
                    const e=state.enemies[i];
                    const t=((e.x-px)*rnx+(e.y-py)*rny);
                    if(t<0||t>rLen)continue;
                    const cx=px+rnx*t,cy=py+rny*t;
                    if(Math.sqrt((e.x-cx)**2+(e.y-cy)**2)<22){const miniDmg=state.player.damage*3;e.hp=Math.max(0,e.hp-miniDmg);spawnBlood(e.x,e.y,5);popup(e.x,e.y-20,`ZAP -${Math.floor(miniDmg)}`,'#00ff88');if(e.hp<=0){killEnemy(e,i);if(i<state.enemies.length)state.enemies.splice(i,1);}}
                }
            },ri*25);
        }
        used=true;
    } else if(p.config.id==='coolioioio'){
        state.spinbot={timer:240,shootTick:0,angle:0};
        popup(p.x,p.y-55,'üåÄ SPINBOT!','#ff44ff');
        used=true;
    } else if(p.config.id==='kira'){
        // Death Note: condemn the highest-HP visible enemy. They die after 3 seconds.
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        if(all.length===0){popup(p.x,p.y-30,'no targets','#cc0000');return;}
        // God Mode: instant kill on boss or highest-HP enemy
        if(p.godMode&&state.boss){
            state.boss.hp=0;
            popup(state.boss.x,state.boss.y-60,'‚úç I AM JUSTICE ‚úç','#ffd700',260);
            popup(state.boss.x,state.boss.y-35,'WRITTEN.','#cc0000',220);
            p.godMode=false;p.godGauge=0;used=true;
        } else {
            // Pick the highest-HP enemy
            const target=all.reduce((best,e)=>e.hp>best.hp?e:best,all[0]);
            const timerFrames=180;// 3 seconds
            state.deathNoteTargets=state.deathNoteTargets||[];
            // Don't double-condemn
            if(!state.deathNoteTargets.find(d=>d.enemy===target)){
                const isBossTarget=target.isBoss||target===state.boss;
                state.deathNoteTargets.push({enemy:target,timer:timerFrames,maxTimer:timerFrames,isBoss:isBossTarget,dmg:isBossTarget?target.maxHp*0.55:target.maxHp*99});
                popup(target.x,target.y-50,'‚úç CONDEMNED','#cc0000',200);
                popup(target.x,target.y-70,'3...','#ff4444',80);
                popup(p.x,p.y-40,'DEATH NOTE','#cc0000',120);
                used=true;
            } else {
                popup(p.x,p.y-30,'already condemned','#888');
            }
        }
    } else if(p.config.id==='femboy'){
        // Slay: emit sparkle shockwave, charm enemies in range to fight FOR you for 5s
        const RANGE=380;
        const CHARM_DUR=300;
        let charmed=0;
        state.charmedEnemies=state.charmedEnemies||[];
        const all2=[...state.enemies];if(state.boss)all2.push(state.boss);
        all2.forEach(e=>{
            const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
            if(d<RANGE&&!state.charmedEnemies.find(c=>c.enemy===e)){
                state.charmedEnemies.push({enemy:e,timer:CHARM_DUR});
                e.charmed=CHARM_DUR;
                spawnBlood(e.x,e.y,6);// sparkles
                const reactions=['OMFG üíï','SLAY QUEEN','OBSESSED','ICONIC','yasss üíÖ','omg yes','literally you','adorable...','i am yours'];
                popup(e.x,e.y-30,reactions[Math.floor(Math.random()*reactions.length)],'#ff88cc',200);
                charmed++;
            }
        });
        popup(p.x,p.y-60,'üíÖ SLAY!','#ff88cc',160);
        if(charmed===0)popup(p.x,p.y-40,'nobody slayed...','#888');
        else popup(p.x,p.y-80,`${charmed} charmed üíï`,'#ff44aa',180);
        used=true;
    } else if(p.config.id==='pickle'){
        // Brine Burst: poison + slow all enemies in range
        const RANGE=300;
        const all3=[...state.enemies];if(state.boss)all3.push(state.boss);
        state.picklePoisons=state.picklePoisons||[];
        let poisoned=0;
        all3.forEach(e=>{
            const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
            if(d<RANGE){
                // Stack or refresh poison
                const existing=state.picklePoisons.find(pp=>pp.enemy===e);
                const dmg=p.damage*0.4;
                if(existing){existing.timer=Math.max(existing.timer,420);existing.dps=Math.max(existing.dps,dmg);}
                else{state.picklePoisons.push({enemy:e,timer:420,dps:dmg,tickTimer:0});}
                // slow
                if(!e.isBoss)e.stunned=Math.max(e.stunned||0,60);
                popup(e.x,e.y-25,'ü•í BRINED','#44cc00',160);
                poisoned++;
            }
        });
        // Visual burst ring
        popup(p.x,p.y-60,'ü•í BRINE BURST!','#44cc00',200);
        if(poisoned>0)popup(p.x,p.y-80,`${poisoned} poisoned! ü§¢`,'#88ff44',180);
        spawnBlood(p.x,p.y,14);// green sparkles (reuse blood with green hue)
        used=true;
    } else if(p.config.id==='shiba'){
        const whimper=SHIBA_WHIMPERS[Math.floor(Math.random()*SHIBA_WHIMPERS.length)];
        popup(p.x,p.y-70,whimper,'#ffbbbb',220);
        const RANGE=420;
        const affected=[...state.enemies.filter(e=>Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2)<RANGE)];
        if(state.boss&&Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2)<RANGE)affected.push(state.boss);
        affected.forEach(e=>{
            const xpAmt=e.isBoss?200:60;
            for(let i=0;i<(e.isBoss?4:2);i++)state.xpOrbs.push(new XpOrb(e.x+(Math.random()-.5)*40,e.y+(Math.random()-.5)*40,xpAmt));
            e.fleeing=true;e.fleeTimer=480;
            const reactions=["poor baby üò¢","my heart üíî","i am so guilty","omg no","...fine","NOT THE EYES","why tho","i can't","ok ok here","ughhh","too cute","ugh fine","leave me alone","i feel bad now","here!!","why am i like this"];
            popup(e.x,e.y-30,reactions[Math.floor(Math.random()*reactions.length)],'#ffbbff',160);
        });
        if(affected.length===0)popup(p.x,p.y-40,'nobody cares üíî','#ff8888',180);
        used=true;
    } else if(p.config.id==='snowman'){
        state.effects.frozen=true;state.effects.frozenTimer=300;state.effects.frozenDamageMult=10;
        popup(p.x,p.y-60,'‚ùÑ FLASH FREEZE!','#88eeff');popup(p.x,p.y-80,'10x DAMAGE! 5s','#ffffff');used=true;
    } else if(p.config.id==='blahblahblah'){
        // Word Barrage: fire a rapid stream of word-bullets that each stun briefly
        const WORDS=['NAKAMA','BELIEVE IT','PLUS ULTRA','BANKAI','SHANNARO','GOMU GOMU','KAMEHAMEHA','STAND PROUD'];
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        let target=null,td=Infinity;
        all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<td){td=d;target=e;}});
        const baseAng=target?Math.atan2(target.y-p.y,target.x-p.x):Math.atan2(state.mouseY-p.y,state.mouseX-p.x);
        popup(p.x,p.y-60,'üí¨ WORD BARRAGE!','#cc44ff',180);
        state.blahBarrage={timer:60,shootTick:0,angle:baseAng,target};
        p.invul=60;
        used=true;
    } else if(p.config.id==='subaru'){
        // Return by Death: save a checkpoint. If player would die, return to it with full HP.
        // Also deals Madness-scaled damage burst to nearby enemies
        const madnessPct=(p.madnessMeter||0)/100;
        const burstDmg=p.damage*(3+madnessPct*12);
        const RANGE=250+madnessPct*150;
        state.subaru_checkpoint={x:p.x,y:p.y,hp:p.maxHp,frameSet:state.frameCount};
        popup(p.x,p.y-80,'üîÑ CHECKPOINT SET','#4488ff',200);
        if(madnessPct>0){
            // Madness burst
            for(let ei=state.enemies.length-1;ei>=0;ei--){
                const e=state.enemies[ei];
                const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
                if(d<RANGE){
                    e.hp=Math.max(0,e.hp-burstDmg);spawnBlood(e.x,e.y,8);
                    popup(e.x,e.y-20,`ECHOES -${Math.floor(burstDmg)}`,'#aa44ff',120);
                    if(e.hp<=0){killEnemy(e,ei);state.enemies.splice(ei,1);}
                }
            }
            if(state.boss){const d=Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2);if(d<RANGE){state.boss.hp=Math.max(0,state.boss.hp-burstDmg*0.4);popup(state.boss.x,state.boss.y-50,`ECHOES -${Math.floor(burstDmg*0.4)}`,'#aa44ff',180);updateBossBar();if(state.boss.hp<=0)killEnemy(state.boss,-1);}}
            if(madnessPct>=0.8){
                popup(p.x,p.y-110,'I WILL SAVE EVERYONE...','#ffffff',240);
                state.subaruCutscene={timer:120,maxTimer:120,type:'madness',madness:madnessPct};
            }
            popup(p.x,p.y-55,`üåÄ MADNESS ${Math.floor(p.madnessMeter)}% RELEASED`,'#aa44ff',200);
            p.madnessMeter=0;// reset madness after use
        } else {
            popup(p.x,p.y-55,'build madness by taking damage','#4488ff',180);
        }
        p.invul=60;
        used=true;
    }

    if(used){state.ability.ready=false;state.ability.cooldown=state.ability.maxCooldown;updateHUD();}
}

function triggerSecondary(){
    if(!state.secondary.ready)return;
    if(state.pounce.active||state.mindControl.active)return;
    const p=state.player;
    let used=false;

    if(p.config.id==='noglin'){
        const CUTENESS_LINES=["uwu don't fight me","look at my little face","please... i'm adorable","i'm too cute to hit","my eyes... they're huge","s-stop fighting...","notice me please uwu","i just want hugs ü•∫"];
        const ENEMY_CUTE_REACTIONS=["STUNNED üòç","TOO CUTE!!","MY HEART üíï","ADORABLE!!","omg... ü•∫","i cant...","SO SMALL","i give up üò≠"];
        const RANGE=300;
        let count=0;
        state.enemies.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<RANGE){e.stunned=120;count++;popup(e.x,e.y-20,ENEMY_CUTE_REACTIONS[Math.floor(Math.random()*ENEMY_CUTE_REACTIONS.length)],'#ff88ff',140);}});
        if(state.boss&&Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2)<RANGE){state.boss.stunned=120;count++;popup(state.boss.x,state.boss.y-40,'EVEN BOSSES FEEL IT...','#ff88ff',160);}
        p.cutenessBoostShots=2;
        p.cutenessActive=true;
        // cutenessActive lasts exactly as long as stun (120 frames = 2s) so image shows while enemies are stunned
        const _cutFrames=120;
        setTimeout(()=>{if(state.player===p)p.cutenessActive=false;},_cutFrames*(1000/60));
        popup(p.x,p.y-60,CUTENESS_LINES[Math.floor(Math.random()*CUTENESS_LINES.length)],'#ff66cc',180);
        if(count===0)popup(p.x,p.y-40,'nobody noticed...','#888');
        used=true;
    } else if(p.config.id==='pikachu'){
        let target=null,md=Infinity;
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        if(settings.abilityTarget==='manual'){
            // Manual: dash toward cursor, pick closest enemy in that direction as "target"
            const curAng=Math.atan2(state.mouseY-p.y,state.mouseX-p.x);
            all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<md){md=d;target=e;}});
            const ang=curAng;
            if(target){state.voltTackle={vx:Math.cos(ang)*32,vy:Math.sin(ang)*32,timer:10,target,ang,dmg:p.damage*5,hit:false};p.invul=40;popup(p.x,p.y-30,'VOLT TACKLE!','#ffff00');used=true;}
            else{const ang2=curAng;state.voltTackle={vx:Math.cos(ang2)*32,vy:Math.sin(ang2)*32,timer:14,target:null,ang:ang2,dmg:p.damage*5,hit:false};p.invul=40;popup(p.x,p.y-30,'VOLT TACKLE!','#ffff00');used=true;}
        } else {
            all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<md){md=d;target=e;}});
            if(target){
                const ang=Math.atan2(target.y-p.y,target.x-p.x);
                state.voltTackle={vx:Math.cos(ang)*32,vy:Math.sin(ang)*32,timer:10,target:target,ang:ang,dmg:p.damage*5,hit:false};
                p.invul=40;popup(p.x,p.y-30,'VOLT TACKLE!','#ffff00');used=true;
            } else popup(p.x,p.y-30,'NO TARGET','#888');
        }
    } else if(p.config.id==='tiger'){
        const AURA_ENEMY_LINES=["THAT TIGER HAS SO MUCH AURA","IM SCARED","DONT EAT ME","I DONT WANT THESE PROBLEMS","THE VIBE IS WRONG","NOPE NOPE NOPE","TOO MUCH AURA","MY INSTINCTS SAY RUN","WHAT IS THAT ENERGY","IM NOT PAID ENOUGH","SOMEONE ELSE DEAL WITH IT","BIG SCARY CAT","I FELT THAT IN MY SOUL","THE AURA RADIATES","LEAVE ME ALONE","I AM FLEEING"];
        state.enemies.forEach(e=>{e.fleeing=true;e.fleeTimer=240;popup(e.x,e.y-25,AURA_ENEMY_LINES[Math.floor(Math.random()*AURA_ENEMY_LINES.length)],'#ffcc88',160);});
        if(state.boss){state.boss.fleeing=true;state.boss.fleeTimer=240;popup(state.boss.x,state.boss.y-50,'EVEN I RESPECT THIS AURA...','#ff9900',200);}
        popup(p.x,p.y-55,'üêØ SHEER AURA','#ff6600',160);
        popup(p.x,p.y-80,'enemies are scared, from my sheer aura','#ffaa00',200);
        used=true;
    } else if(p.config.id==='cat'){
        const destX=Math.max(65,Math.min(canvas.width-65,state.mouseX));
        const destY=Math.max(65,Math.min(canvas.height-65,state.mouseY));
        popup(p.x,p.y,'üí´','#00ff88');
        p.x=destX;p.y=destY;p.invul=100;
        popup(p.x,p.y-35,'WARP!','#00ff88');
        state.enemies.forEach(e=>{e.confused=300;e.confuseTimer=0;popup(e.x,e.y-20,'??','#00ff88');});
        if(state.boss){state.boss.confused=180;popup(state.boss.x,state.boss.y-50,'BOSS CONFUSED!','#00ff88',160);}
        p._warpSpeedBoost=240;
        used=true;
    } else if(p.config.id==='shiba'){
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        let first=null,fd=Infinity;
        if(settings.abilityTarget==='manual'){
            // Manual: launch coin toward cursor
            const ang=Math.atan2(state.mouseY-p.y,state.mouseX-p.x);
            const coin=new CoinProjectile(p.x,p.y,ang,15);
            state.bullets.push(coin);
            popup(p.x,p.y-50,'üí∞ 50 BUCKS!','#ffd700');used=true;
        } else {
            all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<fd){fd=d;first=e;}});
            if(first){
                const ang=Math.atan2(first.y-p.y,first.x-p.x);
                const coin=new CoinProjectile(p.x,p.y,ang,15);
                state.bullets.push(coin);
                popup(p.x,p.y-50,'üí∞ 50 BUCKS!','#ffd700');used=true;
            } else popup(p.x,p.y-30,'no targets','#888');
        }
    } else if(p.config.id==='snowman'){
        const ang=abilityAimAngle(p.x, p.y);
        // Fan pattern: 7 icicles in a 180-degree arc toward aim direction
        const FAN_COUNT=7;
        const FAN_SPREAD=Math.PI; // full half-circle
        for(let i=0;i<FAN_COUNT;i++){
            const t=FAN_COUNT===1?0:(i/(FAN_COUNT-1)-0.5);
            const spread=t*FAN_SPREAD;
            state.bullets.push(new IcicleProjectile(p.x,p.y,ang+spread));
        }
        popup(p.x,p.y-55,'üßä ICICLE BARRAGE!','#aaffff');used=true;
    } else if(p.config.id==='kira'){
        // Justice Monologue: stun + brief invul + 50% maxHp to all enemies, 35% to boss + ANIME CUTSCENE
        const MONOLOGUE=[
            'I WILL BUILD A NEW WORLD FREE OF EVIL',
            'ONLY I CAN CLEANSE THIS WORLD',
            'JUSTICE WILL PREVAIL',
            'MY NAME IS... KIRA',
            'THIS WORLD IS ROTTEN',
            'I AM THE ONE WHO WILL BECOME THE GOD OF THE NEW WORLD',
            'JUST AS PLANNED',
            'AM I A BAD PERSON? NO. I AM A GOD.',
        ];
        const line=MONOLOGUE[Math.floor(Math.random()*MONOLOGUE.length)];
        // Trigger anime cutscene overlay
        state.kiraCutscene={timer:180,maxTimer:180,line};
        popup(p.x,p.y-60,'üìì JUSTICE!','#cc0000',200);
        p.invul=240;
        // Kill enemies by dealing 50% of their max HP
        for(let ei=state.enemies.length-1;ei>=0;ei--){
            const e=state.enemies[ei];
            e.stunned=Math.max(e.stunned||0,240);
            const dmg=e.maxHp*0.5;
            e.hp=Math.max(0,e.hp-dmg);
            spawnBlood(e.x,e.y,8);
            popup(e.x,e.y-20,`‚úù -${Math.floor(dmg)}`,'#cc0000',140);
            if(e.hp<=0){killEnemy(e,ei);state.enemies.splice(ei,1);}
        }
        // Boss takes 35% max HP
        if(state.boss){
            state.boss.stunned=Math.max(state.boss.stunned||0,240);
            const bossDmg=state.boss.maxHp*0.35;
            state.boss.hp=Math.max(0,state.boss.hp-bossDmg);
            spawnBlood(state.boss.x,state.boss.y,14);
            popup(state.boss.x,state.boss.y-50,`‚úù JUDGED -${Math.floor(bossDmg)}`,'#ffd700',220);
            updateBossBar();
            if(state.boss.hp<=0)killEnemy(state.boss,-1);
        }
        used=true;
    } else if(p.config.id==='femboy'){
        // Twirl: spin in place for 3 seconds doing sparkle AOE every 10 frames
        state.twirl={timer:180,angle:0,damageTick:0};
        popup(p.x,p.y-60,'üíÖ TWIRL!','#ff44aa',180);
        p.invul=180;
        used=true;
    } else if(p.config.id==='pickle'){
        // Pickle Dash: become tiny rick, dash through all enemies leaving poison trail
        const PICKLE_QUOTES=["I'M PICKLE RICK!","WUBBA LUBBA DUB DUB!","BOOM ‚Äî BIG MOVES BABY","I TURNED MYSELF INTO A PICKLE MORTY","NOBODY EXPECTS THE PICKLE"];
        popup(p.x,p.y-70,PICKLE_QUOTES[Math.floor(Math.random()*PICKLE_QUOTES.length)],'#44ff44',280);
        // Collect targets sorted by distance
        const allE=[...state.enemies];if(state.boss)allE.push(state.boss);
        const sorted=allE.sort((a,b)=>Math.sqrt((a.x-p.x)**2+(a.y-p.y)**2)-Math.sqrt((b.x-p.x)**2+(b.y-p.y)**2));
        const targets=sorted.slice(0,8);
        state.picklePoisons=state.picklePoisons||[];
        // Store trail for animation
        state.pickleDash={active:true,trail:[{x:p.x,y:p.y,life:30}],targetIdx:0,targets,delay:0,dmg:p.damage*3,px:p.x,py:p.y};
        if(targets.length===0)popup(p.x,p.y-40,'no targets','#888');
        used=true;
    } else if(p.config.id==='coolioioio'){
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        if(all.length===0){popup(p.x,p.y-30,'no targets','#888');return;}
        let mainTarget;
        if(settings.abilityTarget==='manual'){
            let cd=Infinity;
            all.forEach(e=>{const d=Math.sqrt((e.x-state.mouseX)**2+(e.y-state.mouseY)**2);if(d<cd){cd=d;mainTarget=e;}});
        } else {
            mainTarget=all.reduce((best,e)=>e.hp>best.hp?e:best,all[0]);
        }
        state.bullets.push(new PiercingBullet(p.x,p.y,mainTarget.x,mainTarget.y,mainTarget,p.damage*18));
        popup(p.x,p.y-55,'üéØ 360-NO-SCOPE','#ff44ff',180);
        popup(mainTarget.x,mainTarget.y-40,'MAIN TARGET','#ff00ff',140);
        const sorted=[...all].sort((a,b)=>Math.sqrt((a.x-p.x)**2+(a.y-p.y)**2)-Math.sqrt((b.x-p.x)**2+(b.y-p.y)**2));
        const closest=sorted[0]!==mainTarget?sorted[0]:sorted[1];
        if(closest){state.bullets.push(new PiercingBullet(p.x,p.y,closest.x,closest.y,closest,p.damage*12));popup(closest.x,closest.y-30,'CLOSEST','#ff88ff',100);}
        const furthest=sorted[sorted.length-1]!==mainTarget?sorted[sorted.length-1]:sorted[sorted.length-2];
        if(furthest&&furthest!==closest){state.bullets.push(new PiercingBullet(p.x,p.y,furthest.x,furthest.y,furthest,p.damage*12));popup(furthest.x,furthest.y-30,'FURTHEST','#ff88ff',100);}
        used=true;
    } else if(p.config.id==='blahblahblah'){
        // Ultimate Speech: fullscreen anime cutscene then nuke everything in huge radius
        const SPEECHES=['I CANNOT GIVE UP NOW ‚Äî MY FRIENDS NEED ME!','THIS POWER... IS THE POWER OF BONDS!','I REFUSE TO LOSE IN A PLACE LIKE THIS!','JUST WHO THE HECK DO YOU THINK I AM?!','I WILL SURPASS MY LIMITS... RIGHT HERE, RIGHT NOW!'];
        const speechLine=SPEECHES[Math.floor(Math.random()*SPEECHES.length)];
        state.blahCutscene={timer:200,maxTimer:200,line:speechLine};
        popup(p.x,p.y-60,'üí¨ ULTIMATE SPEECH!','#cc44ff',200);
        p.invul=300;
        // Massive nuke after short delay
        setTimeout(()=>{
            if(state.screen!=='PLAYING')return;
            const RANGE=600;
            for(let ei=state.enemies.length-1;ei>=0;ei--){
                const e=state.enemies[ei];
                const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
                if(d<RANGE){
                    const dmg=p.damage*15;e.hp=Math.max(0,e.hp-dmg);spawnBlood(e.x,e.y,10);
                    popup(e.x,e.y-25,`üí¨ -${Math.floor(dmg)}`,'#cc44ff',120);
                    if(e.hp<=0){killEnemy(e,ei);state.enemies.splice(ei,1);}
                }
            }
            if(state.boss){const d=Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2);if(d<RANGE){const dmg=p.damage*8;state.boss.hp=Math.max(0,state.boss.hp-dmg);popup(state.boss.x,state.boss.y-60,`üí¨ -${Math.floor(dmg)}`,'#cc44ff',180);updateBossBar();if(state.boss.hp<=0)killEnemy(state.boss,-1);}}
        },1500);
        used=true;
    } else if(p.config.id==='subaru'){
        // Unseen Hand: grab all enemies in range and slam them into each other
        const LINES=['BEATRICE, I NEED YOU!','BY THE POWER OF THE UNSEEN HAND!','ROSWAAL... THIS IS FOR EVERYONE!','I PROMISED I WOULD WIN!'];
        popup(p.x,p.y-80,LINES[Math.floor(Math.random()*LINES.length)],'#4488ff',280);
        const all=[...state.enemies];if(state.boss)all.push(state.boss);
        const RANGE=400;const nearby=all.filter(e=>Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2)<RANGE);
        if(nearby.length===0){popup(p.x,p.y-40,'nobody nearby','#888');return;}
        // Yank all nearby enemies toward center, then release
        nearby.forEach(e=>{
            const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
            const dmg=p.damage*5*(e.isBoss?0.4:1);
            e.hp=Math.max(0,e.hp-dmg);spawnBlood(e.x,e.y,8);
            popup(e.x,e.y-25,`üåÄ -${Math.floor(dmg)}`,'#4488ff',100);
            // Fling toward player center
            const ang=Math.atan2(p.y-e.y,p.x-e.x);
            e.x+=Math.cos(ang)*80;e.y+=Math.sin(ang)*80;
            if(e.hp<=0){
                if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                else{killEnemy(state.boss,-1);}
            }
        });
        popup(p.x,p.y-55,'üåÄ UNSEEN HAND!','#4488ff',200);
        // Gain madness for using a spell
        p.madnessMeter=Math.min(100,(p.madnessMeter||0)+15);
        used=true;
    }

    if(used){state.secondary.ready=false;state.secondary.cooldown=state.secondary.maxCooldown;updateHUD();}
}

function killMindControlHost(){
    if(!state.mindControl.active)return;
    const h=state.mindControl.host;
    // Heal the noglin based on remaining host HP ‚Äî reward for smart early termination
    const healPct=h.hp/h.maxHp;
    const healAmt=Math.max(1,Math.ceil(healPct*state.player.maxHp*0.5));
    // Clean up in-flight MC abilities
    if(state.mindControl.hurlState){state.mindControl.hurlState.projectile&&(state.mindControl.hurlState.projectile.stunned=0);state.mindControl.hurlState=null;}
    state.mindControl.vortexTimer=0;
    const idx=state.enemies.indexOf(h);
    if(idx!==-1){killEnemy(h,idx);state.enemies.splice(idx,1);}
    else if(h===state.boss&&state.boss){killEnemy(state.boss,-1);}
    state.mindControl.active=false;h.isHost=false;
    state.player.hp=Math.min(state.player.maxHp,state.mindControl.savedHp+healAmt);
    state.player.invul=120;
    popup(h.x,h.y-50,'HOST TERMINATED','#ff0044');
    popup(h.x,h.y-70,`+${healAmt}‚ù§ HARVEST`,'#ff88ff',120);
    document.getElementById('mindCtrlHud').classList.add('hidden');
    document.getElementById('mc-controls').style.display='none';
    updateHUD();
}
function ejectMindControl(){
    if(!state.mindControl.active)return;
    const h=state.mindControl.host;
    // Clean up in-flight MC abilities
    if(state.mindControl.hurlState){state.mindControl.hurlState.projectile&&(state.mindControl.hurlState.projectile.stunned=0);state.mindControl.hurlState=null;}
    state.mindControl.vortexTimer=0;
    state.mindControl.active=false;h.isHost=false;
    state.player.x=h.x;state.player.y=h.y;state.player.hp=state.mindControl.savedHp;state.player.invul=120;
    popup(h.x,h.y-50,'EJECTED!','#ff88ff');
    document.getElementById('mindCtrlHud').classList.add('hidden');
    document.getElementById('mc-controls').style.display='none';
    updateHUD();
}

function triggerMCAbility(key){
    if(!state.mindControl.active)return;
    const p=state.player,host=state.mindControl.host;
    const cd=state.mcAbilityCooldowns;
    const hostType=host.def?host.def.type:(host.isBoss?'boss':'unknown');
    if(!state.mcRings)state.mcRings=[];

    if(key==='q'){
        if(cd.q>0)return;

        // ‚îÄ‚îÄ GRUNT ‚Üí FRENZY ‚îÄ‚îÄ
        if(hostType==='grunt'){
            popup(host.x,host.y-55,'üò° FRENZY!','#ff4400',180);
            // Spiral red burst visual
            state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:200,timer:18,maxTimer:18,color:'#ff4400',lw:3});
            state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:140,timer:12,maxTimer:12,color:'#ff8800',lw:2});
            const victims=[...state.enemies.filter(e=>e!==host)];
            if(state.boss)victims.push(state.boss);
            victims.sort((a,b)=>Math.sqrt((a.x-host.x)**2+(a.y-host.y)**2)-Math.sqrt((b.x-host.x)**2+(b.y-host.y)**2));
            victims.forEach((e,i)=>{
                setTimeout(()=>{
                    if(!state.mindControl.active||!e||e.hp<=0)return;
                    host.x=e.x;host.y=e.y;
                    state.mcRings.push({cx:e.x,cy:e.y,r:0,maxR:80,timer:10,maxTimer:10,color:'#ff4400',lw:2});
                    spawnBlood(e.x,e.y,8);
                    const dmg=p.damage*4;// nerfed from 8x
                    e.hp=Math.max(0,e.hp-dmg);
                    popup(e.x,e.y-20,`üí•-${Math.floor(dmg)}`,'#ff4400',80);
                    if(!e.isBoss)e.stunned=40;
                    if(e.hp<=0){
                        if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                        else killEnemy(state.boss,-1);
                    }
                },i*80);
            });
            if(victims.length===0)popup(host.x,host.y-40,'nothing to charge!','#888');
            cd.q=360;
        }

        // ‚îÄ‚îÄ SHOOTER ‚Üí VOLLEY ‚îÄ‚îÄ
        else if(hostType==='shooter'){
            popup(host.x,host.y-55,'üéØ VOLLEY!','#ffaa00',180);
            // Orange burst rings
            for(let ri=0;ri<3;ri++)state.mcRings.push({cx:host.x,cy:host.y,r:ri*30,maxR:180+ri*40,timer:14,maxTimer:14,color:'#ffaa00',lw:2});
            const allT=[...state.enemies.filter(e=>e!==host)];
            if(state.boss)allT.push(state.boss);
            allT.sort((a,b)=>b.hp-a.hp);
            const targets=allT.slice(0,5);
            targets.forEach((tgt,ti)=>{
                for(let s=0;s<4;s++){
                    setTimeout(()=>{
                        if(!state.mindControl.active||!tgt||tgt.hp<=0)return;
                        const ang=Math.atan2(tgt.y-host.y,tgt.x-host.x)+(Math.random()-0.5)*0.12;
                        // Orange homing bullet ‚Äî isMCBullet so it hits enemies but NOT the host
                        const hb={x:host.x,y:host.y,vx:Math.cos(ang)*11,vy:Math.sin(ang)*11,
                            damage:p.damage*1.5,// nerfed from 2.5x
                            life:180,size:7,isMCBullet:true,trackTarget:tgt,trackStrength:0.15,
                            draw(){ctx.fillStyle='#ffaa00';ctx.shadowBlur=8;ctx.shadowColor='#ffdd44';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}};
                        state.bullets.push(hb);
                    },ti*90+s*18);
                }
            });
            if(targets.length===0)popup(host.x,host.y-40,'no targets!','#888');
            cd.q=280;
        }

        // ‚îÄ‚îÄ WARLOCK ‚Üí SOUL VORTEX ‚îÄ‚îÄ
        else if(hostType==='warlock'){
            popup(host.x,host.y-55,'üåÄ SOUL VORTEX!','#cc00ff',200);
            state.mindControl.vortexTimer=120;
            state.mindControl.vortexX=host.x;
            state.mindControl.vortexY=host.y;
            // Spinning inward rings every 20 frames during pull
            for(let ri=0;ri<5;ri++)setTimeout(()=>{
                if(!state.mindControl.active)return;
                state.mcRings.push({cx:state.mindControl.vortexX,cy:state.mindControl.vortexY,r:400,maxR:0,timer:18,maxTimer:18,color:'#cc00ff',lw:2,inward:true});
            },ri*400);
            const vx2=host.x,vy2=host.y;
            setTimeout(()=>{
                if(state.screen!=='PLAYING')return;
                popup(vx2,vy2-55,'üíú VORTEX BURST!','#ff00ff',200);
                // Big purple burst ring
                state.mcRings.push({cx:vx2,cy:vy2,r:0,maxR:600,timer:22,maxTimer:22,color:'#ff00ff',lw:5});
                state.mcRings.push({cx:vx2,cy:vy2,r:0,maxR:400,timer:18,maxTimer:18,color:'#cc00ff',lw:3});
                const all2=[...state.enemies];if(state.boss)all2.push(state.boss);
                all2.forEach(e=>{
                    if(e===host)return;
                    const dmg=p.damage*8;// nerfed from 14x
                    e.hp=Math.max(0,e.hp-dmg*(e.isBoss?0.4:1));
                    spawnBlood(e.x,e.y,8);
                    popup(e.x,e.y-20,`üíú-${Math.floor(dmg*(e.isBoss?0.4:1))}`,'#cc00ff',100);
                    const ang2=Math.atan2(e.y-vy2,e.x-vx2);
                    e.x+=Math.cos(ang2)*200;e.y+=Math.sin(ang2)*200;
                    e.x=Math.max(0,Math.min(canvas.width,e.x));e.y=Math.max(0,Math.min(canvas.height,e.y));
                    if(e.hp<=0){
                        if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                        else killEnemy(state.boss,-1);
                    }
                });
            },2000);
            cd.q=420;
        }

        // ‚îÄ‚îÄ TANK ‚Üí SHOCKWAVE SLAM ‚îÄ‚îÄ
        else if(hostType==='tank'){
            popup(host.x,host.y-55,'üåä SHOCKWAVE SLAM!','#88aaff',200);
            const WAVES=4,WAVE_DELAY=120,WAVE_RADIUS_MAX=500;
            for(let w=0;w<WAVES;w++){
                setTimeout(()=>{
                    if(!state.mindControl.active)return;
                    const wRadius=(w+1)*(WAVE_RADIUS_MAX/WAVES);
                    const prevR=w*(WAVE_RADIUS_MAX/WAVES);
                    // Draw the ring at the right radius
                    state.mcRings.push({cx:host.x,cy:host.y,r:prevR,maxR:wRadius,timer:20,maxTimer:20,color:'#88aaff',lw:4});
                    const dmg=p.damage*(7-w);// nerfed from 12-w*2
                    const all3=[...state.enemies];if(state.boss)all3.push(state.boss);
                    all3.forEach(e=>{
                        if(e===host)return;
                        const d=Math.sqrt((e.x-host.x)**2+(e.y-host.y)**2);
                        if(d>=prevR&&d<wRadius){
                            e.hp=Math.max(0,e.hp-dmg*(e.isBoss?0.35:1));
                            spawnBlood(e.x,e.y,6);
                            popup(e.x,e.y-20,`üí´-${Math.floor(dmg*(e.isBoss?0.35:1))}`,'#88aaff',90);
                            const ang3=Math.atan2(e.y-host.y,e.x-host.x);
                            e.x+=Math.cos(ang3)*260;e.y+=Math.sin(ang3)*260;
                            e.x=Math.max(0,Math.min(canvas.width,e.x));e.y=Math.max(0,Math.min(canvas.height,e.y));
                            if(!e.isBoss)e.stunned=80;
                            if(e.hp<=0){
                                if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                                else killEnemy(state.boss,-1);
                            }
                        }
                    });
                },w*WAVE_DELAY);
            }
            cd.q=360;
        }

        // ‚îÄ‚îÄ SPEEDER ‚Üí PHANTOM RUSH ‚îÄ‚îÄ
        else if(hostType==='speeder'){
            popup(host.x,host.y-55,'üëª PHANTOM RUSH!','#ffff44',200);
            // Yellow flash ring
            state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:180,timer:12,maxTimer:12,color:'#ffff44',lw:3});
            const victims2=[...state.enemies.filter(e=>e!==host)];
            if(state.boss)victims2.push(state.boss);
            for(let i=victims2.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[victims2[i],victims2[j]]=[victims2[j],victims2[i]];}
            const targets2=victims2.slice(0,7);
            targets2.forEach((tgt,i)=>{
                setTimeout(()=>{
                    if(!state.mindControl.active||!tgt||tgt.hp<=0)return;
                    host.x=tgt.x;host.y=tgt.y;
                    state.mcRings.push({cx:tgt.x,cy:tgt.y,r:0,maxR:130,timer:10,maxTimer:10,color:'#ffff44',lw:2});
                    spawnBlood(tgt.x,tgt.y,6);
                    const AOE=130,dmg=p.damage*3;// nerfed from 5x
                    const near=[...state.enemies.filter(e=>e!==host),state.boss].filter(Boolean);
                    near.forEach(e=>{
                        const d=Math.sqrt((e.x-host.x)**2+(e.y-host.y)**2);
                        if(d<AOE){
                            e.hp=Math.max(0,e.hp-dmg*(e.isBoss?0.3:1));
                            spawnBlood(e.x,e.y,4);
                            popup(e.x,e.y-20,`‚ö°-${Math.floor(dmg*(e.isBoss?0.3:1))}`,'#ffff44',70);
                            if(!e.isBoss)e.stunned=25;
                            if(e.hp<=0){
                                if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                                else killEnemy(state.boss,-1);
                            }
                        }
                    });
                },i*60);
            });
            if(targets2.length===0)popup(host.x,host.y-40,'no targets!','#888');
            cd.q=300;
        }

        // ‚îÄ‚îÄ BRUTE ‚Üí HURL ‚îÄ‚îÄ
        else if(hostType==='brute'){
            let hurled=null,hd=Infinity;
            state.enemies.forEach(e=>{if(e===host)return;const d=Math.sqrt((e.x-host.x)**2+(e.y-host.y)**2);if(d<hd){hd=d;hurled=e;}});
            if(!hurled&&state.boss)hurled=state.boss;
            if(hurled){
                popup(host.x,host.y-55,'üóø HURL!','#ffcc44',200);
                popup(hurled.x,hurled.y-30,'THROWN!','#ffcc44',100);
                state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:100,timer:12,maxTimer:12,color:'#ffcc44',lw:4});
                const ang=Math.atan2(state.mouseY-host.y,state.mouseX-host.x);
                state.mindControl.hurlState={
                    projectile:hurled,vx:Math.cos(ang)*22,vy:Math.sin(ang)*22,
                    framesLeft:Math.ceil(800/22),hit:new Set([hurled])
                };
                hurled.stunned=999;
            } else {
                popup(host.x,host.y-40,'nothing to throw!','#888');
            }
            cd.q=400;
        }

        // ‚îÄ‚îÄ BOSS HOST ‚Üí RAMPAGE ‚îÄ‚îÄ
        else if(hostType==='boss'||host.isBoss){
            popup(host.x,host.y-60,'üëÅ RAMPAGE!','#ff0000',220);
            // Triple red rings
            for(let ri=0;ri<3;ri++)state.mcRings.push({cx:host.x,cy:host.y,r:ri*60,maxR:300+ri*80,timer:20,maxTimer:20,color:'#ff0000',lw:3+ri});
            for(let ring=0;ring<3;ring++){
                setTimeout(()=>{
                    if(!state.mindControl.active)return;
                    const SHOTS=20;
                    for(let i=0;i<SHOTS;i++){
                        const a=(i/SHOTS)*Math.PI*2+ring*0.2;
                        // Use player bullets (isMCBullet) so they can't hurt the host
                        const rb={x:host.x,y:host.y,vx:Math.cos(a)*6,vy:Math.sin(a)*6,
                            damage:p.damage*1.0,// nerfed from 1.5x; use player bullet format
                            life:180,size:8,isMCBullet:true,trackTarget:null,trackStrength:0,
                            draw(){ctx.fillStyle='#ff4400';ctx.shadowBlur=8;ctx.shadowColor='#ff8800';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}};
                        state.bullets.push(rb);
                    }
                    state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:200,timer:14,maxTimer:14,color:'#ff4400',lw:3});
                },ring*350);
            }
            const rageTargets=[...state.enemies.filter(e=>e!==host)];
            rageTargets.slice(0,4).forEach((e,i)=>{
                setTimeout(()=>{
                    if(!state.mindControl.active||!e||e.hp<=0)return;
                    const dmg=p.damage*5;// nerfed from 10x
                    e.hp=Math.max(0,e.hp-dmg);
                    spawnBlood(e.x,e.y,10);
                    popup(e.x,e.y-25,`üëÅ -${Math.floor(dmg)}`,'#ff0000',100);
                    if(e.hp<=0){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                },i*150+200);
            });
            cd.q=480;
        }

        // ‚îÄ‚îÄ UNKNOWN / FALLBACK ‚Üí MIND PULSE ‚îÄ‚îÄ
        else {
            popup(host.x,host.y-55,'üß† MIND PULSE!','#cc44ff',160);
            state.mcRings.push({cx:host.x,cy:host.y,r:0,maxR:300,timer:16,maxTimer:16,color:'#cc44ff',lw:3});
            const all4=[...state.enemies.filter(e=>e!==host)];if(state.boss)all4.push(state.boss);
            all4.forEach(e=>{const d=Math.sqrt((e.x-host.x)**2+(e.y-host.y)**2);if(d<300){e.hp=Math.max(0,e.hp-p.damage*4);spawnBlood(e.x,e.y,5);popup(e.x,e.y-20,`üß†-${Math.floor(p.damage*4)}`,'#cc44ff',80);if(!e.isBoss)e.confused=180;if(e.hp<=0){if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}else killEnemy(state.boss,-1);}}});
            cd.q=240;
        }

        updateHUD();
    }
}

// ‚îÄ‚îÄ HURL PROJECTILE UPDATE ‚Äî called every game tick inside gameStep ‚îÄ‚îÄ
function updateHurlState(){
    const hs=state.mindControl&&state.mindControl.hurlState;
    if(!hs)return;
    const proj=hs.projectile;
    if(!proj||proj.hp<=0||hs.framesLeft<=0){
        // Land the projectile
        if(proj&&proj.hp>0){
            proj.stunned=120;
            popup(proj.x,proj.y-30,'LANDED!','#ffcc44',80);
        }
        if(proj)proj.stunned=Math.max(proj.stunned||0,0);// unfreeze
        state.mindControl.hurlState=null;
        return;
    }
    // Move the hurled enemy
    proj.x+=hs.vx;proj.y+=hs.vy;
    proj.x=Math.max(0,Math.min(canvas.width,proj.x));
    proj.y=Math.max(0,Math.min(canvas.height,proj.y));
    proj.stunned=999;// keep frozen while flying
    hs.framesLeft--;
    // Collision damage to any enemy in path
    const colliders=[...state.enemies.filter(e=>e!==proj&&!hs.hit.has(e))];
    if(state.boss&&!hs.hit.has(state.boss))colliders.push(state.boss);
    colliders.forEach(e=>{
        const d=Math.sqrt((e.x-proj.x)**2+(e.y-proj.y)**2);
        if(d<35){
            hs.hit.add(e);
            const colDmg=state.player.damage*18*(e.isBoss?0.3:1);
            e.hp=Math.max(0,e.hp-colDmg);
            spawnBlood(e.x,e.y,12);
            popup(e.x,e.y-25,`üí• SMASH -${Math.floor(colDmg)}`,'#ffcc44',120);
            if(!e.isBoss)e.stunned=90;
            if(e.hp<=0){
                if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                else killEnemy(state.boss,-1);
            }
        }
    });
}

// ‚îÄ‚îÄ DAMAGE / KILL ‚îÄ‚îÄ
function killEnemy(e,idx){
    if(!e)return;
    if(state.mindControl.active&&e===state.mindControl.host){
        state.mindControl.active=false;e.isHost=false;
        state.player.x=e.x;state.player.y=e.y;state.player.hp=state.mindControl.savedHp;state.player.invul=120;
        popup(e.x,e.y-50,'NOGLIN FREE!','#ff00ff');
        document.getElementById('mindCtrlHud').classList.add('hidden');
        document.getElementById('mc-controls').style.display='none';
    } else {
        const xpV=e.isBoss?600:20;
        const xpCount=e.isBoss?12:1;
        for(let i=0;i<xpCount;i++)state.xpOrbs.push(new XpOrb(e.x+(Math.random()-.5)*50,e.y+(Math.random()-.5)*50,xpV));
        state.score+=e.isBoss?600:10;saveData.totalKills++;
        // Kira god gauge
        if(state.player&&state.player.config.id==='kira'){
            const gain=e.isBoss?5:1;
            state.player.godGauge=Math.min(state.player.godGaugeMax,(state.player.godGauge||0)+gain);
            if(state.player.godGauge>=state.player.godGaugeMax&&!state.player.godMode){
                state.player.godMode=true;popup(canvas.width/2,canvas.height/2-40,'‚ú® KIRA WINS ‚Äî GOD MODE ‚ú®','#ffd700',280);
            }
        }
    }
    if(e.isBoss){
        state.boss=null;
        const multGain=settings.difficulty>1?0.2:0.1;
        state.bossMultiplier=Math.min(3.0,(state.bossMultiplier||1)+multGain);
        if(state.pounce.active&&state.pounce.target===e){
            state.pounce.active=false;state.pounce.target=null;state.player.invul=60;
            state.pounce.healTick=0;
            document.getElementById('pounceIndicator').style.display='none';
        }
        popup(canvas.width/2,canvas.height/2-40,'BOSS SLAIN! +600','#ffd700',220);
        popup(canvas.width/2,canvas.height/2-20,`BOSS MULT NOW ${(state.bossMultiplier||1).toFixed(1)}x`,'#ff9900',200);
        document.getElementById('bossBar').classList.add('hidden');
        state.bossTimer=Math.max(1500,2400-state.lvl*20);
    }
}

function damagePlayer(amt){
    if(state.pounce.active)return;
    if(state.mindControl.active){state.mindControl.host.hp-=amt;return;}
    if(state.player.invul>0)return;
    state.player.hp-=amt;state.player.invul=65;
    // Subaru: gain madness when hit
    if(state.player.config.id==='subaru'){
        const gain=Math.min(15,amt*3);
        state.player.madnessMeter=Math.min(100,(state.player.madnessMeter||0)+gain);
        if(state.player.madnessMeter>=100)popup(state.player.x,state.player.y-70,'MADNESS FULL ‚Äî USE RETURN!','#aa44ff',120);
    }
    updateHUD();
    if(state.player.hp<=0){
        // Subaru: trigger return by death if checkpoint exists
        if(state.player.config.id==='subaru'&&state.subaru_checkpoint&&!state.player._returnedThisDeath){
            state.player._returnedThisDeath=true;
            const cp=state.subaru_checkpoint;
            state.player.x=cp.x;state.player.y=cp.y;
            state.player.hp=Math.max(1,Math.ceil(state.player.maxHp*0.5));
            state.player.invul=300;
            state.subaruCutscene={timer:160,maxTimer:160,type:'return'};
            const RETURN_LINES=['I WILL NOT GIVE UP! I RETURN BY DEATH!','...NOT YET. I STILL HAVE PEOPLE TO PROTECT.','STARTING OVER. I KNOW WHAT I NEED TO DO.','THEY TOOK EVERYTHING FROM ME. AGAIN.'];
            popup(state.player.x,state.player.y-80,RETURN_LINES[Math.floor(Math.random()*RETURN_LINES.length)],'#4488ff',280);
            popup(state.player.x,state.player.y-50,'üîÑ RETURN BY DEATH','#ffffff',260);
            state.player.madnessMeter=Math.min(100,(state.player.madnessMeter||0)+60);
            state.subaru_checkpoint=null;
            state.player._returnedThisDeath=false;
            updateHUD();
            return;
        }
        state.screen='GAMEOVER';
        if(state.score>saveData.highScore)saveData.highScore=state.score;
        saveGame();
        const fs=document.getElementById('finalScore');if(fs)fs.innerText=state.score;
        const DEATH_MSGS=[
            {h:"WASTED",s:"skill issue"},{h:"YOU DIED",s:"not even close"},{h:"COOKED",s:"absolutely cooked"},
            {h:"DEMOLISHED",s:"they didn't even try"},{h:"GONE",s:"poof. just like that."},
            {h:"L + RATIO",s:"you also fell off"},{h:"OUCH",s:"that looked painful"},
            {h:"YIKES",s:"we don't talk about this"},{h:"NO CAP YOU LOST",s:"very much cap"},
            {h:"ELIMINATED",s:"the enemies send their regards"},{h:"DELETED",s:"ctrl+z doesn't work here"},
            {h:"RIP BOZO",s:"rest in pepperoni"},{h:"TOUCH GRASS",s:"after this run though"},
            {h:"EMBARRASSING",s:"we've archived this footage"},{h:"VAPORIZED",s:"not even bones remained"},
            {h:"OK BYE",s:"they weren't ready for you... and neither were you"},
            {h:"MOMENT OF SILENCE",s:"...ok that's enough"},{h:"NOT LIKE THIS",s:"actually exactly like this"},
            {h:"CERTIFIED FAIL",s:"certificate of achievement: dying"},
            {h:"DONE COOKED",s:"well done, medium rare would've survived"},
            {h:"IT'S JOEVER",s:"the jo has been overed"},
        ];
        const dm=DEATH_MSGS[Math.floor(Math.random()*DEATH_MSGS.length)];
        const dh=document.getElementById('deathMsg'),ds=document.getElementById('deathSubMsg');
        if(dh)dh.innerText=dm.h;if(ds)ds.innerText=dm.s;
        document.getElementById('gameOverScreen').classList.remove('hidden');
    }
}

function updateBossBar(){
    if(!state.boss){document.getElementById('bossBar').classList.add('hidden');return;}
    document.getElementById('bossBar').classList.remove('hidden');
    document.getElementById('bossName').innerText=state.boss.bossName;
    document.getElementById('bossBarFill').style.width=(state.boss.hp/state.boss.maxHp*100)+'%';
    document.getElementById('bossBarFill').style.background=`linear-gradient(90deg,${state.boss.color}88,${state.boss.color})`;
}

// ‚îÄ‚îÄ FIXED-TIMESTEP GAME LOOP ‚îÄ‚îÄ
// All game logic runs in gameStep() at a fixed 60fps rate.
// Rendering runs every rAF frame.
// This means the game speed is CONSTANT regardless of monitor refresh rate,
// display scaling, or tab/window resize.

function gameStep(){
    // === ONE LOGIC TICK (equivalent to 1/60 second) ===
    if(state.screen !== 'PLAYING') return;

    state.frameCount++;
    // Cooldown ticking ‚Äî frozen for Zanther while pouncing, Shiba while coin is active
    const pounceActive=state.pounce.active&&state.player&&state.player.config.id==='tiger';
    const shibaCoinActive=state.player&&state.player.config.id==='shiba'&&state.bullets.some(b=>b instanceof CoinProjectile);
    const spinbotActive=state.spinbot&&state.player&&state.player.config.id==='coolioioio';
    const mcActive=state.mindControl.active&&state.player&&state.player.config.id==='noglin';
    if(!state.ability.ready){if(!pounceActive&&!spinbotActive&&!mcActive){state.ability.cooldown--;if(state.ability.cooldown<=0){state.ability.ready=true;updateHUD();}}}
    if(!state.secondary.ready){if(!shibaCoinActive&&!spinbotActive){state.secondary.cooldown--;if(state.secondary.cooldown<=0){state.secondary.ready=true;updateHUD();}}}
    // Update HUD cooldown display every 60 ticks (once per second) so timers don't freeze
    if(state.frameCount%60===0) updateHUD();
    // Health regen ‚Äî ticks every 5 seconds (300 frames). Each Regen upgrade adds ~6-35% of maxHp per 5s.
    if(state.player && state.player.regen > 0){
        state.player.regenTick = (state.player.regenTick||0) + 1;
        if(state.player.regenTick >= 300){
            state.player.regenTick = 0;
            if(state.player.hp < state.player.maxHp){
                const healAmt = Math.max(1, Math.round(state.player.regen * state.player.maxHp));
                state.player.hp = Math.min(state.player.maxHp, state.player.hp + healAmt);
                popup(state.player.x, state.player.y - 40, `+${healAmt} ‚ù§`, '#ff4466', 80);
                updateHUD();
            }
        }
    }
    if(state.effects.frozenTimer>0){state.effects.frozenTimer--;if(state.effects.frozenTimer<=0){state.effects.frozen=false;state.effects.frozenDamageMult=1;}}
    if(!state.boss){state.bossTimer--;if(state.bossTimer<=0)spawnBoss();}
    // Boss timer HUD update
    const btEl=document.getElementById('bossTimerDisplay');
    const bmEl=document.getElementById('bossMultDisplay');
    if(btEl){btEl.innerText=state.boss?'BOSS TIMER: -':'BOSS: '+Math.ceil(state.bossTimer/60)+'s';}
    if(bmEl){bmEl.innerText='HP MULT: '+(state.bossMultiplier||1).toFixed(1)+'x';}

    const maxEnemies=Math.min(96,40+state.lvl*2);
    const spawnRate=Math.max(12,80-state.lvl*2);
    if(state.frameCount%spawnRate===0&&state.enemies.length<maxEnemies){
        if(state.lvl>=10&&Math.random()<0.15){
            const e=new Enemy();e.maxHp*=2.5;e.hp=e.maxHp;e.speedBase*=1.4;e.meleeDmg*=2;e.type='üí•';
            state.enemies.push(e);
        } else {
            state.enemies.push(new Enemy());
        }
    }

    state.player.update();

    // Glorp beam logic
    if(state.glorpBeam){
        const gb=state.glorpBeam;gb.timer--;
        for(let i=state.enemies.length-1;i>=0;i--){
            const e=state.enemies[i];
            const t=((e.x-gb.sx)*gb.nx+(e.y-gb.sy)*gb.ny);
            if(t<0||t>gb.len)continue;
            const cx=gb.sx+gb.nx*t,cy=gb.sy+gb.ny*t;
            if(Math.sqrt((e.x-cx)**2+(e.y-cy)**2)<30){spawnBlood(e.x,e.y,8);popup(e.x,e.y-20,'GLORPED','#00ff44');killEnemy(e,i);state.enemies.splice(i,1);}
        }
        // Glorp hits boss too
        if(state.boss){const t=((state.boss.x-gb.sx)*gb.nx+(state.boss.y-gb.sy)*gb.ny);if(t>0&&t<gb.len){const cx=gb.sx+gb.nx*t,cy=gb.sy+gb.ny*t;if(Math.sqrt((state.boss.x-cx)**2+(state.boss.y-cy)**2)<40){const bd=state.player.damage*8;state.boss.hp=Math.max(0,state.boss.hp-bd);spawnBlood(state.boss.x,state.boss.y,10);popup(state.boss.x,state.boss.y-40,`GLORPED -${Math.floor(bd)}`,'#00ff44');updateBossBar();if(state.boss.hp<=0)killEnemy(state.boss,-1);}}}
        if(gb.timer===gb.maxTimer-1){
            state.enemies.forEach(e=>{const d=Math.sqrt((e.x-gb.sx)**2+(e.y-gb.sy)**2);if(d<200){e.confused=180;e.confuseTimer=0;}});
        }
        if(gb.timer<=0){
            state.player.x=Math.max(65,Math.min(canvas.width-65,state.mouseX));
            state.player.y=Math.max(65,Math.min(canvas.height-65,state.mouseY));
            state.player.invul=80;popup(state.player.x,state.player.y-30,'GLORP!','#00ff88');
            // Confuse all nearby enemies on arrival
            state.enemies.forEach(e=>{const d=Math.sqrt((e.x-state.player.x)**2+(e.y-state.player.y)**2);if(d<350){e.confused=300;e.confuseTimer=0;}});
            if(state.boss){const d=Math.sqrt((state.boss.x-state.player.x)**2+(state.boss.y-state.player.y)**2);if(d<350){state.boss.confused=180;}}
            state.glorpBeam=null;
        }
    }

    // Pounce
    if(state.pounce.active){
        const pt=state.pounce.target;
        if(!pt||pt.hp<=0){
            state.pounce.active=false;state.pounce.target=null;state.player.invul=60;
            state.pounce.healTick=0;
            document.getElementById('pounceIndicator').style.display='none';
        } else {
            if(pt.stunned<10)pt.stunned=10;state.player.x=pt.x;state.player.y=pt.y;
            state.pounce.damageTick--;
            if(state.pounce.damageTick<=0){
                const dmg=state.pounce.damage*(state.effects.frozen&&!pt.isBoss?state.effects.frozenDamageMult:1);
                pt.hp-=dmg;
                // heal: 1hp per 5 damage ticks (see below)
                spawnBlood(pt.x+(Math.random()-.5)*20,pt.y+(Math.random()-.5)*20,6);
                popup(pt.x+(Math.random()-.5)*25,pt.y-15,`-${Math.floor(dmg)}`,'#ff6600');
                if(heal>=1)popup(pt.x+(Math.random()-.5)*20,pt.y-30,`+${Math.floor(heal)}‚ù§`,'#ff4444',60);
                state.pounce.damageTick=22;
                state.pounce.healTick=(state.pounce.healTick||0)+1;
                if(state.pounce.healTick>=5&&state.player.hp<state.player.maxHp){
                    state.pounce.healTick=0;state.player.hp=Math.min(state.player.maxHp,state.player.hp+1);
                    popup(pt.x+(Math.random()-.5)*20,pt.y-30,'+1‚ù§','#ff4444',60);updateHUD();
                }
                if(pt.isBoss)updateBossBar();
            }
            if(state.frameCount%30===0){
                const AURA_LINES=["RUN!","HELP!","NOPE!","FLEE!","AAAA!","TOO SCARY","WHY","RETREAT","TIGER!!","NOT TODAY"];
                state.enemies.forEach(e=>{if(e!==pt){const d=Math.sqrt((e.x-pt.x)**2+(e.y-pt.y)**2);if(d<900){e.fleeing=true;e.fleeTimer=Math.max(e.fleeTimer,100);if(Math.random()<0.3)popup(e.x,e.y-20,AURA_LINES[Math.floor(Math.random()*AURA_LINES.length)],'#ffcc88',80);}}});
                if(state.boss&&state.boss!==pt){const d=Math.sqrt((state.boss.x-pt.x)**2+(state.boss.y-pt.y)**2);if(d<600){state.boss.fleeing=true;state.boss.fleeTimer=Math.max(state.boss.fleeTimer,80);}}
            }
            // heal handled per damage tick
            state.pounce.timer--;
            if(state.pounce.timer<=0||pt.hp<=0){
                if(pt.hp<=0){
                    const ii=state.enemies.indexOf(pt);
                    if(ii!==-1){killEnemy(pt,ii);state.enemies.splice(ii,1);}
                    else if(pt===state.boss&&state.boss){killEnemy(state.boss,-1);}
                    // Frenzy!
                    state.player._frenzyTimer=120;state.player._frenzyDmgMult=5;state.player._frenzyAtkMult=4;
                    const baseAtk=state.player.config.id==='coolioioio'?22:45;
                    state.player._frenzyAtkBase=state.player.atkSpeed;
                    state.player.atkSpeed=Math.max(3,Math.floor(state.player.atkSpeed/4));
                    popup(state.player.x,state.player.y-60,'üêØ FRENZY! 5x DMG!','#ff4400',180);
                }
                state.pounce.active=false;state.pounce.target=null;state.player.invul=60;
                state.pounce.healTick=0;
                document.getElementById('pounceIndicator').style.display='none';
            }
        }
    }

    // Spinbot
    if(state.spinbot){
        state.spinbot.timer--;
        state.spinbot.shootTick--;
        state.spinbot.angle+=0.18;
        if(state.spinbot.shootTick<=0){
            state.spinbot.shootTick=6;
            const p=state.player;
            if(state.bullets.length>300)state.bullets.splice(0,state.bullets.length-200);
            let nearest=null,nearDist=Infinity;
            state.enemies.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<nearDist){nearDist=d;nearest=e;}});
            if(!nearest&&state.boss)nearest=state.boss;
            let baseAng;
            if(settings.abilityTarget==='manual'){
                baseAng=Math.atan2(state.mouseY-p.y,state.mouseX-p.x);
            } else {
                baseAng=nearest?Math.atan2(nearest.y-p.y,nearest.x-p.x):0;
            }
            for(let si=0;si<12;si++){
                const randomAng=Math.random()*Math.PI*2;
                const finalAng=nearest?baseAng+(randomAng-baseAng)*(1-0.4)+(Math.random()-.5)*2.5:randomAng;
                const isCrit=Math.random()*100<p.crit;
                const b=new Bullet(p.x,p.y,finalAng,p.damage*0.05*(isCrit?2:1),p.bSize+4,isCrit,1);
                state.bullets.push(b);
            }
        }
        if(state.spinbot.timer<=0)state.spinbot=null;
    }

    // ‚îÄ‚îÄ ZANTHER: Frenzy timer ‚îÄ‚îÄ
    if(state.player&&state.player._frenzyTimer>0){
        state.player._frenzyTimer--;
        if(state.player._frenzyTimer<=0&&state.player._frenzyAtkBase){
            state.player.atkSpeed=state.player._frenzyAtkBase;
            state.player._frenzyDmgMult=1;state.player._frenzyAtkMult=1;
        }
    }
    // ‚îÄ‚îÄ KIRA: Death Note countdown ‚îÄ‚îÄ
    if(state.player&&state.player.config.id==='kira'){
        state.deathNoteTargets=state.deathNoteTargets||[];
        for(let i=state.deathNoteTargets.length-1;i>=0;i--){
            const dn=state.deathNoteTargets[i];
            // If boss was condemned but boss is gone, remove entry
            if(dn.isBoss&&!state.boss){state.deathNoteTargets.splice(i,1);continue;}
            // Keep enemy reference live for boss (boss object stays same)
            if(dn.isBoss)dn.enemy=state.boss;
            dn.timer--;
            const secs=Math.ceil(dn.timer/60);
            // Show countdown popups every second
            if(state.frameCount%60===0&&dn.timer>0&&dn.timer<180){
                popup(dn.enemy.x,dn.enemy.y-40,secs+'...','#ff4444',70);
            }
            // Remove if target already dead (non-boss)
            if(!dn.isBoss&&dn.enemy.hp<=0){state.deathNoteTargets.splice(i,1);continue;}
            if(dn.timer<=0){
                if(dn.isBoss&&state.boss){
                    const dmg=dn.dmg;
                    state.boss.hp=Math.max(0,state.boss.hp-dmg);
                    spawnBlood(state.boss.x,state.boss.y,18);
                    popup(state.boss.x,state.boss.y-50,'‚úç WRITTEN. ‚úç','#ffd700',200);
                    popup(state.boss.x,state.boss.y-75,`-${Math.floor(dmg)} DEATH NOTE`,'#cc0000',220);
                    updateBossBar();
                    if(state.boss.hp<=0){killEnemy(state.boss,-1);}
                } else if(!dn.isBoss&&dn.enemy.hp>0){
                    const dmg=dn.dmg;
                    dn.enemy.hp=Math.max(0,dn.enemy.hp-dmg);
                    spawnBlood(dn.enemy.x,dn.enemy.y,18);
                    popup(dn.enemy.x,dn.enemy.y-50,'‚úç WRITTEN. ‚úç','#ffd700',200);
                    const idx=state.enemies.indexOf(dn.enemy);
                    if(idx!==-1){killEnemy(dn.enemy,idx);state.enemies.splice(idx,1);}
                }
                state.deathNoteTargets.splice(i,1);
            }
        }
        // God Gauge display handled in render
        // Kira cutscene tick
        if(state.kiraCutscene){state.kiraCutscene.timer--;if(state.kiraCutscene.timer<=0)state.kiraCutscene=null;}
    }

    // ‚îÄ‚îÄ FEMBOY: Charm logic + twirl ‚îÄ‚îÄ
    if(state.player&&state.player.config.id==='femboy'){
        const p=state.player;
        state.charmedEnemies=state.charmedEnemies||[];
        // Charmed enemy AI: they attack other enemies
        for(let i=state.charmedEnemies.length-1;i>=0;i--){
            const c=state.charmedEnemies[i];
            c.timer--;
            c.enemy.charmed=c.timer;
            if(c.timer<=0||c.enemy.hp<=0){state.charmedEnemies.splice(i,1);if(c.enemy)c.enemy.charmed=0;continue;}
            // Charmed enemy attacks the nearest un-charmed enemy
            const charmedSet=new Set(state.charmedEnemies.map(x=>x.enemy));
            let victim=null,vd=Infinity;
            state.enemies.forEach(e=>{if(e===c.enemy||charmedSet.has(e))return;const d=Math.sqrt((e.x-c.enemy.x)**2+(e.y-c.enemy.y)**2);if(d<vd){vd=d;victim=e;}});
            if(victim&&vd<30&&state.frameCount%45===0){
                victim.hp=Math.max(0,victim.hp-p.damage*2);
                popup(victim.x,victim.y-20,'üíï BETRAYAL','#ff88cc',100);
                spawnBlood(victim.x,victim.y,4);
                if(victim.hp<=0){const vi=state.enemies.indexOf(victim);if(vi!==-1){killEnemy(victim,vi);state.enemies.splice(vi,1);}}
            }
        }
        // Twirl
        if(state.twirl){
            state.twirl.timer--;
            state.twirl.angle+=0.25;
            state.twirl.damageTick=(state.twirl.damageTick||0)+1;
            if(state.twirl.damageTick>=10){
                state.twirl.damageTick=0;
                const RANGE=220;
                state.enemies.forEach(e=>{
                    const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);
                    if(d<RANGE){
                        const dmg=p.damage*1.5;e.hp=Math.max(0,e.hp-dmg);
                        spawnBlood(e.x,e.y,3);
                        popup(e.x,e.y-20,`‚ú®-${Math.floor(dmg)}`,'#ff88cc',70);
                        if(e.hp<=0){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                    }
                });
                if(state.boss){const d=Math.sqrt((state.boss.x-p.x)**2+(state.boss.y-p.y)**2);if(d<RANGE){const dmg=p.damage*1.5;state.boss.hp=Math.max(0,state.boss.hp-dmg);popup(state.boss.x,state.boss.y-40,`‚ú®-${Math.floor(dmg)}`,'#ff88cc',70);if(state.boss.hp<=0)killEnemy(state.boss,-1);}}
            }
            if(state.twirl.timer<=0)state.twirl=null;
        }
    }

    // ‚îÄ‚îÄ PICKLE: Pickle Dash update ‚îÄ‚îÄ
    if(state.pickleDash&&state.pickleDash.active){
        const pd=state.pickleDash;
        pd.delay--;
        // Only add trail while still hopping between targets
        const stillDashing=pd.targetIdx<pd.targets.length||(pd.delay>0&&pd.targetIdx<pd.targets.length);
        if(stillDashing&&state.player)pd.trail.push({x:state.player.x,y:state.player.y,life:25,maxLife:25});
        // Decay trail
        for(let i=pd.trail.length-1;i>=0;i--){pd.trail[i].life--;if(pd.trail[i].life<=0)pd.trail.splice(i,1);}
        // Process next target
        if(pd.delay<=0&&pd.targetIdx<pd.targets.length){
            const e=pd.targets[pd.targetIdx];
            pd.targetIdx++;
            pd.delay=5;// frames between each dash hop
            if(e&&e.hp>0){
                state.player.x=e.x;state.player.y=e.y;state.player.invul=20;
                const dmg=pd.dmg;e.hp=Math.max(0,e.hp-dmg);
                spawnBlood(e.x,e.y,10);
                popup(e.x,e.y-20,`ü•í -${Math.floor(dmg)}`,'#44cc00',120);
                // Burst of green particles - add to trail as burst type
                for(let gi=0;gi<6;gi++){
                    const a=Math.random()*Math.PI*2,s=3+Math.random()*5;
                    pd.trail.push({x:e.x+Math.cos(a)*10,y:e.y+Math.sin(a)*10,life:20,maxLife:20,burst:true,vx:Math.cos(a)*s,vy:Math.sin(a)*s});
                }
                // Leave poison
                state.picklePoisons=state.picklePoisons||[];
                const existing=state.picklePoisons.find(pp=>pp.enemy===e);
                if(existing){existing.timer=Math.max(existing.timer,360);}
                else{state.picklePoisons.push({enemy:e,timer:360,dps:state.player.damage*0.3,tickTimer:0});}
                // Kill if dead
                if(e.hp<=0){
                    if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                    else{killEnemy(state.boss,-1);}
                }
            }
        }
        // Update burst particles movement
        pd.trail.forEach(t=>{if(t.burst){t.x+=t.vx;t.y+=t.vy;t.vx*=0.85;t.vy*=0.85;}});
        // Done when all targets hit and trail fully faded
        if(pd.targetIdx>=pd.targets.length&&pd.trail.length===0){
            state.pickleDash=null;
        }
    }

    // ‚îÄ‚îÄ PICKLE: Poison tick ‚îÄ‚îÄ
    if(state.player&&state.player.config.id==='pickle'){
        state.picklePoisons=state.picklePoisons||[];
        for(let i=state.picklePoisons.length-1;i>=0;i--){
            const pp=state.picklePoisons[i];
            if(pp.enemy.hp<=0){state.picklePoisons.splice(i,1);continue;}
            pp.timer--;
            pp.tickTimer=(pp.tickTimer||0)+1;
            if(pp.tickTimer>=30){// tick every 0.5s
                pp.tickTimer=0;
                pp.enemy.hp=Math.max(0,pp.enemy.hp-pp.dps);
                popup(pp.enemy.x,pp.enemy.y-20,'ü•í -'+Math.floor(pp.dps),'#44cc00',50);
                if(pp.enemy.hp<=0){
                    if(!pp.enemy.isBoss){const ei=state.enemies.indexOf(pp.enemy);if(ei!==-1){killEnemy(pp.enemy,ei);state.enemies.splice(ei,1);}}
                    else killEnemy(state.boss,-1);
                    state.picklePoisons.splice(i,1);continue;
                }
                if(pp.enemy.isBoss)updateBossBar();
            }
            if(pp.timer<=0)state.picklePoisons.splice(i,1);
        }
    }

    // MC ability cooldowns
    if(state.mindControl.active||state.player.config.id==='noglin'){
        const cd=state.mcAbilityCooldowns;
        if(cd.q>0)cd.q--;if(cd.e>0)cd.e--;if(cd.f>0)cd.f--;
        // Update HUD every second so Q cooldown timer refreshes in cooldown-display
        if(state.mindControl.active&&state.frameCount%60===0)updateHUD();
    }

    // ‚îÄ‚îÄ HURL projectile physics ‚îÄ‚îÄ
    if(state.mindControl&&state.mindControl.active&&state.mindControl.hurlState)updateHurlState();

    // ‚îÄ‚îÄ SOUL VORTEX pull ‚îÄ‚îÄ
    if(state.mindControl&&state.mindControl.active&&state.mindControl.vortexTimer>0){
        state.mindControl.vortexTimer--;
        const vx=state.mindControl.vortexX,vy=state.mindControl.vortexY;
        const PULL_RANGE=600,PULL_FORCE=5;
        const VORTEX_DMG=state.player.damage*0.3;
        const allV=[...state.enemies];if(state.boss)allV.push(state.boss);
        allV.forEach(e=>{
            if(e===state.mindControl.host)return;
            const dx=vx-e.x,dy=vy-e.y,d=Math.sqrt(dx*dx+dy*dy)||1;
            if(d<PULL_RANGE){
                e.x+=dx/d*PULL_FORCE*(1-d/PULL_RANGE)*3;
                e.y+=dy/d*PULL_FORCE*(1-d/PULL_RANGE)*3;
                // Damage tick every 10 frames
                if(state.frameCount%10===0){
                    e.hp=Math.max(0,e.hp-VORTEX_DMG*(e.isBoss?0.15:1));
                    if(e.hp<=0){
                        if(!e.isBoss){const ei=state.enemies.indexOf(e);if(ei!==-1){killEnemy(e,ei);state.enemies.splice(ei,1);}}
                        else killEnemy(state.boss,-1);
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ BLAHBLAHBLAH: Word Barrage ‚îÄ‚îÄ
    if(state.blahBarrage){
        const bb=state.blahBarrage;
        bb.timer--;bb.shootTick--;
        if(bb.shootTick<=0){
            bb.shootTick=4;
            const p=state.player;
            const WORDS=['NAKAMA!','BELIEVE IT!','PLUS ULTRA!','BANKAI!','SHANNARO!','GOMU GOMU!','KAMEHAMEHA!','SENPAI!','NANI?!','SUGOI!'];
            // Re-acquire target
            const all=[...state.enemies];if(state.boss)all.push(state.boss);
            let tgt=bb.target;
            if(!tgt||tgt.hp<=0){let td=Infinity;all.forEach(e=>{const d=Math.sqrt((e.x-p.x)**2+(e.y-p.y)**2);if(d<td){td=d;tgt=e;}});}
            bb.target=tgt;
            if(tgt){
                const spread=(Math.random()-.5)*0.4;
                const ang=Math.atan2(tgt.y-p.y,tgt.x-p.x)+spread;
                const wb={x:p.x,y:p.y,vx:Math.cos(ang)*18,vy:Math.sin(ang)*18,damage:p.damage*1.8,life:70,word:WORDS[Math.floor(Math.random()*WORDS.length)],size:7};
                state.bullets.push(wb);
                // Stun on hit handled in update
            }
        }
        // Cutscene timer
        if(state.blahCutscene){state.blahCutscene.timer--;if(state.blahCutscene.timer<=0)state.blahCutscene=null;}
        if(bb.timer<=0)state.blahBarrage=null;
    }
    if(state.blahCutscene&&!state.blahBarrage){state.blahCutscene.timer--;if(state.blahCutscene.timer<=0)state.blahCutscene=null;}

    // ‚îÄ‚îÄ SUBARU: Madness meter (gains on taking damage), death checkpoint, cutscene ‚îÄ‚îÄ
    if(state.player&&state.player.config.id==='subaru'){
        const p=state.player;
        if(state.subaruCutscene){state.subaruCutscene.timer--;if(state.subaruCutscene.timer<=0)state.subaruCutscene=null;}
        // Return by death: if HP would reach 0, teleport to checkpoint instead
        if(p.hp<=0&&state.subaru_checkpoint&&!p._returnedThisDeath){
            p._returnedThisDeath=true;
            const cp=state.subaru_checkpoint;
            p.x=cp.x;p.y=cp.y;p.hp=Math.ceil(cp.hp*0.5);// return with half HP
            p.invul=300;
            state.subaruCutscene={timer:160,maxTimer:160,type:'return'};
            const RETURN_LINES=['I WILL NOT GIVE UP! I RETURN BY DEATH!','...NOT YET. I STILL HAVE PEOPLE TO PROTECT.','STARTING OVER. I KNOW WHAT I NEED TO DO.','THEY TOOK EVERYTHING FROM ME. AGAIN.'];
            popup(p.x,p.y-80,RETURN_LINES[Math.floor(Math.random()*RETURN_LINES.length)],'#4488ff',280);
            popup(p.x,p.y-50,'üîÑ RETURN BY DEATH','#ffffff',260);
            // Gain massive madness from the trauma
            p.madnessMeter=Math.min(100,(p.madnessMeter||0)+60);
            state.subaru_checkpoint=null;// checkpoint consumed
            p._returnedThisDeath=false;
            updateHUD();
        }
        // Madness bar render trigger (done in render)
    }

    // Player bullets
    for(let i=state.bullets.length-1;i>=0;i--){
        const b=state.bullets[i];
        if(b instanceof PiercingBullet){b.update();if(b.life<=0||b.isDone){state.bullets.splice(i,1);}continue;}
        if(b instanceof IcicleProjectile||b instanceof CoinProjectile){b.update();if(b.life<=0){state.bullets.splice(i,1);}continue;}
        // MC homing bullet (Volley from shooter host)
        if(b.isMCBullet){
            if(b.trackTarget&&b.trackTarget.hp>0){
                const dx=b.trackTarget.x-b.x,dy=b.trackTarget.y-b.y,d=Math.sqrt(dx*dx+dy*dy)||1;
                b.vx+=dx/d*b.trackStrength;b.vy+=dy/d*b.trackStrength;
                const spd=Math.sqrt(b.vx*b.vx+b.vy*b.vy);if(spd>14){b.vx=b.vx/spd*14;b.vy=b.vy/spd*14;}
            }
            b.x+=b.vx;b.y+=b.vy;b.life--;if(b.life<=0){state.bullets.splice(i,1);}continue;
        }
        // Word bullet (plain object with .word)
        if(b.word){b.x+=b.vx;b.y+=b.vy;b.life--;if(b.life<=0){state.bullets.splice(i,1);}continue;}
        b.update();if(b.life<=0){state.bullets.splice(i,1);}
    }

    // Confused enemies attack each other
    if(state.frameCount%30===0){
        state.enemies.forEach(e=>{
            if(e.confused>0&&!e.charmed){
                // Attack nearest non-confused non-host enemy
                state.enemies.forEach(v=>{
                    if(v===e||v.confused>0)return;
                    const d=Math.sqrt((v.x-e.x)**2+(v.y-e.y)**2);
                    if(d<30&&e.meleeDmg>0){v.hp=Math.max(0,v.hp-(e.meleeDmg||1));spawnBlood(v.x,v.y,2);if(v.hp<=0){const vi=state.enemies.indexOf(v);if(vi!==-1){killEnemy(v,vi);state.enemies.splice(vi,1);}}}
                });
            }
        });
    }
    // Enemies
    for(let i=state.enemies.length-1;i>=0;i--){
        const e=state.enemies[i];
        if(e.hp<=0&&!e.isHost){killEnemy(e,i);if(i<state.enemies.length)state.enemies.splice(i,1);continue;}
        e.update();
        const isHost=state.mindControl.active&&e===state.mindControl.host;
        let killed=false;
        for(let bi=state.bullets.length-1;bi>=0;bi--){
            const b=state.bullets[bi];
            if(b instanceof CoinProjectile||b instanceof PiercingBullet)continue;
            // MC homing bullets always skip the host but can hit all other enemies
            if(b.isMCBullet){
                const hitR=(b.size||8)+22;// bigger hitbox for MC abilities
                if(!isHost&&Math.sqrt((e.x-b.x)**2+(e.y-b.y)**2)<hitR){
                    let dmg=b.damage*(state.effects.frozen&&!e.isBoss?state.effects.frozenDamageMult:1);
                    e.hp-=dmg;state.bullets.splice(bi,1);spawnBlood(e.x,e.y,4);
                    if(e.hp<=0){killEnemy(e,i);if(i<state.enemies.length)state.enemies.splice(i,1);killed=true;break;}
                }
                continue;
            }
            if(isHost)continue;
            const hitR=(b.size||8)+(b instanceof IcicleProjectile?10:state.mindControl.active?22:14);
            if(Math.sqrt((e.x-b.x)**2+(e.y-b.y)**2)<hitR){
                let dmg=b.damage*(state.effects.frozen&&!e.isBoss?state.effects.frozenDamageMult:1);
                e.hp-=dmg;state.bullets.splice(bi,1);spawnBlood(e.x,e.y,4);
                if(b instanceof IcicleProjectile&&!e.isBoss){e.stunned=Math.max(e.stunned,180);popup(e.x,e.y-20,'‚ùÑ FROZEN!','#aaeeff');}
                if(b.word){e.stunned=Math.max(e.stunned||0,30);popup(e.x,e.y-20,b.word,'#cc44ff',60);}
                if(b.crit)popup(e.x,e.y-15,'CRIT!','#ffd700');
                if(e.hp<=0){killEnemy(e,i);if(i<state.enemies.length)state.enemies.splice(i,1);killed=true;break;}
                break;
            }
        }
        if(killed)continue;
        const tgtX=state.mindControl.active?state.mindControl.host.x:state.player.x;
        const tgtY=state.mindControl.active?state.mindControl.host.y:state.player.y;
        const dd=Math.sqrt((e.x-tgtX)**2+(e.y-tgtY)**2);
        if(dd<28&&e.meleeCooldown<=0&&e.meleeDmg>0&&!e.charmed){damagePlayer(e.meleeDmg);e.meleeCooldown=50;}
    }

    // Boss logic
    if(state.boss){
        state.boss.update();
        // Skip bullet collision if this boss is being mind-controlled (would hit yourself)
        const bossIsHost = state.mindControl.active && state.mindControl.host === state.boss;
        if(!bossIsHost){
            for(let bi=state.bullets.length-1;bi>=0&&state.boss;bi--){
                const b=state.bullets[bi];if(b instanceof CoinProjectile||b instanceof PiercingBullet)continue;
                const hr=(b.size||8)+(b instanceof IcicleProjectile?10:28);
                if(Math.sqrt((state.boss.x-b.x)**2+(state.boss.y-b.y)**2)<hr){
                    let dmg=b.damage*(state.effects.frozen?state.effects.frozenDamageMult:1);
                    state.boss.hp-=dmg;state.bullets.splice(bi,1);spawnBlood(state.boss.x,state.boss.y,5);
                    if(state.boss.hp<=0){killEnemy(state.boss,-1);}else updateBossBar();break;
                }
            }
        }
        if(state.boss){
            const tgtX=state.mindControl.active?state.mindControl.host.x:state.player.x;
            const tgtY=state.mindControl.active?state.mindControl.host.y:state.player.y;
            const bdd=Math.sqrt((state.boss.x-tgtX)**2+(state.boss.y-tgtY)**2);
            if(bdd<44&&state.boss.meleeCooldown<=0&&!bossIsHost){damagePlayer(state.boss.meleeDmg);state.boss.meleeCooldown=55;}
        }
    }

    // Enemy bullets ‚Äî skip ones fired by the host itself hitting itself
    for(let i=state.enemyBullets.length-1;i>=0;i--){
        const b=state.enemyBullets[i];b.update();
        if(b.life<=0){state.enemyBullets.splice(i,1);continue;}
        // During MC, enemy bullets hit the host position ‚Äî only damage if bullet didn't come from the host
        if(state.mindControl.active){
            const h=state.mindControl.host;
            if(Math.sqrt((b.x-h.x)**2+(b.y-h.y)**2)<b.size+16&&!b.fromHost){
                damagePlayer(b.damage);state.enemyBullets.splice(i,1);
            }
            continue;
        }
        if(Math.sqrt((b.x-state.player.x)**2+(b.y-state.player.y)**2)<b.size+16){damagePlayer(b.damage);state.enemyBullets.splice(i,1);}
    }
    for(let i=state.xpOrbs.length-1;i>=0;i--){
        const o=state.xpOrbs[i];o.update();
        if(Math.sqrt((o.x-state.player.x)**2+(o.y-state.player.y)**2)<20){
            state.xp+=o.val*state.player.xpMult;state.xpOrbs.splice(i,1);
            if(state.xp>=state.xpNeeded){state.xp=0;state.lvl++;state.xpNeeded=Math.floor(state.xpNeeded*1.2);showLevelUp();}
            updateHUD();
        }
    }

    // ‚îÄ‚îÄ MC ring visual effects tick ‚îÄ‚îÄ
    if(state.mcRings&&state.mcRings.length){for(let i=state.mcRings.length-1;i>=0;i--){const rr=state.mcRings[i];rr.timer--;if(rr.timer<=0)state.mcRings.splice(i,1);}}

    // Particles
    for(let i=state.particles.length-1;i>=0;i--){state.particles[i].update();if(state.particles[i].life<=0)state.particles.splice(i,1);}
    // Mind control host death check
    if(state.mindControl.active&&state.mindControl.host.hp<=0){
        const h=state.mindControl.host,idx=state.enemies.indexOf(h);
        killEnemy(h,idx);if(idx!==-1)state.enemies.splice(idx,1);else if(h===state.boss)state.boss=null;
    }
}

function gameRender(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const grad=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,Math.max(canvas.width,canvas.height));
    grad.addColorStop(0,'#1a0b2e');grad.addColorStop(1,'#050112');
    ctx.fillStyle=grad;ctx.fillRect(0,0,canvas.width,canvas.height);

    const BORDER=60;
    ctx.save();
    // Outer glow border
    ctx.strokeStyle='rgba(0,180,255,0.25)';ctx.lineWidth=BORDER*2;
    ctx.strokeRect(BORDER,BORDER,canvas.width-BORDER*2,canvas.height-BORDER*2);
    // Animated pulse border
    const bPulse=0.5+0.5*Math.sin(state.frameCount*0.04);
    ctx.strokeStyle=`rgba(0,242,255,${0.55+bPulse*0.3})`;ctx.lineWidth=3;
    ctx.shadowBlur=12+bPulse*8;ctx.shadowColor='#00f2ff';
    ctx.strokeRect(BORDER,BORDER,canvas.width-BORDER*2,canvas.height-BORDER*2);
    // Corner brackets
    const cL=40;
    [BORDER,canvas.width-BORDER].forEach((bx,xi)=>{
        [BORDER,canvas.height-BORDER].forEach((by,yi)=>{
            const sx=xi===0?1:-1,sy=yi===0?1:-1;
            ctx.strokeStyle=`rgba(0,255,200,${0.7+bPulse*0.3})`;ctx.lineWidth=3;ctx.shadowBlur=16;ctx.shadowColor='#00ffe0';
            ctx.beginPath();ctx.moveTo(bx,by+sy*cL);ctx.lineTo(bx,by);ctx.lineTo(bx+sx*cL,by);ctx.stroke();
        });
    });
    ctx.shadowBlur=0;ctx.restore();

    if(state.screen==='PLAYING'||state.screen==='LEVELUP'||state.screen==='PAUSED'){
        // Global freeze overlay
        if(state.effects.frozen){
            ctx.save();ctx.fillStyle='rgba(136,200,255,0.07)';ctx.fillRect(0,0,canvas.width,canvas.height);
            const pulse=0.5+0.5*Math.sin(state.frameCount*0.15);
            ctx.strokeStyle=`rgba(136,238,255,${0.3+pulse*0.25})`;ctx.lineWidth=3+pulse*2;
            ctx.strokeRect(2,2,canvas.width-4,canvas.height-4);ctx.restore();
        }

        state.player.draw();

        // Glorp beam render
        if(state.glorpBeam){
            const gb=state.glorpBeam;
            const a=gb.timer/gb.maxTimer;
            ctx.save();ctx.globalAlpha=a;ctx.strokeStyle=`rgba(0,255,80,${a})`;ctx.lineWidth=12+a*8;ctx.shadowBlur=30;ctx.shadowColor='#00ff44';
            ctx.beginPath();ctx.moveTo(gb.sx,gb.sy);ctx.lineTo(gb.ex,gb.ey);ctx.stroke();
            ctx.lineWidth=3;ctx.strokeStyle='#aaffcc';ctx.stroke();ctx.restore();
        }

        // Pounce player render
        if(state.pounce.active&&state.pounce.target){
            const pt=state.pounce.target;
            ctx.save();
            if(state.player.config.emojiFilter){
                const oc=getFilteredEmojiCanvas(state.player.config.emoji,state.player.config.emojiFilter,38);
                ctx.drawImage(oc,pt.x-oc.width/2,pt.y-oc.height/2);
            } else {
                ctx.font='38px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(state.player.config.emoji,pt.x,pt.y);
            }
            ctx.restore();
        }

        // Mini beams
        if(state.miniBeams&&state.miniBeams.length){
            for(let i=state.miniBeams.length-1;i>=0;i--){
                const mb=state.miniBeams[i];
                const a=mb.timer/mb.maxTimer;
                ctx.save();ctx.globalAlpha=a*0.7;ctx.strokeStyle='rgba(0,255,100,'+a+')';ctx.lineWidth=5+a*4;ctx.shadowBlur=14;ctx.shadowColor='#00ff44';
                ctx.beginPath();ctx.moveTo(mb.sx,mb.sy);ctx.lineTo(mb.ex,mb.ey);ctx.stroke();ctx.restore();
                mb.timer--;if(mb.timer<=0)state.miniBeams.splice(i,1);
            }
        }

        // ‚îÄ‚îÄ MC ability ring visual effects ‚îÄ‚îÄ
        if(state.mcRings&&state.mcRings.length){
            ctx.save();
            for(const rr of state.mcRings){
                const progress=1-rr.timer/rr.maxTimer;
                // Support inward rings (start big, shrink to 0)
                const curR=rr.inward?rr.r*(1-progress):rr.r+(rr.maxR-rr.r)*progress;
                const alpha=rr.timer/rr.maxTimer;
                ctx.strokeStyle=rr.color;ctx.lineWidth=rr.lw;
                ctx.globalAlpha=alpha*0.85;ctx.shadowBlur=16;ctx.shadowColor=rr.color;
                ctx.beginPath();ctx.arc(rr.cx,rr.cy,Math.max(1,curR),0,Math.PI*2);ctx.stroke();
            }
            ctx.globalAlpha=1;ctx.shadowBlur=0;ctx.restore();
        }

        // Player bullets
        for(const b of state.bullets){if(!b.word)b.draw();}

        // ‚îÄ‚îÄ KIRA: draw death note overlay on condemned enemies ‚îÄ‚îÄ
        if(state.player&&state.player.config.id==='kira'){
            (state.deathNoteTargets||[]).forEach(dn=>{
                const e=dn.enemy;if(!e)return;
                const secs=Math.ceil(dn.timer/60);
                const pulse=0.5+0.5*Math.sin(state.frameCount*0.3);
                const r=dn.isBoss?55+pulse*12:22+pulse*5;
                ctx.save();
                // Outer pulsing ring
                ctx.strokeStyle=`rgba(204,0,0,${0.5+pulse*0.5})`;ctx.lineWidth=dn.isBoss?5:3;
                ctx.shadowBlur=dn.isBoss?24:14;ctx.shadowColor='#cc0000';
                ctx.beginPath();ctx.arc(e.x,e.y,r,0,Math.PI*2);ctx.stroke();
                // Second ring for boss
                if(dn.isBoss){
                    ctx.strokeStyle=`rgba(255,220,0,${0.3+pulse*0.4})`;ctx.lineWidth=2;
                    ctx.beginPath();ctx.arc(e.x,e.y,r*0.7,0,Math.PI*2);ctx.stroke();
                    // Rotating tick marks around boss
                    for(let ti=0;ti<6;ti++){
                        const ta=(ti/6)*Math.PI*2+state.frameCount*0.04;
                        const ix=e.x+Math.cos(ta)*(r+10),iy=e.y+Math.sin(ta)*(r+10);
                        ctx.fillStyle=`rgba(204,0,0,${0.6+pulse*0.4})`;
                        ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
                        ctx.fillText('‚úç',ix,iy);
                    }
                }
                // Countdown text
                ctx.font=`${dn.isBoss?16:10}px "Press Start 2P"`;ctx.fillStyle='#ff4444';ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.shadowBlur=8;ctx.shadowColor='#ff0000';
                ctx.fillText(secs+'s',e.x,e.y-(r+16));
                ctx.restore();
            });
            // Kira god gauge bar
            const p=state.player;
            if(p.godGauge>0||p.godMode){
                ctx.save();
                const bw=120,bh=10,bx=p.x-bw/2,by=p.y+38;
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(bx,by,bw,bh);
                const pct=p.godMode?1:(p.godGauge/p.godGaugeMax);
                ctx.fillStyle=p.godMode?'#ffd700':'#cc0000';
                ctx.shadowBlur=p.godMode?14:0;ctx.shadowColor='#ffd700';
                ctx.fillRect(bx,by,bw*pct,bh);
                ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,bh);
                if(p.godMode){ctx.font='7px "Press Start 2P"';ctx.fillStyle='#ffd700';ctx.textAlign='center';ctx.fillText('GOD MODE',p.x,by+bh+10);}
                ctx.restore();
            }
        }

        // ‚îÄ‚îÄ FEMBOY: twirl render ‚îÄ‚îÄ
        if(state.twirl&&state.player){
            const p=state.player;const a=state.twirl.timer/180;
            ctx.save();ctx.globalAlpha=a*0.35;
            for(let i=0;i<8;i++){
                const ang=(i/8)*Math.PI*2+state.twirl.angle;
                const rx=p.x+Math.cos(ang)*110,ry=p.y+Math.sin(ang)*110;
                ctx.fillStyle='#ff88cc';ctx.shadowBlur=12;ctx.shadowColor='#ff44aa';
                ctx.font='16px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.fillText('‚ú®',rx,ry);
            }
            ctx.globalAlpha=1;ctx.restore();
        }

        // ‚îÄ‚îÄ PICKLE: dash trail render ‚îÄ‚îÄ
        if(state.pickleDash&&state.pickleDash.active){
            const pd=state.pickleDash;
            pd.trail.forEach(t=>{
                const a=(t.life/t.maxLife);
                ctx.save();ctx.globalAlpha=a*0.85;
                if(t.burst){
                    ctx.fillStyle=`hsl(${100+Math.random()*40},90%,50%)`;ctx.shadowBlur=8;ctx.shadowColor='#44cc00';
                    ctx.beginPath();ctx.arc(t.x,t.y,4+a*4,0,Math.PI*2);ctx.fill();
                } else {
                    // Pickle trail ghost
                    ctx.font=`${18+a*14}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';
                    ctx.shadowBlur=14;ctx.shadowColor='#44cc00';
                    ctx.fillText('ü•í',t.x,t.y);
                }
                ctx.restore();
            });
        }

        // ‚îÄ‚îÄ PICKLE: draw poison cloud on poisoned enemies ‚îÄ‚îÄ
        (state.picklePoisons||[]).forEach(pp=>{
            if(pp.enemy.hp<=0)return;
            const a=Math.min(1,(pp.timer/120)*0.5);const pulse=0.5+0.5*Math.sin(state.frameCount*0.25);
            ctx.save();ctx.globalAlpha=a*(0.3+pulse*0.2);ctx.fillStyle='#44cc00';ctx.shadowBlur=10;ctx.shadowColor='#44cc00';
            ctx.beginPath();ctx.arc(pp.enemy.x,pp.enemy.y,18+pulse*4,0,Math.PI*2);ctx.fill();
            ctx.restore();
        });

        // Enemies
        for(const e of state.enemies){e.draw();}

        // Boss
        if(state.boss){state.boss.draw();}

        // Enemy bullets
        for(const b of state.enemyBullets){b.draw();}

        // XP orbs
        for(const o of state.xpOrbs){o.draw();}

        // Particles
        for(const p of state.particles){p.draw();}

        // Lightning
        for(const l of state.lightningEffects){l.draw();}

        // ‚îÄ‚îÄ KIRA: Justice Monologue anime cutscene ‚îÄ‚îÄ
        if(state.kiraCutscene){
            const kc=state.kiraCutscene;
            const t=kc.timer/kc.maxTimer;
            // Fade in (first 20%), hold, fade out (last 30%)
            let alpha;
            const fadeIn=0.15,fadeOut=0.25;
            if(t>1-fadeIn) alpha=(1-t)/fadeIn;
            else if(t<fadeOut) alpha=t/fadeOut;
            else alpha=1;
            ctx.save();
            // Dark overlay
            ctx.fillStyle=`rgba(0,0,0,${alpha*0.88})`;ctx.fillRect(0,0,canvas.width,canvas.height);
            // Red vignette bars top+bottom (anime letterbox feel)
            const barH=80;
            ctx.fillStyle=`rgba(140,0,0,${alpha*0.9})`;
            ctx.fillRect(0,0,canvas.width,barH);
            ctx.fillRect(0,canvas.height-barH,canvas.width,barH);
            // Death Note kanji-style decorative lines
            ctx.strokeStyle=`rgba(200,0,0,${alpha*0.3})`;ctx.lineWidth=1;
            for(let li=0;li<6;li++){
                ctx.beginPath();ctx.moveTo(0,canvas.height*0.5+li*22-55);ctx.lineTo(canvas.width,canvas.height*0.5+li*22-55);ctx.stroke();
            }
            // Big emoji portrait of Kira
            ctx.font='140px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.shadowBlur=40;ctx.shadowColor='#cc0000';
            ctx.globalAlpha=alpha*0.25;
            ctx.fillText('üìì',canvas.width*0.82,canvas.height/2);
            ctx.globalAlpha=alpha;
            // The main quote text ‚Äî split across lines if long
            const words=kc.line.split(' ');
            const lines2=[];let cur='';
            words.forEach(w=>{const test=cur+(cur?' ':'')+w;if(test.length>26){lines2.push(cur);cur=w;}else cur=test;});
            if(cur)lines2.push(cur);
            const lineH=38;const totalH=lines2.length*lineH;
            const startY=canvas.height/2-totalH/2+10;
            lines2.forEach((ln,li2)=>{
                const prog=1-Math.min(1,Math.max(0,(kc.timer-(kc.maxTimer-(li2+1)*(kc.maxTimer/(lines2.length+1))))/40));
                ctx.font='bold 26px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.shadowBlur=20;ctx.shadowColor='#ff0000';
                ctx.fillStyle=`rgba(255,220,0,${alpha*prog})`;
                ctx.fillText(ln,canvas.width/2,startY+li2*lineH);
            });
            // "KIRA" watermark bottom bar
            ctx.font='12px "Press Start 2P"';ctx.fillStyle=`rgba(200,0,0,${alpha*0.9})`;
            ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText('‚Äî KIRA ‚Äî',canvas.width/2,canvas.height-barH/2);
            // Dramatic red flash at start
            if(kc.timer>kc.maxTimer-8){
                ctx.fillStyle=`rgba(180,0,0,${(kc.maxTimer-kc.timer)/8*0.6})`;ctx.fillRect(0,0,canvas.width,canvas.height);
            }
            ctx.restore();
        }

        // ‚îÄ‚îÄ BLAHBLAHBLAH: word bullet custom render ‚îÄ‚îÄ
        if(state.player&&state.player.config.id==='blahblahblah'){
            state.bullets.forEach(b=>{
                if(!b.word)return;// only word bullets
                ctx.save();ctx.font='bold 12px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.shadowBlur=10;ctx.shadowColor='#cc44ff';ctx.fillStyle='#dd88ff';
                ctx.fillText(b.word,b.x,b.y);ctx.restore();
            });
        }

        // ‚îÄ‚îÄ SUBARU: Madness meter bar render ‚îÄ‚îÄ
        if(state.player&&state.player.config.id==='subaru'){
            const p=state.player;
            const mm=p.madnessMeter||0;
            if(mm>0||state.subaru_checkpoint){
                ctx.save();
                const bw=130,bh=10,bx=p.x-bw/2,by=p.y+38;
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(bx,by,bw,bh);
                const pct=mm/100;
                const barColor=mm>=80?`rgba(255,50,255,${0.7+0.3*Math.sin(state.frameCount*0.3)})`:`rgba(${Math.floor(68+pct*187)},${Math.floor(136-pct*80)},255,0.9)`;
                ctx.fillStyle=barColor;ctx.shadowBlur=mm>=80?16:4;ctx.shadowColor='#aa44ff';
                ctx.fillRect(bx,by,bw*pct,bh);
                ctx.strokeStyle='rgba(180,100,255,0.4)';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,bh);
                ctx.font='7px "Press Start 2P"';ctx.fillStyle=mm>=80?'#ff88ff':'#aaaaff';ctx.textAlign='center';
                ctx.fillText(mm>=80?`MADNESS ${Math.floor(mm)}% ‚Äî FULL!`:`MADNESS ${Math.floor(mm)}%`,p.x,by+bh+10);
                // Checkpoint indicator
                if(state.subaru_checkpoint){
                    ctx.font='8px Arial';ctx.fillStyle='rgba(68,136,255,0.8)';ctx.textAlign='center';
                    ctx.fillText('üîÑ',p.x,by-10);
                }
                ctx.restore();
            }
        }

        // ‚îÄ‚îÄ BLAHBLAHBLAH: Ultimate Speech cutscene ‚îÄ‚îÄ
        if(state.blahCutscene){
            const bc=state.blahCutscene;
            const t=bc.timer/bc.maxTimer;
            let alpha;
            if(t>0.85)alpha=(1-t)/0.15;
            else if(t<0.2)alpha=t/0.2;
            else alpha=1;
            ctx.save();
            ctx.fillStyle=`rgba(0,0,0,${alpha*0.85})`;ctx.fillRect(0,0,canvas.width,canvas.height);
            // Purple/violet letterbox bars
            const bH=70;
            ctx.fillStyle=`rgba(100,20,180,${alpha*0.95})`;
            ctx.fillRect(0,0,canvas.width,bH);ctx.fillRect(0,canvas.height-bH,canvas.width,bH);
            // Speed lines emanating from center (manga style)
            ctx.strokeStyle=`rgba(200,100,255,${alpha*0.2})`;ctx.lineWidth=2;
            const cx2=canvas.width/2,cy2=canvas.height/2;
            for(let si=0;si<24;si++){
                const sa=(si/24)*Math.PI*2;
                ctx.beginPath();ctx.moveTo(cx2,cy2);ctx.lineTo(cx2+Math.cos(sa)*1200,cy2+Math.sin(sa)*1200);ctx.stroke();
            }
            // Emoji portrait
            ctx.font='150px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.shadowBlur=50;ctx.shadowColor='#cc44ff';ctx.globalAlpha=alpha*0.22;
            ctx.fillText('üí¨',canvas.width*0.8,canvas.height/2);ctx.globalAlpha=alpha;
            // Main text
            const words2=bc.line.split(' ');const lns2=[];let cur2='';
            words2.forEach(w=>{const test=cur2+(cur2?' ':'')+w;if(test.length>22){lns2.push(cur2);cur2=w;}else cur2=test;});
            if(cur2)lns2.push(cur2);
            const lh2=42,tot2=lns2.length*lh2,sy2=canvas.height/2-tot2/2;
            lns2.forEach((ln,li)=>{
                const prog=Math.min(1,(1-t)/(1/(lns2.length+1))-(li*0.15));
                ctx.font='bold 28px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.shadowBlur=18;ctx.shadowColor='#9900ff';
                ctx.fillStyle=`rgba(220,150,255,${alpha*Math.max(0,Math.min(1,prog))})`;
                ctx.fillText(ln,canvas.width/2,sy2+li*lh2);
            });
            ctx.font='11px "Press Start 2P"';ctx.fillStyle=`rgba(180,80,255,${alpha*0.9})`;
            ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText('‚Äî THE POWER OF BONDS ‚Äî',canvas.width/2,canvas.height-bH/2);
            if(bc.timer>bc.maxTimer-8){ctx.fillStyle=`rgba(120,0,220,${(bc.maxTimer-bc.timer)/8*0.6})`;ctx.fillRect(0,0,canvas.width,canvas.height);}
            ctx.restore();
        }

        // ‚îÄ‚îÄ SUBARU: Return by Death / Madness cutscene ‚îÄ‚îÄ
        if(state.subaruCutscene){
            const sc=state.subaruCutscene;
            const t=sc.timer/sc.maxTimer;
            let alpha;
            if(t>0.88)alpha=(1-t)/0.12;
            else if(t<0.18)alpha=t/0.18;
            else alpha=1;
            const isReturn=sc.type==='return';
            ctx.save();
            ctx.fillStyle=`rgba(0,0,${isReturn?40:0},${alpha*0.9})`;ctx.fillRect(0,0,canvas.width,canvas.height);
            const bH2=75;
            const barColor2=isReturn?`rgba(20,60,180,${alpha*0.95})`:`rgba(120,0,200,${alpha*0.95})`;
            ctx.fillStyle=barColor2;ctx.fillRect(0,0,canvas.width,bH2);ctx.fillRect(0,canvas.height-bH2,canvas.width,bH2);
            // Clock-like rings for "return" type
            if(isReturn){
                for(let ri=0;ri<4;ri++){
                    const rr=80+ri*60+((state.frameCount*2)%40);
                    ctx.strokeStyle=`rgba(68,136,255,${alpha*(0.5-ri*0.1)})`;ctx.lineWidth=2;
                    ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,rr,0,Math.PI*2);ctx.stroke();
                }
            }
            // Emoji portrait
            ctx.font='130px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.shadowBlur=40;ctx.shadowColor=isReturn?'#4488ff':'#aa44ff';ctx.globalAlpha=alpha*0.25;
            ctx.fillText(isReturn?'üîÑ':'üåÄ',canvas.width*0.8,canvas.height/2);ctx.globalAlpha=alpha;
            // Text
            const mainLine=isReturn?'RETURN BY DEATH':'MADNESS UNLEASHED';
            ctx.font='bold 30px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.shadowBlur=22;ctx.shadowColor=isReturn?'#0044ff':'#8800ff';
            ctx.fillStyle=`rgba(${isReturn?'100,180,255':'200,100,255'},${alpha})`;
            ctx.fillText(mainLine,canvas.width/2,canvas.height/2-25);
            if(sc.quote){
                const qw=sc.quote.split(' ');const ql=[];let qc='';
                qw.forEach(w=>{const test=qc+(qc?' ':'')+w;if(test.length>28){ql.push(qc);qc=w;}else qc=test;});
                if(qc)ql.push(qc);
                ql.forEach((ln,li)=>{
                    ctx.font='14px "Press Start 2P"';ctx.fillStyle=`rgba(180,210,255,${alpha*0.9})`;
                    ctx.fillText(ln,canvas.width/2,canvas.height/2+20+li*24);
                });
            }
            ctx.font='10px "Press Start 2P"';ctx.fillStyle=`rgba(100,150,255,${alpha*0.85})`;
            ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText('‚Äî SUBARU NATSUKI ‚Äî',canvas.width/2,canvas.height-bH2/2);
            if(sc.timer>sc.maxTimer-8){ctx.fillStyle=`rgba(0,40,180,${(sc.maxTimer-sc.timer)/8*0.7})`;ctx.fillRect(0,0,canvas.width,canvas.height);}
            ctx.restore();
        }

        // Text popups
        for(let i=state.textPopups.length-1;i>=0;i--){state.textPopups[i].update();if(state.textPopups[i].life<=0)state.textPopups.splice(i,1);}
        for(const t of state.textPopups){t.draw();}
    }
}

// Main loop using fixed timestep accumulator
function mainLoop(timestamp){
    requestAnimationFrame(mainLoop);

    if(lastTimestamp === 0) lastTimestamp = timestamp;
    let elapsed = timestamp - lastTimestamp;
    lastTimestamp = timestamp;

    // Cap max elapsed to avoid spiral of death on tab focus return
    if(elapsed > 200) elapsed = 200;

    accumulator += elapsed;

    // Run as many fixed steps as accumulated
    while(accumulator >= FIXED_DT){
        gameStep();
        accumulator -= FIXED_DT;
    }

    // Always render once per rAF
    gameRender();
}

function spawnBoss(){
    state.boss=new Boss();state.bossTimer=2700;
    document.getElementById('bossBar').classList.remove('hidden');updateBossBar();
    popup(canvas.width/2,canvas.height/2-80,'‚ö† BOSS APPROACHING!','#ff6600',180);
    popup(canvas.width/2,canvas.height/2-55,state.boss.bossName,'#ff9900',180);
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
let previousScreen=null;
function showScreen(id){previousScreen=state.screen;state.screen='OVERLAY';document.querySelectorAll('.ui-layer').forEach(el=>el.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function closeOverlay(){
    document.getElementById('settingsScreen').classList.add('hidden');document.getElementById('keybindsScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.add('hidden');
    if(previousScreen==='MENU'||!state.player){document.getElementById('mainMenu').classList.remove('hidden');state.screen='MENU';}
    else{document.getElementById('pauseMenu').classList.remove('hidden');state.screen='PAUSED';updateHUD();}
}
function resumeGame(){document.getElementById('pauseMenu').classList.add('hidden');state.screen='PLAYING';updateHUD();}
let _hudVisible=true;
function toggleHudVisibility(){
    _hudVisible=!_hudVisible;
    const hud=document.getElementById('hud');if(!hud)return;
    Array.from(hud.children).forEach(el=>{if(el.id!=='eyeToggle')el.style.visibility=_hudVisible?'':'hidden';});
    document.getElementById('eyeToggle').style.opacity=_hudVisible?'0.7':'0.4';
}

// Auto-hide HUD text after 4 seconds of inactivity
let _hudAutoHideTimer=null;
function _resetHudAutoHide(){
    const hud=document.getElementById('hud');if(!hud)return;
    hud.classList.remove('hud-hidden');
    clearTimeout(_hudAutoHideTimer);
    _hudAutoHideTimer=setTimeout(()=>{ if(state&&state.screen==='PLAYING') hud.classList.add('hud-hidden'); },4000);
}
['mousemove','mousedown','keydown','touchstart','touchmove'].forEach(ev=>{
    window.addEventListener(ev,_resetHudAutoHide,{passive:true});
});
function setDifficulty(d){settings.difficulty=d==='hard'?1.6:1;document.getElementById('diffNormal').classList.toggle('active',d==='normal');document.getElementById('diffHard').classList.toggle('active',d==='hard');}
function setParticles(on){settings.particles=on;document.getElementById('particlesOn').classList.toggle('active',on);document.getElementById('particlesOff').classList.toggle('active',!on);}
function setAbilityTarget(t){settings.abilityTarget=t;document.getElementById('targetAuto').classList.toggle('active',t==='auto');document.getElementById('targetManual').classList.toggle('active',t==='manual');}
function setShootTarget(t){settings.shootTarget=t;['Default','Strongest','Closest','Manual'].forEach(s=>{const el=document.getElementById('shoot'+s);if(el)el.classList.toggle('active',t===s.toLowerCase());});}
function setAutoPause(v){settings.autoPauseOnHide=v;document.getElementById('autoPauseOn').classList.toggle('active',v);document.getElementById('autoPauseOff').classList.toggle('active',!v);}

function renderCharIcon(c){
    const sz=44;const oc=document.createElement('canvas');oc.width=sz;oc.height=sz;
    const oc2=oc.getContext('2d');
    if(c.emojiFilter){oc2.filter=c.emojiFilter;}
    oc2.font=`${sz-4}px Arial`;oc2.textAlign='center';oc2.textBaseline='middle';
    oc2.fillText(c.emoji,sz/2,sz/2);
    return oc.toDataURL();
}

function initInfoScreen(){
    const CHAR_INFO=[
        {emoji:'üëπ',name:'Noglin',color:'#ff00ff',stats:'Speed: Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Latch',   desc:'Fire a latch toward your cursor. Hit an enemy to mind control them ‚Äî piloting their body with their own speed, health and projectiles. Latch cooldown pauses during control. Host dies after 60s.'},
            {key:'[MC] Q ‚Äî Special (changes per host)',desc:'GRUNT ‚Üí FRENZY: Charge through every visible enemy in sequence, 8√ó dmg each. SHOOTER ‚Üí VOLLEY: Fire 4 homing shots at the 5 highest-HP targets simultaneously. WARLOCK ‚Üí SOUL VORTEX: Pull all enemies inward for 2s dealing constant dmg, then blast them out for 14√ó dmg. TANK ‚Üí SHOCKWAVE SLAM: 4 expanding rings of damage and massive knockback. SPEEDER ‚Üí PHANTOM RUSH: Teleport to 7 random enemies in rapid succession, AOE at each landing. BRUTE ‚Üí HURL: Throw the nearest enemy as a living wrecking ball (18√ó collision dmg to everything in its path). BOSS ‚Üí RAMPAGE: 3 rings of bullets + dive-bomb strikes.'},
            {key:'[MC] SPACE ‚Äî Delatch', desc:'Safely exit the host. You return with your original HP and the host survives.'},
            {key:'[MC] R ‚Äî Kill Host', desc:'Instantly kill the controlled enemy and escape. Great for detonating a host on demand.'},
            {key:'R ‚Äî Cuteness',    desc:'Stun all nearby enemies for 2 seconds. Doubles attack speed and grants 2 shots of 2√ó bullet damage. Noglin switches to its adorable form while enemies are stunned.'},
        ]},
        {emoji:'‚ö°',name:'Pikachu',color:'#ffff00',stats:'Speed: Very Fast | HP: 4',abilities:[
            {key:'SPACE ‚Äî Thunderbolt', desc:'Fire 8 lightning bolts that chain between nearby enemies, dealing 30 damage each hit.'},
            {key:'R ‚Äî Volt Tackle',     desc:'Dash at the nearest enemy at lightning speed. Stuns them and knocks them back. If aimed at a group, you bounce through all of them.'},
        ]},
        {emoji:'üêØ',name:'Zanther',color:'#ff9900',stats:'Speed: Medium | HP: 5',abilities:[
            {key:'SPACE ‚Äî Pounce',  desc:'Leap onto the nearest enemy and feast ‚Äî dealing constant damage while healing 25% of dealt damage back. All other enemies flee in terror. Hold to keep feasting, or press SPACE to release early.'},
            {key:'R ‚Äî Sheer Aura', desc:'Activate a terror aura for 5 seconds ‚Äî all enemies on screen flee and take increased damage. Great combo with Pounce.'},
        ]},
        {emoji:'üê±',name:'Vitru',color:'#00ff88',stats:'Speed: Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Glorp Beam', desc:'Fire a beam toward your cursor that instantly deletes everything in its path. Confuses nearby enemies. You teleport to a random point along the beam.'},
            {key:'R ‚Äî Wormhole',       desc:'Teleport instantly to your cursor position and gain a burst of speed. Great for escaping or repositioning.'},
        ]},
        {emoji:'üêï',name:'Broke Shiba',color:'#ffbbbb',stats:'Speed: Medium | HP: 6',abilities:[
            {key:'SPACE ‚Äî Sad Whimper', desc:'Emit a pitiful cry that slows ALL enemies on screen to 15% speed for 5 seconds. Also makes ranged enemies stop shooting.'},
            {key:'R ‚Äî 50 Bucks',        desc:'Throw bouncing coins that home in on enemies and bounce up to 7 times, dealing 5x your bullet damage per hit. Coins keep chasing new targets.'},
        ]},
        {emoji:'‚òÉÔ∏è',name:'Snowman',color:'#88eeff',stats:'Speed: Slow | HP: 7',abilities:[
            {key:'SPACE ‚Äî Flash Freeze', desc:'Instantly freeze ALL non-boss enemies solid for 5 seconds. Frozen enemies take 2√ó damage and cannot move or shoot.'},
            {key:'R ‚Äî Icicle Barrage',   desc:'Launch 12 icicles outward in a full circle, each dealing 2.5√ó your bullet damage. Great for clearing crowds.'},
        ]},
        {emoji:'üòé',name:'Coolioioio',color:'#ff44ff',stats:'Speed: Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Spinbot',   desc:'Spin wildly for 4 seconds, firing 10 bullets per second in all directions. Immune to damage while spinning.'},
            {key:'R ‚Äî 360-No-Scope',  desc:'Fire a single massive piercing shot at your cursor that one-taps most enemies. Deals 10√ó bullet damage with huge knockback.'},
        ]},
        {id:'pickle',emoji:'ü•í',name:'Pickle',color:'#44cc00',stats:'Speed: Medium | HP: 6',abilities:[
            {key:'SPACE ‚Äî Brine Burst', desc:'Explode in a cloud of pickle brine, poisoning and briefly stunning all enemies within 300px. Poison ticks every 0.5 seconds, dealing 40% of your damage. Stacks on re-hit. Lasts 7 seconds.'},
            {key:'R ‚Äî Pickle Dash', desc:'Become Tiny Pickle Rick and dash through up to 8 enemies in sequence, dealing 3√ó damage and leaving poison on each. Features mandatory "I\'M PICKLE RICK!" proclamation.'},
        ]},
        {emoji:'üí¨',name:'BlahBlahBlah',color:'#cc44ff',stats:'Speed: Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Word Barrage', desc:'Unleash a torrent of anime catchphrases as bullets for 1 second. Each word-bullet stuns enemies briefly and deals 1.8√ó damage. Auto-tracks nearest enemy.'},
            {key:'R ‚Äî Ultimate Speech', desc:'Trigger an anime-style cutscene, then nuke everything within 600px for 15√ó damage 1.5 seconds later. Full invulnerability during speech. Very dramatic.'},
        ]},
        {id:'kira',emoji:'üìì',name:'Kira',color:'#cc0000',stats:'Speed: Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Death Note', desc:'Condemn the highest-HP enemy. After 3 seconds they die. Boss takes 55% max HP instead. God Mode (10 kills) = instant kill on boss.'},
            {key:'R ‚Äî Justice Monologue (40s CD)', desc:'Trigger a Death Note anime cutscene. Deals 50% max HP to ALL enemies and 35% max HP to the boss. Very long cooldown, but devastating.'},
        ]},
        {id:'femboy',emoji:'üéÄ',name:'Femboy',color:'#ff88cc',stats:'Speed: Very Fast | HP: 5',abilities:[
            {key:'SPACE ‚Äî Slay', desc:'Emit a sparkle shockwave that charms all nearby enemies (range 380). Charmed enemies fight FOR you, attacking other enemies for 5 seconds.'},
            {key:'R ‚Äî Twirl', desc:'Spin in place for 3 seconds releasing sparkle waves dealing 1.5√ó damage to all enemies in 220px range. Full invulnerability during twirl.'},
        ]},
        {id:'subaru',emoji:'üîÑ',name:'Subaru',color:'#4488ff',stats:'Speed: Fast | HP: 4',abilities:[
            {key:'SPACE ‚Äî Return by Death', desc:'Set a checkpoint. If you die, you return here with 50% HP instead. While Madness Meter is filled, also releases a massive burst: 3-15√ó damage (scales with madness) in a huge range. Madness resets after use.'},
            {key:'R ‚Äî Unseen Hand', desc:'Yank all nearby enemies (400px range) toward you for 5√ó damage each, then fling them. Gain 15% madness per use.'},
            {key:'PASSIVE ‚Äî Madness Meter', desc:'Taking damage fills your Madness Meter (shown below you). At 80%+ the meter glows. Use SPACE to release it as a devastating burst. You also gain 60% madness on Return by Death activation.'},
        ]},
    ];
    const grid=document.getElementById('infoGrid');
    if(!grid)return;
    grid.innerHTML='';
    const SECRET_IDS=['kira','femboy','subaru'];
    CHAR_INFO.filter(c=>!SECRET_IDS.includes(c.id)).forEach(c=>{
        const card=document.createElement('div');
        card.className='char-info-card';
        const abRows=c.abilities.map(a=>
            `<div class="ability-row"><span class="ability-key">${a.key}</span><span class="ability-desc">${a.desc}</span></div>`
        ).join('');
        card.innerHTML=`
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:6px">
                <span style="font-size:1.5rem">${c.emoji}</span>
                <div>
                    <div style="font-size:10px;font-weight:bold;color:${c.color}">${c.name}</div>
                    <div style="font-size:7px;color:#777">${c.stats}</div>
                </div>
            </div>
            ${abRows}`;
        grid.appendChild(card);
    });
}

function initMenu(){
    loadSave();
    initInfoScreen();
    const grid=document.getElementById('charGrid');if(!grid)return;grid.innerHTML='';
    CHARACTERS.filter(c=>!c.secret).forEach(c=>{
        const b=document.createElement('div');b.className='char-btn';
        const hasImg=c.img&&c.img.complete&&c.img.naturalWidth>0;
        let iconHtml;
        if(hasImg){iconHtml=`<img src="${c.img.src}" style="width:40px;height:40px;object-fit:contain">`;}
        else if(c.emojiFilter){const dataUrl=renderCharIcon(c);iconHtml=`<img src="${dataUrl}" style="width:${44}px;height:${44}px">`;}
        else{iconHtml=`<span style="font-size:2rem">${c.emoji}</span>`;}
        b.innerHTML=`<div class="char-icon">${iconHtml}</div>
            <div style="font-size:8px;font-weight:bold;color:white">${c.name}</div>
            <div style="font-size:6px;color:#888">${c.desc}</div>`;
        b.onclick=()=>startGame(c);grid.appendChild(b);
    });
}

function startGame(c){
    // Per-character cooldowns ‚Äî always longer than active duration
    const cdMap = {
        tiger:      {primary:1500, secondary:1200},
        coolioioio: {primary:900,  secondary:1200},
        snowman:    {primary:1200, secondary:900},
        noglin:     {primary:1200, secondary:900},
        pikachu:    {primary:1200, secondary:900},
        cat:        {primary:1200, secondary:900},
        shiba:      {primary:1200, secondary:900},
        kira:       {primary:900,  secondary:2400},
        femboy:     {primary:1200, secondary:900},
        pickle:     {primary:900,  secondary:1200},
        blahblahblah:{primary:900, secondary:1500},
        subaru:     {primary:900,  secondary:1200},
    };
    const charCd = cdMap[c.id] || {primary:1200, secondary:900};
    state={
        screen:'PLAYING',player:new Player(c),
        enemies:[],bullets:[],enemyBullets:[],xpOrbs:[],textPopups:[],lightningEffects:[],particles:[],
        lvl:1,xp:0,xpNeeded:100,score:0,frameCount:0,keys:state.keys,
        joystick:{active:false,x:0,y:0},
        ability:{ready:true,cooldown:0,maxCooldown:charCd.primary},
        secondary:{ready:true,cooldown:0,maxCooldown:charCd.secondary},
        effects:{timeSlow:false,frozen:false,frozenTimer:0,frozenDamageMult:1,confused:false,confuseTimer:0},
        mindControl:{active:false,host:null,savedHp:0,slamCooldown:0,mcTimer:0},
    bossMultiplier:1.0,
        pounce:{active:false,target:null,timer:0,damage:0,damageTick:0,healTick:0},
        boss:null,bossTimer:2700,
        mouseX:canvas.width/2,mouseY:canvas.height/2,
        glorpBeam:null,voltTackle:null,cutenessStacks:0,
        spinbot:null,miniBeams:[],mcAbilityCooldowns:{q:0,e:0,f:0},
        _pausedByOrientation:false,
        // New character state
        deathNoteTargets:[],  // Kira: [{enemy, timer}]
        charmedEnemies:[],    // Femboy: [{enemy, timer}]
        picklePoisons:[],     // Pickle: [{enemy, timer, dps}]
        pickleDash:null,      // Pickle: dash animation state
        twirl:null,           // Femboy: {timer, angle}
        kiraCutscene:null,    // Kira: anime cutscene overlay
        blahBarrage:null,     // BlahBlahBlah: word barrage state
        blahCutscene:null,    // BlahBlahBlah: cutscene
        subaru_checkpoint:null,// Subaru: saved checkpoint
        subaruCutscene:null,  // Subaru: cinematic overlay
    };
    document.querySelectorAll('.ui-layer').forEach(el=>el.classList.add('hidden'));
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('bossBar').classList.add('hidden');
    document.getElementById('mindCtrlHud').classList.add('hidden');
    document.getElementById('pounceIndicator').style.display='none';
    document.getElementById('mc-controls').style.display='none';
    updateHUD();
    // Show mobile controls
    if(isMobile){
        document.getElementById('mobile-controls').style.display='block';
        document.getElementById('ability-btn').style.display='flex';
        document.getElementById('secondary-btn').style.display='flex';
        document.body.classList.add('mobile-active');
    }
}

function updateHUD(){
    const sd=document.getElementById('scoreDisplay'),ld=document.getElementById('lvlDisplay'),hd=document.getElementById('hpDisplay'),xf=document.getElementById('xp-fill');
    if(sd)sd.innerText=state.score;if(ld)ld.innerText=state.lvl;
    if(hd&&state.player){hd.innerHTML='';for(let i=0;i<state.player.maxHp;i++)hd.innerHTML+=i<state.player.hp?'‚ù§Ô∏è':'üñ§';}
    if(xf)xf.style.width=(state.xp/state.xpNeeded*100)+'%';
    const ab=document.getElementById('ability-btn');
    const ab2=document.getElementById('secondary-btn');
    const ABILITY_NAMES={
        noglin:{primary:'LATCH',secondary:'CUTENESS'},pikachu:{primary:'THUNDERBOLT',secondary:'VOLT TACKLE'},
        tiger:{primary:'POUNCE',secondary:'SHEER AURA'},cat:{primary:'GLORP BEAM',secondary:'WORMHOLE'},
        shiba:{primary:'WHIMPER',secondary:'50 BUCKS'},snowman:{primary:'FREEZE',secondary:'ICICLES'},
        coolioioio:{primary:'SPINBOT',secondary:'360-NOSCOPE'},
        kira:{primary:'DEATH NOTE',secondary:'MONOLOGUE'},
        femboy:{primary:'SLAY',secondary:'TWIRL'},
        pickle:{primary:'BRINE BURST',secondary:'PICKLE DASH'},
        blahblahblah:{primary:'WORD BARRAGE',secondary:'ULTIMATE SPEECH'},
        subaru:{primary:'RETURN BY DEATH',secondary:'UNSEEN HAND'},
    };
    const charId=state.player?state.player.config.id:'';
    const names=ABILITY_NAMES[charId]||{primary:'ABILITY',secondary:'SECONDARY'};
    const cd=document.getElementById('cooldown-display');
    if(cd&&state.player){
        const rows=cd.querySelectorAll('div');
        const isPaused=state.screen==='PAUSED';
        if(state.mindControl&&state.mindControl.active&&charId==='noglin'){
            // MC mode: show Q ability name + cooldown, and SPC/R labels
            const host=state.mindControl.host;
            const hostType=host&&host.def?host.def.type:'unknown';
            const qLabel={grunt:'FRENZY',shooter:'VOLLEY',warlock:'SOUL VORTEX',tank:'SHOCKWAVE',brute:'HURL',speeder:'PHANTOM RUSH',boss:'RAMPAGE'}[hostType]||'MIND PULSE';
            const qCd=state.mcAbilityCooldowns?state.mcAbilityCooldowns.q||0:0;
            const qReady=qCd<=0;
            if(rows[0])rows[0].innerHTML=`Q ‚Äî ${qLabel}: <span style="color:${qReady?'#cc00ff':'#555'};font-weight:bold">${qReady?'READY':isPaused?'-':Math.ceil(qCd/60)+'s'}</span>`;
            if(rows[1])rows[1].innerHTML=`<span style="color:#aaa;font-size:8px">SPC: DELATCH &nbsp;|&nbsp; <span style="color:#ff6666">R: KILL HOST</span></span>`;
        } else {
            if(rows[0])rows[0].innerHTML=`${names.primary} [SPC]: <span id="abilityTimer" style="color:${state.ability.ready?'#00f2ff':'#555'};font-weight:bold">${state.ability.ready?'READY':isPaused?'-':Math.ceil(state.ability.cooldown/60)+'s'}</span>`;
            if(rows[1])rows[1].innerHTML=`${names.secondary} [R]: <span id="secondaryTimer" style="color:${state.secondary.ready?'#ffdd00':'#555'};font-weight:bold">${state.secondary.ready?'READY':isPaused?'-':Math.ceil(state.secondary.cooldown/60)+'s'}</span>`;
        }
    }
    if(ab){if(state.ability.ready){ab.classList.add('ready');ab.innerText="‚ö°";}else{const s=Math.ceil(state.ability.cooldown/60);ab.classList.remove('ready');ab.innerText=s;}}
    if(ab2){if(state.secondary.ready){ab2.classList.add('ready');ab2.innerText="‚òÖ";}else{const s=Math.ceil(state.secondary.cooldown/60);ab2.classList.remove('ready');ab2.innerText=s;}}
}

function showLevelUp(){
    state.screen='LEVELUP';
    const container=document.getElementById('upgradeOptions');container.innerHTML='';
    const picked=new Set();
    for(let i=0;i<3;i++){
        let base,tier,tries=0;
        do{const u=pickUpgrade();base=u.base;tier=u.tier;tries++;}while(picked.has(base.id+tier.l)&&tries<30);
        picked.add(base.id+tier.l);
        const b=document.createElement('button');b.className=`upgrade-btn ${tier.l.toLowerCase()}`;
        b.innerHTML=`<div class="flex justify-between items-center mb-1"><span style="font-size:10px;font-weight:bold">${base.name}</span><span style="font-size:8px;color:${tier.c};font-weight:bold">${tier.l.toUpperCase()}</span></div><div style="font-size:8px;color:#ccc;line-height:1.5">${tier.desc}</div>`;
        b.onclick=()=>{
            const p=state.player;
            if(base.id==='atk_speed') p.atkSpeed=Math.max(5,p.atkSpeed-tier.v);
            if(base.id==='damage')    p.damage+=tier.v;
            if(base.id==='speed')     p.speed+=tier.v;
            if(base.id==='projectiles') p.projectileCount+=tier.v;
            if(base.id==='bullet_size') p.bSize+=tier.v;
            if(base.id==='xp_boost')  p.xpMult+=tier.v;
            if(base.id==='crit')      p.crit=Math.min(95,p.crit+tier.v);
            if(base.id==='regen')     p.regen=Math.min(0.50,p.regen+tier.v);
            if(base.id==='max_hp')    {p.maxHp+=tier.v;p.hp=Math.min(p.hp+tier.v,p.maxHp);}
            if(base.id==='ability_cd'){state.ability.maxCooldown=Math.max(360,state.ability.maxCooldown-tier.v);state.secondary.maxCooldown=Math.max(360,state.secondary.maxCooldown-Math.floor(tier.v*0.7));}
            if(base.id==='bullet_spd') p.bulletSpeedMult=(p.bulletSpeedMult||1)+tier.v*0.1;
            document.getElementById('levelUpScreen').classList.add('hidden');state.screen='PLAYING';
            updateHUD();
        };
        container.appendChild(b);
    }
    document.getElementById('levelUpScreen').classList.remove('hidden');
}

function resetGame(){location.reload();}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
window.addEventListener('keydown',e=>{
    state.keys[e.key.toLowerCase()]=true;
    if(e.code==='Space'){e.preventDefault();triggerAbility();}
    if(e.key.toLowerCase()==='r'){
        if(state.mindControl.active)killMindControlHost();
        else triggerSecondary();
    }
    if(e.key.toLowerCase()==='q'&&state.mindControl.active){triggerMCAbility('q');}
    // E and F MC abilities removed (kept Q + SPC:delatch + R:kill)
    if(e.code==='Escape'){
        if(state.screen==='PLAYING'){state.screen='PAUSED';document.getElementById('pauseMenu').classList.remove('hidden');updateHUD();}
        else if(state.screen==='PAUSED')resumeGame();
        else if(state.screen==='OVERLAY')closeOverlay();
    }
});
window.addEventListener('keyup',e=>{state.keys[e.key.toLowerCase()]=false;});
canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect();state.mouseX=(e.clientX-r.left)*(WORLD_W/r.width);state.mouseY=(e.clientY-r.top)*(WORLD_H/r.height);});

// Touch aim: update mouseX/Y from any non-joystick, non-button touch
canvas.addEventListener('touchmove', e => {
    if(e.touches.length > 0) {
        const t = e.touches[0];
        const r = canvas.getBoundingClientRect();
        state.mouseX = (t.clientX - r.left) * (WORLD_W / r.width);
        state.mouseY = (t.clientY - r.top)  * (WORLD_H / r.height);
    }
}, {passive: true});

// ‚îÄ‚îÄ MOBILE CONTROLS ‚îÄ‚îÄ
const joyBase=document.getElementById('mobile-controls');
const joyKnob=document.getElementById('joystick-knob');
const abBtn=document.getElementById('ability-btn');
const abBtn2=document.getElementById('secondary-btn');

// Auto-show on mobile
if(isMobile){
    if(joyBase) joyBase.style.display='block';
    if(abBtn) abBtn.style.display='flex';
    if(abBtn2) abBtn2.style.display='flex';
}

// Joystick touch handling
let joyTouchId = null;
if(joyBase){
    joyBase.addEventListener('touchstart', e => {
        e.preventDefault();
        if(joyTouchId === null){
            joyTouchId = e.changedTouches[0].identifier;
            state.joystick.active = true;
            handleJoy(e.changedTouches[0]);
        }
    }, {passive: false});

    joyBase.addEventListener('touchmove', e => {
        e.preventDefault();
        for(const t of e.changedTouches){
            if(t.identifier === joyTouchId){ handleJoy(t); break; }
        }
    }, {passive: false});

    const endJoy = e => {
        for(const t of e.changedTouches){
            if(t.identifier === joyTouchId){
                joyTouchId = null;
                state.joystick.active = false;
                state.joystick.x = 0; state.joystick.y = 0;
                if(joyKnob) joyKnob.style.transform = 'translate(-50%,-50%)';
                break;
            }
        }
    };
    joyBase.addEventListener('touchend', endJoy, {passive: false});
    joyBase.addEventListener('touchcancel', endJoy, {passive: false});
}

if(abBtn){
    abBtn.addEventListener('touchstart', e => { e.preventDefault(); triggerAbility(); }, {passive: false});
    abBtn.addEventListener('click', () => triggerAbility());
}
if(abBtn2){
    abBtn2.addEventListener('touchstart', e => {
        e.preventDefault();
        if(state.mindControl.active) killMindControlHost();
        else triggerSecondary();
    }, {passive: false});
    abBtn2.addEventListener('click', () => {
        if(state.mindControl.active) killMindControlHost();
        else triggerSecondary();
    });
}

function handleJoy(t){
    if(!joyBase||!joyKnob) return;
    const r=joyBase.getBoundingClientRect();
    const c={x:r.left+r.width/2, y:r.top+r.height/2};
    let dx=t.clientX-c.x, dy=t.clientY-c.y;
    const d=Math.sqrt(dx*dx+dy*dy), max=50;
    if(d>max){dx*=max/d; dy*=max/d;}
    joyKnob.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
    state.joystick.x=dx/max;
    state.joystick.y=dy/max;
}

// Pause when tab goes hidden
document.addEventListener('visibilitychange', () => {
    if(document.hidden && state.screen === 'PLAYING' && settings.autoPauseOnHide){
        state.screen = 'PAUSED';
        document.getElementById('pauseMenu').classList.remove('hidden');
    }
});

// Konami code removed

window.onload=()=>{
    initMenu();
    checkOrientation();
    lastTimestamp = 0;
    requestAnimationFrame(mainLoop);
};
</script>
</body>
</html>